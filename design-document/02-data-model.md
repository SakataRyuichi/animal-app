# 2. データモデル設計

**📚 インデックス**: [DESIGN_DOCUMENT_INDEX.md](../DESIGN_DOCUMENT_INDEX.md)

データモデル設計

### 2.1 エンティティ一覧

#### 2.1.1 Users（ユーザー）
**目的**: アプリを利用するユーザー（個人/事業者）の情報を管理

**主要フィールド**:
- `tokenIdentifier`: 認証ID（Clerk）
- `name`: ユーザー名
- `email`: メールアドレス
- `type`: ユーザータイプ（個人/事業者）
- `subscription`: サブスクリプション情報（プレミアム機能の制御）✅ **機能制限とUXをシームレスに繋ぐ設計**
  - `tier`: プラン（free/premium、将来的にfamilyなども追加可能）
  - `status`: サブスクリプションの状態（active/canceled/past_due/trialing）
  - `endsAt`: サブスクリプションの期限
  - `gracePeriodEndsAt`: 猶予期間の期限（支払い失敗後も機能を維持する期間）
  - `revenueCatUserId`: RevenueCatのユーザーID
- `location`: 地域情報（検索用）
- `businessInfo`: 事業者情報（事業者の場合）

**インデックス**:
- `by_token`: 認証IDでの検索

**ユースケース**:
- ユーザー登録・ログイン
- プロフィール管理
- プレミアム機能の有効化
- サブスクリプション管理（購入、更新、キャンセル）
- 猶予期間の管理
- 事業者アカウントの管理

---

#### 2.1.2 Pets（ペット）
**目的**: ペットの基本情報とプロフィールを管理

**主要フィールド**:
- `ownerId`: 所有者（主管理者）
- `name`: ペット名
- `species`: 種別（犬、猫、爬虫類など）
- `breed`: 品種（ハスキー、レオパなど）
- `gender`: 性別
- `birthDate`: 誕生日（Unixタイムスタンプ）✅ **年齢自動算出機能**
- `photoUrl`: プロフィール画像
- `weight`: 最新体重
- `isNeutered`: 去勢/避妊済みフラグ
- `origin`: 出自（ショップ、ブリーダー、里親など）
- `insurance`: 保険情報
- `bio`: 自己紹介
- `personality`: 性格タグ
- `visibility`: 公開設定（private/shared/public）
- `deletion`: 削除状態（論理削除）✅ **Convexのドキュメント指向な特性を最大限に活用**

**年齢計算機能**:
- `birthDate`から実年齢と人間換算年齢を自動算出
- 種別に応じた適切な換算式を適用（`packages/utils/src/petAge.ts`）
- モバイルアプリと管理画面で計算結果がズレることを防ぐため、ロジックを`packages/utils`に集約

**バースデー・記念日機能**:
- 誕生日の判定とバースデー演出（`packages/utils/src/petCelebrations.ts`）
- 成長の節目通知（1ヶ月、3ヶ月、6ヶ月、1年、2年など）
- 記念日の記録を自動で日記として保存

**アルバム管理機能**:
- `albums`テーブル: アルバム自体を管理
- `album_items`テーブル: アルバムとコンテンツ（活動ログ・画像）を紐付ける中間テーブル
- **設計思想**: 日記や写真をテーマ別（例：「初めてのお散歩」「通院記録」「5歳の誕生日」）に整理することで、ユーザーの愛着が深まる
- **機能制限**:
  - 無料ユーザー: 最大2つまで作成可能、1アルバム20枚まで
  - プレミアムユーザー: 無制限、共同編集可能、共有・送信機能利用可能
- **UX設計**: 日記詳細画面から簡単にアルバムに追加できる「＋」アイコン、複数選択で一括追加可能な「整理モード」

**メモリアル機能（虹の橋を渡った場合）**:
- `memorialStatus`オブジェクトでメモリアルステータスを管理
- **設計思想**: 「記録の封印」ではなく「思い出の保護」という観点で設計
- 命日（`deceasedDate`）が設定されている場合、その日で年齢計算を停止
- 記録を「入力」するボタンが消え、代わりにこれまでの思い出を「振り返る」ボタンに変わる
- ペットのアイコンに、優しく光る輪や淡い背景色を添える
- 年齢表示は命日で固定される（例：「14歳5ヶ月でお空へ」）
- プレミアム限定で、思い出のアルバム作成・エクスポート機能を提供（PDF、ZIP、SNS共有）

**インデックス**:
- `by_owner`: 所有者での検索
- `by_owner_active`: 所有者・削除状態での検索（アクティブなペットのみ取得）
- `by_species_breed`: 種別・品種での検索
- `search_bio`: 全文検索（自己紹介）

**ユースケース**:
- ペット登録
- プロフィール編集
- ペット一覧表示
- 種別・品種での検索
- 公開設定の変更
- ペット削除（論理削除、30日間復元可能）
- ペット復元

---

#### 2.1.3 Pet Members（共同管理者）
**目的**: Phase 2で実装。1匹のペットを複数人で管理するためのリンクテーブル

**主要フィールド**:
- `petId`: ペットID
- `userId`: ユーザーID
- `role`: 権限（admin/editor/viewer）

**インデックス**:
- `by_pet`: ペットでの検索
- `by_user`: ユーザーでの検索

**ユースケース**:
- 家族メンバーの追加
- 権限の設定・変更
- 共同管理者一覧の表示
- 自分が管理できるペット一覧の取得

---

#### 2.1.4 Activities（活動ログ）
**目的**: ペットの日常活動を一元管理（食事、トイレ、散歩、日記、ケアなど）

**主要フィールド**:
- `petId`: ペットID
- `createdBy`: 記録者
- `loggedAt`: 記録日時（過去の日付登録も可能）
- `type`: ログタイプ（food/toilet/walk/health/diary/care）
- `payload`: 実際のデータ（柔軟な構造）
  - `imageIds`: 画像IDの配列（`images`テーブルへの参照）✅ **Convexのプライシングを考慮した設計**
  - `text`: メモ・日記本文
  - `foodId`: 商品ID（食事ログ）
  - `amount`: 量（食事ログ）
  - `toiletType`: トイレタイプ（pee/poo）
  - `condition`: 状態（hard/soft/diarrhea）
  - `durationMin`: 時間（散歩ログ）
  - `distanceKm`: 距離（散歩ログ）
  - `careType`: ケアタイプ（nail/shampoo/vaccine）
- `isPublic`: 公開フラグ（Phase 3）
- `likeCount`: いいね数（Phase 3）
- `deletion`: 削除状態（論理削除）✅ **Convexのドキュメント指向な特性を最大限に活用**

**インデックス**:
- `by_pet_date`: ペット・日時での検索（タイムライン表示用）
- `by_pet_active`: ペット・削除状態での検索（アクティブなログのみ取得）
- `by_public_feed`: 公開フィード用（Phase 3）

**ユースケース**:
- 食事記録
- トイレ記録
- 散歩記録
- 日記投稿
- ケア記録
- タイムライン表示
- グローバルフィード表示（Phase 3）
- 活動ログ削除（論理削除、30日間復元可能）
- 活動ログ復元

---

#### 2.1.5 Images（画像管理）✅ **Convexのプライシングを考慮した設計**

**目的**: 画像を一元管理し、プレミアム機能としての最高画質保存と画像編集機能を実現

**主要フィールド**:
- `previewStorageId`: 表示用WebP（無料ユーザーも参照可能、500KB程度）
- `originalStorageId`: 最高画質WebP（プレミアムユーザーのみ参照可能、数MB以上）
- `editMetadata`: 編集データ（プレミアムのみ：スタンプの位置や文字の内容）
- `hasEdits`: 編集されているかどうか
- `isPremiumAtUpload`: アップロード時のユーザー状態（プレミアムかどうか）

**インデックス**:
- `by_user`: ユーザーでの検索
- `by_pet`: ペットでの検索
- `by_activity`: 活動ログでの検索
- `by_user_active`: ユーザー・削除状態での検索（アクティブな画像のみ取得）

**画像保存戦略**:
- **無料ユーザー**: 累計50枚まで（約25MB）、表示用WebPのみ
- **プレミアムユーザー**: 無制限、最高画質WebPも保存・表示可能
- **編集機能**: 無料ユーザーは編集後の画像のみ保存、プレミアムユーザーは編集前・編集後の両方を保存（非破壊編集）

**詳細**: `IMAGE_STORAGE_STRATEGY.md`を参照してください。

---

#### 2.1.5 Products（商品データベース）
**目的**: Phase 3で実装。ペット用品のマスタデータ

**主要フィールド**:
- `name`: 商品名
- `category`: カテゴリ（food/toy/cageなど）
- `brand`: ブランド名
- `isVerified`: 運営確認済みフラグ
- `submittedBy`: 登録者
- `affiliateLink`: アフィリエイトURL
- `imageUrl`: 商品画像
- `averageRating`: 平均評価
- `reviewCount`: レビュー数

**インデックス**:
- `search_name`: 商品名での全文検索

**ユースケース**:
- 商品登録（ユーザー投稿）
- 商品検索
- 商品詳細表示
- 運営による商品承認
- アフィリエイトリンクの付与

---

#### 2.1.6 Reviews（商品レビュー）
**目的**: Phase 3で実装。商品に対するレビュー・評価

**主要フィールド**:
- `userId`: レビュアー
- `petId`: 使用したペット
- `productId`: 商品ID
- `rating`: 評価（1-5）
- `comment`: コメント
- `petSpecies`: ペット種別（集計用）
- `petBreed`: ペット品種（集計用）

**インデックス**:
- `by_product`: 商品での検索
- `by_species_product`: 種別・商品での検索（「猫に人気のフード」など）

**ユースケース**:
- レビュー投稿
- レビュー一覧表示
- 種別ごとの商品人気ランキング
- レビュー統計の集計

---

#### 2.1.7 Chat Threads（AIチャットスレッド）
**目的**: Phase 1後半 / Phase 2で実装。AI相談の会話スレッドを管理

**主要フィールド**:
- `userId`: ユーザーID
- `petId`: 相談対象のペットID
- `title`: スレッドタイトル（自動生成）
- `createdAt`: 作成日時

**インデックス**:
- `by_user_pet`: ユーザー・ペットでの検索（スレッド一覧）

**ユースケース**:
- チャットスレッド作成
- スレッド一覧表示
- スレッド削除

---

#### 2.1.8 Chat Messages（AIチャットメッセージ）
**目的**: Phase 1後半 / Phase 2で実装。AI相談のメッセージ履歴を管理

**主要フィールド**:
- `threadId`: スレッドID
- `role`: メッセージの役割（user/assistant）
- `content`: メッセージ内容
- `citedSources`: 引用した知識ベースのID配列

**インデックス**:
- `by_thread`: スレッドでの検索（メッセージ一覧）

**ユースケース**:
- メッセージ送信
- メッセージ履歴表示
- 引用元の表示

---

#### 2.1.9 Knowledge Base（知識ベース）
**目的**: Phase 1後半 / Phase 2で実装。RAG用の信頼できる知識データ

**主要フィールド**:
- `title`: 記事タイトル
- `content`: 記事本文
- `sourceUrl`: 情報元のURL（信頼性の担保）
- `category`: カテゴリ（Emergency/Food/Illnessなど）
- `embedding`: ベクトル埋め込み（1536次元）

**インデックス**:
- `by_embedding`: ベクトル検索インデックス（類似度検索用）

**ユースケース**:
- 知識データの投入（運営）
- ベクトル検索による関連知識の取得
- 引用元の表示

---

#### 2.1.10 Articles（コラム・記事）
**目的**: Phase 1後半 / Phase 2で実装。管理者・専門家による信頼できるコラム・記事

**主要フィールド**:
- `authorId`: 投稿者（管理者 or 認定獣医師）
- `title`: 記事タイトル
- `content`: 本文（Markdown形式推奨）
- `thumbnailUrl`: アイキャッチ画像
- `targetSpecies`: 対象種別（配列）
- `tags`: タグ（配列）
- `sources`: 一次ソースのリンク（信頼性の担保）
- `status`: 公開状態（draft/published）
- `isExpertContent`: 専門家による執筆フラグ

**インデックス**:
- `by_status_date`: 公開状態・日時での検索（公開記事を新しい順に）
- `by_species`: 種別でのフィルタリング
- `search_content`: 全文検索

**ユースケース**:
- コラム一覧表示
- コラム詳細表示
- 種別ごとのレコメンデーション
- 管理者用投稿機能

---

#### 2.1.11 Follows（フォロー関係）
**目的**: Phase 3で実装。ユーザー間のフォロー関係を管理

**主要フィールド**:
- `followerId`: フォローする人（フォロワー）
- `followingId`: フォローされる人（フォロイー）
- `createdAt`: フォロー開始日時

**インデックス**:
- `by_follower`: フォローしている人の一覧取得
- `by_following`: フォロワー一覧取得
- `by_follower_following`: フォロー関係の確認（重複防止）

**ユースケース**:
- フォロー・フォロー解除
- フォロー中フィードの取得
- フォロワー一覧表示

---

#### 2.1.12 Likes（いいね）
**目的**: Phase 3で実装。投稿へのいいねを管理

**主要フィールド**:
- `userId`: いいねしたユーザー
- `activityId`: いいねされた投稿（activities）
- `createdAt`: いいね日時

**インデックス**:
- `by_activity`: 投稿ごとのいいね一覧（いいね数カウント）
- `by_user_activity`: ユーザーがいいねしたかどうかの確認（重複防止）
- `by_user`: ユーザーがいいねした投稿一覧

**ユースケース**:
- いいね・いいね解除
- いいね数の表示
- 人気投稿の取得

---

### 2.2 削除機能の設計思想 ✅ **Convexのドキュメント指向な特性を最大限に活用**

**設計思想**: `isDeleted`フラグではなく、削除に関するコンテキストをまとめた`deletion`オブジェクトを使用することで、型安全性とクエリのシンプル化を実現します。

**メリット**:
1. **型安全な条件分岐**: `if (pet.deletion)` というチェックを通るだけで、そのブロック内では削除日時や削除者に型安全にアクセスできます
2. **クエリのシンプル化**: 「オブジェクトが存在するかどうか」で判定できる
   ```typescript
   // アクティブなデータのみ取得
   const activePets = await ctx.db
     .query("pets")
     .withIndex("by_owner_active", (q) => q.eq("deletion", undefined))
     .collect();
   ```
3. **セキュリティと監査（オーディット）**: 「誰が」「いつ」消したかがデータそのものに内包されているため、後から調査するロジックが組みやすい

**実装**:
- `packages/backend/convex/lib/deletionSchema.ts`に共通スキーマ定義を配置
- `pets`、`activities`などの主要テーブルに`deletion: deletionSchema`を追加
- デフォルトで30日間復元可能（`restorableUntil`フィールドで制御）

**UI/UXの考慮**:
- 削除時に「後から元に戻せます（30日間）」というメッセージを表示
- 設定画面に「削除したペット」セクションを追加
- 「残りあと◯日で完全に消去されます」というメッセージを表示
- 復元ボタンを提供

---

### 2.3 プレミアム権限管理 ✅ **機能制限とUXをシームレスに繋ぐ設計**

**設計思想**: プレミアムユーザーの管理は、**「機能制限」**と**「UX（アップグレード案内）」**をシームレスに繋ぐために、Convexのテーブル定義とReactのガード機能を組み合わせます。

**スキーマ設計**:
- `users.subscription`オブジェクトでサブスクリプションの状態を管理
- `tier`: プラン（free/premium、将来的にfamilyなども追加可能）
- `status`: サブスクリプションの状態（active/canceled/past_due/trialing）
- `endsAt`: サブスクリプションの期限
- `gracePeriodEndsAt`: 猶予期間の期限（支払い失敗後も機能を維持する期間）

**バックエンド（Convex）でのガード**:
- `packages/backend/convex/lib/permissions.ts`に権限チェック用のヘルパー関数を実装
- `assertPremium()`: プレミアム会員であることを要求（エラーを投げる）
- `isPremiumUser()`: ユーザーがプレミアム会員かどうかを判定（エラーを投げない）
- 猶予期間（gracePeriodEndsAt）も考慮した判定

**フロントエンド（React）でのガード**:
- `packages/ui/src/components/PremiumGuard.tsx`にプレミアムガードコンポーネントを実装
- プレミアムでない場合、アップグレード案内を表示
- ハーフモーダル（Sheet）やプレースホルダーでの案内

**プレミアム限定機能の例**:
- 詳細な統計情報（US-017: 体重推移グラフ、US-072: 統計情報表示）
- 家族・チーム管理（Phase 2の共同管理機能）
- 高度なAI相談機能（詳細分析、過去の相談履歴の詳細表示）
- データエクスポート機能

**UX（アップグレード案内）の3段階**:
1. **ロックアイコンの表示**: プレミアム機能の横に小さな鍵アイコンを表示
2. **ハーフモーダル（Sheet）**: 機能をクリックした際に下から表示される案内
3. **プレースホルダー**: プレミアム限定の統計画面などは、ぼかし（Blur）をかけた背景に案内テキストを表示

**詳細**: `CONVEX_SCHEMA.md`の「実装時の注意点 > 6. プレミアム権限管理」を参照してください。

### 2.4 画像・動画保存戦略 ✅ **2026年更新 - Cloudflare R2移行・動画対応**

**設計思想**: Cloudflare R2を活用し、画像・動画を効率的に保存することで、コストを最小化しながら、プレミアム機能としての最高画質保存を実現します。

**Cloudflare R2への移行** ✅ **2026年追加**:
- **コスト削減**: 下り通信料（Egress Fee）が完全に無料のため、動画再生時のコストが大幅に削減
- **パフォーマンス向上**: Cloudflare CDNとの統合により、世界中のユーザーに高速なコンテンツ配信
- **スケーラビリティ**: 動画のような大容量ファイルも扱いやすい

**ダブルストレージ構造**（画像）:
- **表示用（Preview）**: 無料ユーザーも参照可能、WebP形式、幅1080px、Quality 0.6-0.7、約500KB
- **最高画質（Original）**: プレミアムユーザーのみ参照可能、WebP形式、リサイズなし、Quality 0.9-1.0、約数MB

**動画の保存** ✅ **2026年追加**:
- **無料ユーザー**: 1本あたり最大15秒、1ペットにつき月間3本まで、720p/HEVC（約15-20MB/分）
- **プレミアムユーザー**: 1本あたり最大60秒、無制限、1080p/HEVC（約30-40MB/分）
- **自動圧縮**: クライアント側（Expo）でアップロード前に自動で圧縮
- **サムネイル生成**: 動画の最初のフレームから自動でサムネイル画像を生成

**「温かみと誠実さ」を感じさせる設計**:
- 無料ユーザーがアップロードした画像も、**裏で最高画質データを保存**
- プレミアムにアップグレードした瞬間、過去の全ての写真が美しくなる「マジックモーメント」を実現
- 「データは消していない（温かみ）」と「今すぐは見られない（制限）」を両立

**画像枚数制限**:
- **無料ユーザー**: 累計50枚まで（約25MB）
- **プレミアムユーザー**: 無制限

**画像編集機能**:
- **無料ユーザー**: 編集後の画像のみ保存（編集前は削除）
- **プレミアムユーザー**: 編集前・編集後の両方を保存し、編集メタデータも保存（非破壊編集）

**画像ダウンロード機能**:
- **無料ユーザー**: 表示用WebP（ウォーターマーク付き）のみダウンロード可能
- **プレミアムユーザー**: 最高画質WebP（ウォーターマークなし）、編集前のオリジナル、一括ダウンロード

**動画ダウンロード機能** ✅ **2026年追加**:
- **無料ユーザー**: 不可（プレミアム案内が表示される）
- **プレミアムユーザー**: 可能（HEVC形式）

**詳細**: `IMAGE_STORAGE_STRATEGY.md`、`CLOUDFLARE_R2_MIGRATION.md`を参照してください。

---
