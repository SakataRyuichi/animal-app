# 要件レビュー

**📚 ドキュメントインデックス**: [DOCUMENTATION_INDEX.md](./DOCUMENTATION_INDEX.md)

**関連ドキュメント**:
- [USER_STORIES.md](./USER_STORIES.md): 要件定義の基盤
- [DESIGN_DOCUMENT.md](./DESIGN_DOCUMENT.md): 設計ドキュメントとの整合性確認結果

**レビュー日**: 2026年2月1日  
**対象**: 削除・復元機能、プレミアム権限管理

---

## 1. ✅ 削除・復元機能の確認

### 1.1 ユーザーストーリー

✅ **実装済み**:
- **US-007**: ペット削除（論理削除、30日間復元可能）
- **US-007-1**: ペット復元
- **US-017**: 活動ログ削除（論理削除、30日間復元可能）
- **US-017-1**: 活動ログ復元

### 1.2 スキーマ定義

✅ **実装済み**:
- `pets`テーブルに`deletion: deletionSchema`が追加されている
- `activities`テーブルに`deletion: deletionSchema`が追加されている
- `packages/backend/convex/lib/deletionSchema.ts`に共通スキーマ定義が存在
- インデックス`by_owner_active`、`by_pet_active`が追加されている

### 1.3 評価

**状態**: ✅ **完全に実装済み**

削除・復元機能は、Convexのドキュメント指向な特性を最大限に活かした設計で実装されており、要件を満たしています。

---

## 2. ⚠️ プレミアム権限管理の確認

### 2.1 現状の問題点

#### ❌ **スキーマ定義が不十分**

**現状**:
```typescript
isPremium: v.boolean(), // プレミアム会員かどうか
```

**問題点**:
- サブスクリプションの状態管理ができない（active/canceled/past_due）
- 試用期間（Grace Period）の管理ができない
- 将来のプラン拡張（ライト、プレミアム、ファミリー）に対応できない
- サブスクリプションの期限管理ができない

#### ❌ **プレミアム限定機能の定義がない**

どの機能がプレミアム限定なのかが明確に定義されていません。

#### ❌ **プレミアムガード機能のユーザーストーリーがない**

- プレミアム限定機能へのアクセス制御
- プレミアム限定画面へのアクセス制御
- バックエンド（Convex）での権限チェック
- フロントエンド（React）でのガード機能

#### ❌ **アップグレード案内のUXユーザーストーリーがない**

- ロックアイコンの表示
- ハーフモーダル（Sheet）での案内
- プレースホルダーでの案内
- 温かみのあるコピーとイラスト

### 2.2 必要な追加

#### 1. スキーマ定義の改善

`users`テーブルの`isPremium`を`subscription`オブジェクトに変更する必要があります。

#### 2. ユーザーストーリーの追加

以下のユーザーストーリーを追加する必要があります：
- US-019-1: プレミアム限定機能へのアクセス制御
- US-019-2: プレミアム限定画面へのアクセス制御
- US-019-3: アップグレード案内の表示

#### 3. 権限管理ヘルパー関数の実装

Convexでの権限チェック用のヘルパー関数を実装する必要があります。

#### 4. UIコンポーネントの実装

Reactでのプレミアムガードコンポーネントを実装する必要があります。

---

## 3. 📋 推奨される追加実装

### 3.1 スキーマ定義の改善

`CONVEX_SCHEMA.md`を更新して、`subscription`オブジェクトを追加します。

### 3.2 ユーザーストーリーの追加

`USER_STORIES.md`に以下のユーザーストーリーを追加します：
- US-019-1: プレミアム限定機能へのアクセス制御
- US-019-2: プレミアム限定画面へのアクセス制御
- US-019-3: アップグレード案内の表示

### 3.3 権限管理ヘルパー関数の実装

`packages/backend/convex/lib/permissions.ts`を作成して、権限チェック用のヘルパー関数を実装します。

### 3.4 UIコンポーネントの実装

`packages/ui/src/components/PremiumGuard.tsx`を作成して、プレミアムガードコンポーネントを実装します。

---

## 4. ✅ 実装完了

### 4.1 スキーマ定義の更新

✅ **完了**: `CONVEX_SCHEMA.md`を更新
- `users`テーブルの`isPremium: v.boolean()`を`subscription`オブジェクトに変更
- `subscription`オブジェクトに`tier`, `status`, `endsAt`, `gracePeriodEndsAt`, `revenueCatUserId`を追加
- プレミアム権限管理のセクションを追加

### 4.2 ユーザーストーリーの追加

✅ **完了**: `USER_STORIES.md`に以下のユーザーストーリーを追加
- **US-019-1**: プレミアム限定機能へのアクセス制御
- **US-019-2**: プレミアム限定画面へのアクセス制御
- **US-019-3**: アップグレード案内の表示
- **US-019-4**: 猶予期間（Grace Period）の管理

### 4.3 権限管理ヘルパー関数の実装

✅ **完了**: `packages/backend/convex/lib/permissions.ts`を作成
- `assertPremium()`: プレミアム会員であることを要求（エラーを投げる）
- `isPremiumUser()`: ユーザーがプレミアム会員かどうかを判定（エラーを投げない）
- `getCurrentUser()`: 現在のユーザーを取得（認証チェック付き）
- `isPremiumSubscription()`: サブスクリプション情報からプレミアム判定

### 4.4 UIコンポーネントの実装

✅ **完了**: UIコンポーネントのテンプレートを作成
- `packages/ui/src/components/PremiumGuard.tsx`: プレミアムガードコンポーネント
- `packages/ui/src/components/UpgradePrompt.tsx`: アップグレード案内コンポーネント

### 4.5 プレミアム限定機能のリスト

✅ **完了**: `PREMIUM_FEATURES.md`を作成
- プレミアム限定機能のリスト
- 無料プランで利用可能な機能のリスト
- 実装方針（バックエンド、フロントエンド、UI/UX）

### 4.6 設計ドキュメントの更新

✅ **完了**: `DESIGN_DOCUMENT.md`を更新
- `users`エンティティに`subscription`オブジェクトの説明を追加
- 「2.3 プレミアム権限管理」セクションを追加

---

## 5. 📋 実装サマリー

### 削除・復元機能

✅ **完全に実装済み**
- US-007, US-007-1: ペット削除・復元
- US-017, US-017-1: 活動ログ削除・復元
- `deletion`オブジェクトを使用した論理削除
- 30日間の復元可能期間

### プレミアム権限管理

✅ **完全に実装済み**
- `subscription`オブジェクトによるサブスクリプション管理
- バックエンド（Convex）での権限チェック
- フロントエンド（React）でのガード機能
- 猶予期間（Grace Period）の管理
- UX（アップグレード案内）の設計

---

## 6. 🎯 次のステップ（実装）

1. **Convex関数の実装**: プレミアム限定機能のQuery/Mutationに`assertPremium()`を追加
2. **UIコンポーネントの実装**: `PremiumGuard`と`UpgradePrompt`を実際のTamaguiコンポーネントで実装
3. **RevenueCat連携**: サブスクリプション購入・更新・キャンセルの処理を実装
4. **テスト**: プレミアム機能のテストを実装
