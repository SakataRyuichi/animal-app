# Epic 7: AI相談機能

**📚 インデックス**: [USER_STORIES_INDEX.md](../USER_STORIES_INDEX.md)

## AI相談機能

#### US-020: AI相談の開始
**画面パス**: `app/ai-chat/index.tsx`
**As a** ペットの健康について不安や疑問を感じている飼い主  
**I want to** 24時間いつでもAIにペットの健康について相談する  
**So that** 夜中や休日でも、すぐに信頼できる情報に基づいたアドバイスを受けられ、不安を解消できる。また、緊急時ではない軽微な疑問を気軽に相談でき、過度な心配を減らせる

**受け入れ基準**:
- チャット画面が直感的で、自然な会話のように質問を入力できる
- 相談したいペットを簡単に選択でき、複数飼いの場合も迷わない
- 初回利用時に免責事項が分かりやすく表示され、安心して利用できる ✅ **AI自身がウェルカムメッセージで免責事項を伝える**
- チャット画面のフッターに常駐免責事項が表示される ✅ **控えめなサイズで常時表示**
- チャットスレッドが自動的に作成され、過去の相談履歴を振り返れる
- 「よくある質問」や「相談例」が表示され、何を聞けばいいか分からない時も参考になる
- 相談開始時に「ペットの記録を活用して、より詳しいアドバイスを提供します」という説明が表示される
- 入力中に専門的なキーワードを検出した場合、リアルタイムで警告が表示される ✅ **動的な警告表示**

**体験価値**:
- **安心感**: 24時間いつでも相談でき、不安をすぐに解消できる
- **気軽さ**: 病院に行くほどでもない疑問を気軽に相談でき、過度な心配を減らせる
- **信頼性**: ペットの記録と信頼できる知識ベースに基づいたアドバイスで、適切な判断ができる

**使用シーン**:
- 夜中にペットの様子がおかしく、不安で眠れない時
- 新しいフードに切り替えたが、体調に影響があるか心配な時
- ペットの行動がいつもと違うが、病院に行くべきか判断に迷う時

**優先度**: 最高

---

---

#### US-021: ペットのカルテ情報を活用した相談
**画面パス**: `app/ai-chat/[threadId].tsx`
**As a** 日々の記録を続けている飼い主  
**I want to** ペットの記録情報を自動的に活用してAIに相談する  
**So that** 一般的なアドバイスではなく、自分のペットの年齢・体重・過去の記録を考慮した個別化されたアドバイスを受けられ、より実用的で適切な判断ができる

**受け入れ基準**:
- ペットのプロフィール情報（年齢、体重、種別、品種など）が自動的に考慮され、手動で入力する必要がない
- 直近の活動ログ（食事量、トイレの状態、散歩時間など）が自動的に分析され、AIの判断材料になる
- AIの回答にペットの情報が自然に反映され、「ポチくん（14歳、高齢犬）の記録を見ると、昨日から食事量が半分に減っていますね」のように個別化された回答が返る
- 過去の記録との比較が自動的に行われ、「いつもより食欲が落ちている」「トイレの頻度が増えている」などの変化が指摘される
- 記録が少ない場合は、「より詳しいアドバイスのために、食事記録を続けてください」という提案が表示される

**体験価値**:
- **個別化**: 自分のペットに特化したアドバイスで、実用的で適切な判断ができる
- **記録の価値**: 日々の記録が実際の相談に活用され、記録を続ける動機になる
- **正確性**: 記憶に頼らず、記録に基づいた正確な情報を提供できる

**使用シーン**:
- 「最近食欲がない」と相談した時、過去の食事記録と比較して具体的なアドバイスを受ける
- 高齢ペットの健康相談で、年齢と体重を考慮したアドバイスを受ける
- 新しいフードに切り替えた後の相談で、切り替え前後の記録を比較したアドバイスを受ける

**優先度**: 最高

---

---

#### US-022: 信頼できる知識ベースからの回答
**画面パス**: `app/ai-chat/[threadId].tsx`
**As a** SNSの不確かな情報に不安を感じている飼い主  
**I want to** 信頼できる情報源に基づいた回答を受け取る  
**So that** 科学的根拠に基づいた正確で安全なアドバイスを得られ、誤った判断を避けられる。また、回答の根拠が明確なので、安心して行動できる

**受け入れ基準**:
- 回答に引用元が明確に表示され、「この回答は以下の情報源に基づいています」と明記される
- 引用元のURLをタップで確認でき、一次ソースを直接確認できる
- 獣医師監修のガイドラインが優先され、信頼性の高い情報が使われる
- 不正確な情報が含まれないよう、AIが知識ベースから適切な情報を選択する
- 引用元の信頼性がバッジで表示され（例：「厚生労働省ガイドライン」「獣医師監修」）、一目で信頼性が分かる
- 回答に不確実な部分がある場合は、「この情報は一般的なガイドラインであり、個別の状況によって異なる場合があります」と明記される
- 回答の内容に応じて、適切な免責事項が自動的に表示される ✅ **medical/food/emergency/generalの4種類**
- 医療的な内容の回答には、「この判断は専門家（獣医師）にご相談ください」という一文が含まれる ✅ **システムプロンプトで制御**

**体験価値**:
- **信頼性**: SNSの不確かな情報ではなく、科学的根拠に基づいた正確な情報を得られる安心感
- **安全性**: 誤った判断を避けられ、ペットの健康を守れる
- **透明性**: 回答の根拠が明確で、なぜそのアドバイスなのかが理解できる

**使用シーン**:
- 「このフードは安全ですか？」と相談した時、厚生労働省のガイドラインに基づいた回答を受ける
- 「この症状は大丈夫ですか？」と相談した時、獣医師監修のガイドラインを引用した回答を受ける
- SNSで見た情報が正しいか確認したい時、信頼できる情報源に基づいた回答を受ける

**優先度**: 最高

---

---

#### US-023: 緊急度の判定と病院案内
**画面パス**: `app/ai-chat/[threadId].tsx`
**As a** ペットの緊急事態に直面している飼い主  
**I want to** AIが緊急度を判定し、適切な病院を案内してくれる  
**So that** パニック状態でも適切な判断ができ、最適なタイミングで最寄りの病院に連れて行ける。これにより、ペットの命を守る行動を迅速に取れる

**受け入れ基準**:
- 緊急度が高い場合、画面が警告色（赤）に変わり、視覚的に緊急性が伝わる
- 「今すぐ病院へ！」という明確なメッセージと共に、現在地周辺の救急対応可能な動物病院マップが自動的に表示される
- Google Maps APIで病院の詳細情報（営業時間、診療科目、距離、評価）が表示され、最適な病院を選べる
- 電話番号をワンタップで発信でき、すぐに連絡を取れる
- 現在地から病院までのルートが表示され、ナビゲーションにすぐ移行できる
- 緊急度の判定理由が表示され（例：「チョコレート誤飲は3kgの小型犬にとって致命的な可能性があります」）、なぜ緊急なのかが理解できる
- 緊急時ではない場合も、「24時間以内に受診を推奨します」などの適切なアドバイスが表示される

**体験価値**:
- **命を守る**: 緊急時に適切な判断と行動を迅速に取れ、ペットの命を守れる
- **安心感**: パニック状態でも、アプリが適切な病院を案内してくれ、迷わない
- **効率性**: 最寄りの適切な病院を素早く見つけられ、時間を無駄にしない

**使用シーン**:
- ペットが誤飲した時、緊急度を判定して病院を案内される
- ペットが急に倒れた時、救急対応可能な病院をすぐに見つける
- 夜中にペットの様子がおかしい時、24時間対応の病院を探す

**優先度**: 最高

---

---

#### US-024: チャット履歴の表示
**画面パス**: `app/ai-chat/[threadId].tsx`
**As a** ペット飼い主  
**I want to** 過去の相談履歴を見る  
**So that** 以前のアドバイスを振り返れる

**受け入れ基準**:
- チャットスレッド一覧が表示される
- スレッドタイトルが自動生成される
- 過去のメッセージ履歴が表示される
- 引用元も履歴に含まれる

**優先度**: 高

---

---

#### US-025: 推奨アクションの表示
**画面パス**: `app/ai-chat/[threadId].tsx`
**As a** ペット飼い主  
**I want to** AIから推奨されるアクションを見る  
**So that** 次に何をすべきか分かる

**受け入れ基準**:
- 「様子を見る」「病院を受診する」などの推奨アクションが表示される
- アクションがリッチなカードとして表示される
- アクションをタップで詳細を確認できる

**優先度**: 高

---

---

