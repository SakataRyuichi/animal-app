# Epic 12: 画像・動画管理機能

**📚 インデックス**: [USER_STORIES_INDEX.md](../USER_STORIES_INDEX.md)

## 画像管理機能

#### US-051: 画像の最高画質表示
**As a** プレミアム会員  
**I want to** アップロードした画像を最高画質で表示する  
**So that** 思い出の写真を美しく保存・表示できる

**受け入れ基準**:
- プレミアムユーザーは、すべての画像を最高画質（数MB）で表示できる
- 無料ユーザー時代にアップロードした画像も、プレミアムにアップグレードした瞬間に最高画質で表示される
- 画像を拡大しても、細部までくっきり見える
- 画像の隅に「Ultra HD」ラベルが表示される

**体験価値**:
- **マジックモーメント**: プレミアムにアップグレードした瞬間、過去の全ての写真が美しくなる感動体験
- **思い出の保護**: 最高画質で保存することで、将来の拡大表示や印刷にも対応できる

**使用シーン**:
- プレミアムにアップグレードした時、過去の写真が美しくなる瞬間
- 写真を拡大して細部を確認したい時

**優先度**: 高

---

---

#### US-052: 画像ダウンロード
**画面パス**: `app/timeline/[id].tsx`, `app/albums/[id].tsx`（画像ビューア）
**As a** プレミアム会員  
**I want to** アップロードした画像を最高画質でダウンロードする  
**So that** 思い出の写真をデバイスに保存できる

**受け入れ基準**:
- プレミアムユーザーは、画像を最高画質（ウォーターマークなし）でダウンロードできる
- 編集前の「素」の状態のオリジナルデータもダウンロード可能
- 一括ダウンロード機能（1ヶ月分をまとめて保存など）が利用できる
- 無料ユーザーは、表示用WebP（ウォーターマーク付き）のみダウンロード可能

**体験価値**:
- **思い出の保存**: 大切な写真をデバイスに保存できる安心感
- **データの所有**: 自分のデータを自由に持ち出せる

**優先度**: 高

---

---

#### US-053: 画像編集（スタンプ・文字入れ）
**画面パス**: `app/timeline/[id].tsx`, `app/albums/[id].tsx`（画像編集モーダル）
**As a** ペット飼い主  
**I want to** 写真にスタンプや文字を追加する  
**So that** 思い出の写真を楽しく装飾できる

**受け入れ基準**:
- 写真を選択して編集画面を開ける
- スタンプを追加できる（ペットの種類に合わせたスタンプ）
- 文字を追加できる（フォント、色、サイズを選択可能）
- 編集後の画像を保存できる
- **無料ユーザー**: 編集後の画像のみ保存（編集前は削除）
- **プレミアムユーザー**: 編集前・編集後の両方を保存し、後から編集をやり直せる（非破壊編集）

**体験価値**:
- **楽しさ**: Instagramのような編集機能で、思い出の写真を楽しく装飾できる
- **思い出の保護**: プレミアムユーザーは、編集前の「素」の状態も保存される

**使用シーン**:
- ペットの誕生日の写真に「お誕生日おめでとう」と文字を追加
- 可愛い写真にスタンプを追加してSNSに投稿

**優先度**: 中

---

---

#### US-054: 画像枚数制限の案内
**画面パス**: `app/pets/[id]/activities/[type].tsx`（画像アップロード時）
**As a** 無料ユーザー  
**I want to** 画像のアップロード制限について理解する  
**So that** プレミアム機能の価値を理解し、アップグレードを検討できる

**受け入れ基準**:
- 累計50枚を超えると、「古い写真からぼかし（Blur）がかかり、プレミアムになると復元できる」という案内が表示される
- 「データは消していない（温かみ）」と「今すぐは見られない（制限）」を両立した案内
- プレミアムにアップグレードすると、過去の全ての写真が美しくなることを説明
- 画像を拡大した際、「プレミアムなら Ultra HD で表示・ダウンロードできます」という案内を出す

**体験価値**:
- **温かみ**: データを消さずに保存していることを伝える
- **価値の理解**: プレミアム機能の価値を理解できる

**優先度**: 中

---

### 動画管理機能（Phase 1）✅ **2026年追加 - Cloudflare R2移行**

---

#### US-092: 動画のアップロード
**画面パス**: `app/pets/[id]/activities/[type].tsx`（動画選択時）  
**As a** ペット飼い主  
**I want to** ペットの動画をアップロードできる  
**So that** ペットの動きや表情を記録できる

**受け入れ基準**:
- **動画選択**: カメラロールから動画を選択できる、またはカメラで動画を撮影できる
- **自動圧縮**: アップロード時に自動で圧縮される（HEVC形式、720p/30fps）
  - 無料ユーザー: 最大15秒、720p/HEVC（約15-20MB/分）
  - プレミアムユーザー: 最大60秒、1080p/HEVC（約30-40MB/分）
- **サムネイル生成**: 動画の最初のフレームから自動でサムネイル画像が生成される
- **アップロード進捗**: アップロードの進捗が表示される
- **エラーハンドリング**: アップロード失敗時は再試行できる

**体験価値**:
- **思い出の記録**: ペットの動きや表情を動画で記録できる
- **自動圧縮**: ユーザーが意識せずに最適なサイズで保存される

**使用シーン**:
- ペットが遊んでいる様子を動画で記録したい時
- ペットの可愛い仕草を動画で残したい時

**優先度**: 高

---

---

#### US-093: 動画の再生
**画面パス**: `app/timeline/[id].tsx`, `app/albums/[id].tsx`（動画ビューア）  
**As a** ペット飼い主  
**I want to** アップロードした動画を再生できる  
**So that** ペットの動きや表情を振り返れる

**受け入れ基準**:
- **動画再生**: 動画をタップすると再生される
- **再生コントロール**: 再生・一時停止・シークバーが操作できる
- **全画面再生**: 全画面モードで再生できる
- **サムネイル表示**: 動画のサムネイルが表示される
- **読み込み状態**: 動画の読み込み中はローディング表示される
- **オフライン対応**: オフライン時はキャッシュされた動画を再生できる（オプション）

**体験価値**:
- **振り返り**: ペットの動きや表情を動画で振り返れる
- **スムーズな再生**: Cloudflare CDNにより高速な動画配信

**使用シーン**:
- タイムラインで動画を再生したい時
- アルバムで動画を再生したい時

**優先度**: 高

---

---

#### US-094: 動画の制限と案内
**画面パス**: `app/pets/[id]/activities/[type].tsx`（動画アップロード時）  
**As a** 無料ユーザー  
**I want to** 動画のアップロード制限について理解する  
**So that** プレミアム機能の価値を理解し、アップグレードを検討できる

**受け入れ基準**:
- **動画の長さ制限**: 無料ユーザーは1本あたり最大15秒まで
- **動画の本数制限**: 無料ユーザーは1ペットにつき月間3本まで
- **制限到達時の案内**: 制限に達した場合、「プレミアムなら60秒まで、無制限にアップロードできます」という案内が表示される
- **プレミアム機能の説明**: プレミアム機能の価値を分かりやすく説明

**体験価値**:
- **価値の理解**: プレミアム機能の価値を理解できる
- **選択の自由**: 無料でも動画を楽しめるが、プレミアムでより楽しめる

**使用シーン**:
- 動画のアップロード制限に達した時
- プレミアム機能について知りたい時

**優先度**: 中

---

---

#### US-095: 動画のダウンロード
**画面パス**: `app/timeline/[id].tsx`, `app/albums/[id].tsx`（動画ビューア）  
**As a** プレミアム会員  
**I want to** アップロードした動画をダウンロードできる  
**So that** 思い出の動画をデバイスに保存できる

**受け入れ基準**:
- **動画ダウンロード**: プレミアムユーザーは動画をダウンロードできる
- **ダウンロード形式**: アップロード時の形式（HEVC）でダウンロードされる
- **ダウンロード進捗**: ダウンロードの進捗が表示される
- **無料ユーザー**: 無料ユーザーはダウンロードできない（プレミアム案内が表示される）

**体験価値**:
- **思い出の保存**: 大切な動画をデバイスに保存できる安心感
- **データの所有**: 自分のデータを自由に持ち出せる

**使用シーン**:
- 動画をデバイスに保存したい時
- 動画を他のアプリで編集したい時

**優先度**: 中

---

---

#### US-065: オフライン画像アップロード（キュー管理と再試行）✅ **2026年最終設計検証で追加**
**画面パス**: `app/pets/[id]/activities/[type].tsx`（バックエンド処理）
**As a** ペット飼い主  
**I want to** 電波の悪い場所でも写真を撮って、後で自動的にアップロードされる  
**So that** 散歩中やドッグランで撮った写真を失うことなく記録できる

**受け入れ基準**:
- 画像を撮影すると、アップロードキューに追加される
- 通信が切れている場合でも、画像はローカルに保存され、キューに追加される
- 通信が復旧すると、自動的にアップロードが再開される
- UIで「アップロード中...」と表示され、アップロードの進捗が分かる
- アップロードに失敗した場合、最大3回まで自動的に再試行される
- 再試行に失敗した場合、「アップロードに失敗しました。再試行しますか？」というメッセージが表示される

**体験価値**:
- **安心感**: 電波の悪い場所でも写真を撮れる安心感
- **自動化**: 手動で再試行する必要がなく、自動的にアップロードされる

**使用シーン**:
- 散歩中に写真を撮った時
- ドッグランで写真を撮った時
- 電波の悪い場所で写真を撮った時

**優先度**: 中

---

---

#### US-066: 同時編集の競合解決（楽観的ロック）✅ **2026年最終設計検証で追加**
**画面パス**: `app/timeline/[id].tsx`, `app/pets/[id]/edit.tsx`（バックエンド処理）
**As a** 家族でペットを管理している飼い主  
**I want to** 他の人が同じ記録を編集している場合、優しく知らせてもらう  
**So that** データの整合性を保ちながら、家族で協力して記録できる

**受け入れ基準**:
- お父さんとお母さんが同時に同じペットの日記を編集した際、Convexの楽観的ロックで保護される
- UI側で「他の人が更新しました。最新の内容を確認しますか？」という優しいメッセージが表示される
- 「確認する」を選択すると、最新の内容が表示される
- 「上書きする」を選択すると、自分の編集内容で上書きできる（警告メッセージ付き）

**体験価値**:
- **協力**: 家族で協力して記録できる安心感
- **温かみ**: データの競合を技術的なエラーではなく、優しいメッセージで伝える

**使用シーン**:
- 家族で同じペットの記録を同時に編集する時
- 複数の共同管理者が同じ記録を更新する時

**優先度**: 低

---

---

---

