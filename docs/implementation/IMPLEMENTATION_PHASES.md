# 実装フェーズ計画

このドキュメントは、フェーズごとの実装計画と、各フェーズでの動作検証方法を定義します。

**重要**: 各フェーズの完了時には、必ず実際の画面を通じて動作検証を行ってください。

---

## Phase 0: 環境構築とコア機能（認証・ユーザー管理）

**目標**: 開発環境を構築し、認証・ユーザー管理のコア機能を実装・検証する

**期間**: 2-3週間（推定）

### Phase 0-1: 環境構築とサービス疎通確認

**目標**: 開発環境を構築し、各種サービスへの接続を確認する

#### Epic 0-1-1: 開発環境の構築

**実装タスク**:
- [ ] **TASK-0-1-1-1**: miseのセットアップと動作確認
- [ ] **TASK-0-1-1-2**: Turborepo + pnpmワークスペースの構築
- [ ] **TASK-0-1-1-3**: Convexプロジェクトの作成と接続確認
- [ ] **TASK-0-1-1-4**: Expoプロジェクトの初期化と動作確認
- [ ] **TASK-0-1-1-5**: TypeScript設定の統一と型チェック確認

**検証項目**:
- [ ] `mise install`でNode.jsとpnpmがインストールされる
- [ ] `pnpm install`で依存関係がインストールされる
- [ ] `pnpm turbo dev`で開発環境が起動する
- [ ] Convex Dashboardでプロジェクトが作成されている
- [ ] Expo Goアプリで開発サーバーに接続できる
- [ ] `pnpm typecheck`が通る

**検証方法**: 実際にコマンドを実行し、エラーなく動作することを確認

---

#### Epic 0-1-2: 各種サービスへの疎通確認

**実装タスク**:
- [ ] **TASK-0-1-2-1**: Clerkプロジェクトの作成と設定
- [ ] **TASK-0-1-2-2**: ConvexとClerkの統合確認
- [ ] **TASK-0-1-2-3**: 環境変数の設定と動作確認
- [ ] **TASK-0-1-2-4**: Sentryの設定とエラー送信確認（オプション）
- [ ] **TASK-0-1-2-5**: Better Stackの設定とログ送信確認（オプション）

**検証項目**:
- [ ] Clerk Dashboardでプロジェクトが作成されている
- [ ] Convex関数からClerkのユーザー情報を取得できる
- [ ] 環境変数が正しく読み込まれている
- [ ] Sentryにエラーが送信される（設定した場合）
- [ ] Better Stackにログが送信される（設定した場合）

**検証方法**: 簡単なテスト関数を作成し、各サービスへの接続を確認

---

### Phase 0-2: 認証機能の実装（デザインなし）

**目標**: 認証機能のコアロジックを実装し、動作を確認する

**重要**: このフェーズではデザインは後回しにし、機能の動作確認を優先します。

#### Epic 0-2-1: ユーザー登録機能

**実装タスク**:
- [ ] **TASK-0-2-1-1**: Convexスキーマの定義（usersテーブル）
- [ ] **TASK-0-2-1-2**: Clerkのユーザー登録フロー実装
- [ ] **TASK-0-2-1-3**: Convex関数の作成（ユーザー情報の同期）
- [ ] **TASK-0-2-1-4**: 登録画面の基本実装（デザインなし）
- [ ] **TASK-0-2-1-5**: 登録後のリダイレクト処理

**検証項目**:
- [ ] メールアドレスでユーザー登録できる
- [ ] Google/Appleアカウントでユーザー登録できる
- [ ] 登録後、Convexの`users`テーブルにデータが保存される
- [ ] 登録後、適切な画面にリダイレクトされる
- [ ] エラーハンドリングが正しく動作する

**検証方法**: 実際にユーザー登録を行い、Convex Dashboardでデータを確認

---

#### Epic 0-2-2: ログイン機能

**実装タスク**:
- [ ] **TASK-0-2-2-1**: Clerkのログインフロー実装
- [ ] **TASK-0-2-2-2**: セッション管理の実装
- [ ] **TASK-0-2-2-3**: 生体認証（Face ID/Touch ID）の実装
- [ ] **TASK-0-2-2-4**: ログイン画面の基本実装（デザインなし）
- [ ] **TASK-0-2-2-5**: ログイン後のリダイレクト処理

**検証項目**:
- [ ] メールアドレスとパスワードでログインできる
- [ ] Google/Appleアカウントでログインできる
- [ ] 生体認証でログインできる（iOS/Android）
- [ ] ログイン後、セッションが維持される
- [ ] ログイン後、適切な画面にリダイレクトされる

**検証方法**: 実際にログインを行い、セッションが維持されることを確認

---

#### Epic 0-2-3: ログアウト機能

**実装タスク**:
- [ ] **TASK-0-2-3-1**: Clerkのログアウト処理実装
- [ ] **TASK-0-2-3-2**: セッションクリア処理
- [ ] **TASK-0-2-3-3**: ログアウト後のリダイレクト処理
- [ ] **TASK-0-2-3-4**: ログアウトボタンの実装（デザインなし）

**検証項目**:
- [ ] ログアウトボタンを押すとログアウトできる
- [ ] ログアウト後、セッションがクリアされる
- [ ] ログアウト後、ログイン画面にリダイレクトされる
- [ ] ログアウト後、認証が必要な画面にアクセスできない

**検証方法**: 実際にログアウトを行い、認証が必要な画面にアクセスできないことを確認

---

#### Epic 0-2-4: ユーザー退会機能

**実装タスク**:
- [ ] **TASK-0-2-4-1**: Convexスキーマの定義（account_deletion_reasonsテーブル）
- [ ] **TASK-0-2-4-2**: 退会理由の選択機能
- [ ] **TASK-0-2-4-3**: Convex関数の作成（ユーザー退会処理）
- [ ] **TASK-0-2-4-4**: 論理削除の実装（deletionSchemaを使用）
- [ ] **TASK-0-2-4-5**: Clerkアカウントの削除処理
- [ ] **TASK-0-2-4-6**: 退会画面の基本実装（デザインなし）

**検証項目**:
- [ ] 退会理由を選択できる
- [ ] 退会処理が実行される
- [ ] Convexの`users`テーブルで論理削除される（`deletion`オブジェクトが設定される）
- [ ] Clerkアカウントが削除される
- [ ] 退会後、ログイン画面にリダイレクトされる
- [ ] 退会後、認証が必要な画面にアクセスできない

**検証方法**: 実際に退会処理を行い、Convex Dashboardで論理削除を確認

---

#### Epic 0-2-5: プロフィール編集機能

**実装タスク**:
- [ ] **TASK-0-2-5-1**: Convex関数の作成（プロフィール更新）
- [ ] **TASK-0-2-5-2**: 名前の編集機能
- [ ] **TASK-0-2-5-3**: メールアドレスの編集機能
- [ ] **TASK-0-2-5-4**: 地域情報の設定機能
- [ ] **TASK-0-2-5-5**: プロフィール画像のアップロード機能（Cloudflare R2）
- [ ] **TASK-0-2-5-6**: プロフィール編集画面の基本実装（デザインなし）

**検証項目**:
- [ ] 名前を編集できる
- [ ] メールアドレスを編集できる
- [ ] 地域情報を設定できる
- [ ] プロフィール画像をアップロードできる
- [ ] 変更がConvexの`users`テーブルに反映される
- [ ] 変更が即座に画面に反映される

**検証方法**: 実際にプロフィールを編集し、Convex Dashboardでデータを確認

---

### Phase 0-3: 動作検証フェーズ

**目標**: Phase 0で実装した機能を実際の画面を通じて動作検証する

**実装タスク**:
- [ ] **TASK-0-3-1**: ユーザー登録フローの動作検証
- [ ] **TASK-0-3-2**: ログイン・ログアウトフローの動作検証
- [ ] **TASK-0-3-3**: 退会フローの動作検証
- [ ] **TASK-0-3-4**: プロフィール編集フローの動作検証
- [ ] **TASK-0-3-5**: エラーハンドリングの動作検証
- [ ] **TASK-0-3-6**: セキュリティチェック（IPAガイドライン準拠）

**検証項目**:
- [ ] すべての認証フローが正常に動作する
- [ ] エラーハンドリングが適切に動作する
- [ ] セキュリティチェックが通る（`pnpm security:audit`）
- [ ] 型チェックが通る（`pnpm typecheck`）
- [ ] リントが通る（`pnpm lint`）

**検証方法**: 
1. 実際のデバイス（iOS/Android）でアプリを起動
2. 各認証フローを実際に操作
3. エラーケースも含めて動作確認
4. Convex Dashboardでデータを確認
5. Sentry/Better Stackでエラーログを確認

---

## Phase 1: 個人管理・基礎構築（認証完了後）

**目標**: ペット管理と活動ログ記録の基本機能を実装する

**前提条件**: Phase 0が完了し、認証機能が動作していること

### Phase 1-1: ペット管理機能

**実装タスク**: Epic 2の実装（US-004〜US-007-1）

**検証フェーズ**: Phase 1-1の完了後、実際の画面で動作検証

### Phase 1-2: 活動ログ記録機能

**実装タスク**: Epic 3の実装（US-008〜US-013）

**検証フェーズ**: Phase 1-2の完了後、実際の画面で動作検証

---

## フェーズごとの動作検証の重要性

### なぜ動作検証フェーズが必要か

1. **早期のバグ発見**: 実装直後にバグを発見し、修正コストを最小化
2. **ユーザー体験の確認**: 実際の画面を通じて、ユーザー体験を確認
3. **統合テスト**: 複数の機能が連携して動作することを確認
4. **セキュリティ確認**: 認証・認可が正しく動作することを確認

### 動作検証の実施方法

1. **実際のデバイスでテスト**: iOS/Androidの実機で動作確認
2. **エッジケースの確認**: 異常系の動作も確認
3. **データの確認**: Convex Dashboardでデータが正しく保存されているか確認
4. **エラーログの確認**: Sentry/Better Stackでエラーログを確認
5. **セキュリティチェック**: `pnpm security:audit`でセキュリティチェック

---

## エピックと実装タスクの定義

詳細なエピックと実装タスクの定義は、**[EPIC_IMPLEMENTATION_PLAN.md](./EPIC_IMPLEMENTATION_PLAN.md)** を参照してください。

---

## 参考資料

- [USER_STORIES.md](../stories/USER_STORIES.md): モバイルアプリのユーザーストーリー
- [EPIC_OVERVIEW.md](./EPIC_OVERVIEW.md): 各エピックの概要とストーリー一覧
- [ISSUE_GUIDELINES.md](../../ISSUE_GUIDELINES.md): GitHub Issue作成ガイドライン
- [EPIC_IMPLEMENTATION_PLAN.md](./EPIC_IMPLEMENTATION_PLAN.md): エピックと実装タスクの詳細定義
