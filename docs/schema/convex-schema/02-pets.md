# 2. petsï¼ˆãƒšãƒƒãƒˆï¼‰

**ðŸ“š ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**: [CONVEX_SCHEMA_INDEX.md](../CONVEX_SCHEMA_INDEX.md)

### 2. petsï¼ˆãƒšãƒƒãƒˆï¼‰

**ç›®çš„**: ãƒšãƒƒãƒˆã®åŸºæœ¬æƒ…å ±ã¨ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç®¡ç†

**ä¸»è¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰**:
- `ownerId`: æ‰€æœ‰è€…ï¼ˆä¸»ç®¡ç†è€…ï¼‰ã€‚Phase 2ã§ã¯å…±åŒç®¡ç†è€…ã‚‚è¿½åŠ å¯èƒ½
- `species`: ç¨®åˆ¥ã€‚enumã§ã¯ãªãstringã§æŸ”è»Ÿæ€§ã‚’æŒãŸã›ã‚‹
- `breed`: å“ç¨®ã€‚ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ã§ã€Œãã®ä»–ã€ã«ã‚‚å¯¾å¿œ
- `birthDate`: èª•ç”Ÿæ—¥ï¼ˆUnixã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼‰ã€‚å¹´é½¢è¨ˆç®—ã«ä½¿ç”¨ âœ… **è‡ªå‹•ç®—å‡ºæ©Ÿèƒ½**
- `visibility`: å…¬é–‹è¨­å®šã€‚Phase 3ã®SNSæ©Ÿèƒ½ã§ä½¿ç”¨
- `deletion`: å‰Šé™¤çŠ¶æ…‹ï¼ˆè«–ç†å‰Šé™¤ï¼‰ã€‚Convexã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæŒ‡å‘ãªç‰¹æ€§ã‚’æ´»ã‹ã—ãŸè¨­è¨ˆ

**å¹´é½¢è¨ˆç®—**:
- `birthDate`ã‹ã‚‰å®Ÿå¹´é½¢ã¨äººé–“æ›ç®—å¹´é½¢ã‚’è‡ªå‹•ç®—å‡º
- `memorialStatus.deceasedDate`ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãã®æ—¥ã§å¹´é½¢è¨ˆç®—ã‚’åœæ­¢ï¼ˆä¾‹ï¼šã€Œ14æ­³5ãƒ¶æœˆã§ãŠç©ºã¸ã€ï¼‰
- ç¨®åˆ¥ï¼ˆ`species`ï¼‰ã«å¿œã˜ãŸé©åˆ‡ãªæ›ç®—å¼ã‚’é©ç”¨
  - çŠ¬ãƒ»çŒ«: 1å¹´ç›®=15æ­³ã€2å¹´ç›®=+9æ­³ã€3å¹´ç›®ä»¥é™=+4æ­³/å¹´
  - çˆ¬è™«é¡ž: 1å¹´ç›®=10æ­³ã€2å¹´ç›®ä»¥é™=+3æ­³/å¹´
  - é³¥é¡ž: 1å¹´ç›®=12æ­³ã€2å¹´ç›®ä»¥é™=+5æ­³/å¹´
  - ã†ã•ãŽãƒ»ãƒãƒ ã‚¹ã‚¿ãƒ¼: 1å¹´ç›®=18æ­³ã€2å¹´ç›®ä»¥é™=+8æ­³/å¹´
- å¹´é½¢è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã¯`packages/utils/src/petAge.ts`ã«é›†ç´„ï¼ˆãƒ¢ãƒã‚¤ãƒ«ã¨Webã§è¨ˆç®—çµæžœãŒã‚ºãƒ¬ã‚‹ã“ã¨ã‚’é˜²ãï¼‰

**ãƒ¡ãƒ¢ãƒªã‚¢ãƒ«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆè™¹ã®æ©‹ã‚’æ¸¡ã£ãŸå ´åˆï¼‰**:
- `memorialStatus`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå­˜åœ¨ã™ã‚‹å ´åˆã€ãƒšãƒƒãƒˆã¯ã€Œè™¹ã®æ©‹ã‚’æ¸¡ã£ãŸã€çŠ¶æ…‹
- **è¨­è¨ˆæ€æƒ³**: ã€Œè¨˜éŒ²ã®å°å°ã€ã§ã¯ãªãã€Œæ€ã„å‡ºã®ä¿è­·ã€ã¨ã„ã†è¦³ç‚¹ã§è¨­è¨ˆ
- **è¨­è¨ˆã®å“²å­¦**: ã€Œå’æ¥­ã€ã§ã¯ãªãã€Œæ°¸ä½ã€ã€‚ãƒšãƒƒãƒˆãŒäº¡ããªã£ãŸå¾Œã¯ã€ã€Œè¨˜éŒ²ã™ã‚‹å ´æ‰€ã€ã‹ã‚‰**ã€Œã„ã¤ã§ã‚‚ä¼šãˆã‚‹å ´æ‰€ã€**ã¸ã¨å½¹å‰²ã‚’å¤‰ãˆã‚‹
- è¨˜éŒ²ã‚’ã€Œå…¥åŠ›ã€ã™ã‚‹ãƒœã‚¿ãƒ³ãŒæ¶ˆãˆã€ä»£ã‚ã‚Šã«ã“ã‚Œã¾ã§ã®æ€ã„å‡ºã‚’ã€ŒæŒ¯ã‚Šè¿”ã‚‹ã€ãƒœã‚¿ãƒ³ã«å¤‰ã‚ã‚‹
- ãƒšãƒƒãƒˆã®ã‚¢ã‚¤ã‚³ãƒ³ã«ã€å„ªã—ãå…‰ã‚‹è¼ªã‚„æ·¡ã„èƒŒæ™¯è‰²ã‚’æ·»ãˆã‚‹
- å¹´é½¢è¡¨ç¤ºã¯å‘½æ—¥ã§å›ºå®šã•ã‚Œã‚‹ï¼ˆä¾‹ï¼šã€Œ14æ­³5ãƒ¶æœˆã§ãŠç©ºã¸ã€ï¼‰
- `deceasedDate`: å‘½æ—¥ï¼ˆUnixã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼‰ã€‚ã“ã®æ—¥ã§å¹´é½¢è¨ˆç®—ã‚’åœæ­¢

**è¿½æ‚¼ï¼ˆãƒ¡ãƒ¢ãƒªã‚¢ãƒ«ï¼‰ãƒ—ãƒ©ãƒ³** âœ… **2026å¹´æœ€çµ‚è¨­è¨ˆæ¤œè¨¼ã§è¿½åŠ **:
- ãƒšãƒƒãƒˆãŒäº¡ããªã‚Šã€æ–°ã—ã„è¨˜éŒ²ãŒãªããªã£ãŸå¾Œã‚‚ã€æ€ã„å‡ºï¼ˆé«˜ç”»è³ªç”»åƒï¼‰ã‚’è¦‹ã‚‹ãŸã‚ã«èª²é‡‘ã‚’ç¶šã‘ãªã‘ã‚Œã°ãªã‚‰ãªã„å•é¡Œã‚’è§£æ±º
- **ææ¡ˆ**: ã€Œè¿½æ‚¼ï¼ˆãƒ¡ãƒ¢ãƒªã‚¢ãƒ«ï¼‰ãƒ—ãƒ©ãƒ³ã€ã®å°Žå…¥
  - æœˆé¡ã¯ç„¡æ–™ã¾ãŸã¯æ¥µå®‰ä¾¡ã«ã—ã€ãƒ‡ãƒ¼ã‚¿ã®ä¿æŒã¨é–²è¦§ã ã‘ã‚’è¨±å¯ã™ã‚‹ã€Œèª­ã¿å–ã‚Šå°‚ç”¨ã€ã®çŠ¶æ…‹
  - ã‚ã‚‹ã„ã¯ã€ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä¼šå“¡ã ã£ãŸæœŸé–“ã®ãƒ‡ãƒ¼ã‚¿ã¯ã€é€€ä¼šå¾Œã‚‚ä¸€å®šæœŸé–“ã€Œæœ€é«˜ç”»è³ªã€ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¯èƒ½ã«ã™ã‚‹ãªã©ã®é…æ…®
- `users.subscription.tier`ã«`"memorial"`ã‚’è¿½åŠ 
- `users.subscription.premiumPeriodEndsAt`ã§ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä¼šå“¡ã ã£ãŸæœ€å¾Œã®æ—¥æ™‚ã‚’è¨˜éŒ²ã—ã€ãã®æœŸé–“ã®ãƒ‡ãƒ¼ã‚¿ã¯æœ€é«˜ç”»è³ªã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¯èƒ½
- `message`: é£¼ã„ä¸»ã‹ã‚‰ã®æœ€å¾Œã®ä¸€è¨€ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
- `createdAt`: ãƒ¡ãƒ¢ãƒªã‚¢ãƒ«ãƒ¢ãƒ¼ãƒ‰ã«ç§»è¡Œã—ãŸæ—¥æ™‚

**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**:
- `by_owner`: æ‰€æœ‰è€…ã§ã®æ¤œç´¢ï¼ˆãƒšãƒƒãƒˆä¸€è¦§è¡¨ç¤ºï¼‰
- `by_owner_active`: æ‰€æœ‰è€…ãƒ»å‰Šé™¤çŠ¶æ…‹ã§ã®æ¤œç´¢ï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒšãƒƒãƒˆã®ã¿å–å¾—ï¼‰
- `by_species_breed`: ç¨®åˆ¥ãƒ»å“ç¨®ã§ã®æ¤œç´¢ï¼ˆæ¤œç´¢æ©Ÿèƒ½ï¼‰
- `search_bio`: å…¨æ–‡æ¤œç´¢ï¼ˆè‡ªå·±ç´¹ä»‹ã§ã®æ¤œç´¢ï¼‰

**å‰Šé™¤æ©Ÿèƒ½**:
- `deletion`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå­˜åœ¨ã™ã‚‹å ´åˆã€ãƒ‡ãƒ¼ã‚¿ã¯å‰Šé™¤ã•ã‚ŒãŸçŠ¶æ…‹
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§30æ—¥é–“å¾©å…ƒå¯èƒ½ï¼ˆ`restorableUntil`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§åˆ¶å¾¡ï¼‰
- å‰Šé™¤æ—¥æ™‚ã€å‰Šé™¤è€…ã€å‰Šé™¤ç†ç”±ãŒè¨˜éŒ²ã•ã‚Œã‚‹

**ä½¿ç”¨ä¾‹**:
```typescript
import { createDeletion } from "./lib/deletionSchema";

// ãƒšãƒƒãƒˆä½œæˆ
await ctx.db.insert("pets", {
  ownerId: userId,
  name: "ãƒãƒ",
  species: "Dog",
  breed: "Husky",
  gender: "male",
  birthDate: Date.now() - 2 * 365.25 * 24 * 60 * 60 * 1000, // 2å¹´å‰ã®èª•ç”Ÿæ—¥
  isNeutered: false,
  visibility: "private",
});

// å¹´é½¢è¨ˆç®—ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¾ãŸã¯Queryã§ä½¿ç”¨ï¼‰
import { calculatePetAgeInfo, formatPetAgeDisplay } from "@repo/utils/petAge";

const pet = await ctx.db.get(petId);
if (pet && pet.birthDate) {
  const ageInfo = calculatePetAgeInfo(
    pet.birthDate, 
    pet.species,
    Date.now(),
    pet.memorialStatus?.deceasedDate // å‘½æ—¥ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãã®æ—¥ã§å¹´é½¢è¨ˆç®—ã‚’åœæ­¢
  );
  if (ageInfo) {
    const isMemorial = !!pet.memorialStatus;
    console.log(formatPetAgeDisplay(ageInfo, isMemorial)); 
    // é€šå¸¸: "2æ­³ï¼ˆäººé–“æ›ç®—: ç´„24æ­³ï¼‰"
    // ãƒ¡ãƒ¢ãƒªã‚¢ãƒ«: "14æ­³5ãƒ¶æœˆã§ãŠç©ºã¸"
  }
}

// ãƒ¡ãƒ¢ãƒªã‚¢ãƒ«ãƒ¢ãƒ¼ãƒ‰ã¸ã®ç§»è¡Œï¼ˆè™¹ã®æ©‹ã‚’æ¸¡ã‚‹ï¼‰
await ctx.db.patch(petId, {
  memorialStatus: {
    deceasedDate: Date.now(), // å‘½æ—¥
    message: "ã‚ã‚ŠãŒã¨ã†ã€ãƒãƒã€‚ã„ã¤ã‚‚ä¸€ç·’ã«ã„ã¦ãã‚Œã¦ã€‚", // é£¼ã„ä¸»ã‹ã‚‰ã®æœ€å¾Œã®ä¸€è¨€ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    createdAt: Date.now(),
  },
});

// ãƒšãƒƒãƒˆå‰Šé™¤ï¼ˆè«–ç†å‰Šé™¤ï¼‰
await ctx.db.patch(petId, {
  deletion: createDeletion(userId, "èª¤æ“ä½œ", 30), // 30æ—¥é–“å¾©å…ƒå¯èƒ½
});

// ãƒšãƒƒãƒˆå¾©å…ƒ
await ctx.db.patch(petId, {
  deletion: undefined, // å‰Šé™¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤ã™ã‚‹ã“ã¨ã§å¾©å…ƒ
});

// ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒšãƒƒãƒˆã®ã¿å–å¾—
const activePets = await ctx.db
  .query("pets")
  .withIndex("by_owner_active", (q) => 
    q.eq("ownerId", userId).eq("deletion", undefined)
  )
  .collect();
```

---
