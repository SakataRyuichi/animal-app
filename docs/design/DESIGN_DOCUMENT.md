# アプリ設計ドキュメント（一次設計）

**📚 ドキュメントインデックス**: [DOCUMENTATION_INDEX.md](../../DOCUMENTATION_INDEX.md)

## 1. プロジェクト概要

**関連ドキュメント**:
- [USER_STORIES.md](../stories/USER_STORIES.md): モバイルアプリのユーザーストーリー
- [ADMIN_USER_STORIES.md](../stories/ADMIN_USER_STORIES.md): 管理画面のユーザーストーリー
- [WEB_USER_STORIES.md](../stories/WEB_USER_STORIES.md): 公式サイトのユーザーストーリー ✅ **2026年追加**
- [CONVEX_SCHEMA.md](../schema/CONVEX_SCHEMA.md): スキーマ定義
- [TECH_STACK_PLANNING.md](./TECH_STACK_PLANNING.md): 技術選定の詳細
- [APP_DIRECTORY_STRUCTURE.md](../app-structure/APP_DIRECTORY_STRUCTURE.md): アプリディレクトリ構成と画面マッピング ✅ **2026年追加**

### 1.1 アプリの目的
個人のペット管理から始まり、家族・チーム管理を経て、最終的にはペット特化のSNS兼商品データベースへと発展させるプラットフォーム。

### 1.2 ターゲットユーザー
- **Phase 1**: 個人のペット飼い主
- **Phase 2**: 家族・チームでペットを管理するユーザー
- **Phase 3**: ペットコミュニティ全体（飼い主、事業者、レビュアー）

### 1.3 フェーズ別ロードマップ

#### Phase 1: 個人管理・基礎構築
- ペットの基本情報管理
- 活動ログの記録（食事、トイレ、散歩、日記、ケア）
- 個人向けダッシュボード
- **コラム・記事機能** ✅ **信頼性向上・フック機能**
  - 専門家による信頼できる一次ソースに特化したコラム
  - ペット種別に合わせたレコメンデーション
  - AI執筆サポート（運営用）
- **AI相談機能（RAGベース）** ✅ **キラー機能**
  - ペットのカルテ情報を活用した相談
  - 信頼できる知識ベースからの回答生成
  - 緊急度判定と病院案内

#### Phase 2: 家族・チーム管理
- 複数人でのペット管理
- 共同管理者の追加・権限管理
- 家族間での情報共有
- AI相談機能の拡張（共同管理者からの相談）

#### Phase 3: ペット特化のSNS兼商品データベース
- **SNS機能** ✅ **2026年版モダンSNS**
  - 「フォロー中（Following）」と「おすすめ（For You）」のタブ切り替え
  - フォロー機能
  - いいね機能
  - AI（RAG）を活用した超パーソナライズ（オプション）
- 商品データベース
- 商品レビュー・評価
- ペット種別ごとの商品人気ランキング

---

## 2. データモデル設計

### 2.1 エンティティ一覧

#### 2.1.1 Users（ユーザー）
**目的**: アプリを利用するユーザー（個人/事業者）の情報を管理

**主要フィールド**:
- `tokenIdentifier`: 認証ID（Clerk）
- `name`: ユーザー名
- `email`: メールアドレス
- `type`: ユーザータイプ（個人/事業者）
- `subscription`: サブスクリプション情報（プレミアム機能の制御）✅ **機能制限とUXをシームレスに繋ぐ設計**
  - `tier`: プラン（free/premium、将来的にfamilyなども追加可能）
  - `status`: サブスクリプションの状態（active/canceled/past_due/trialing）
  - `endsAt`: サブスクリプションの期限
  - `gracePeriodEndsAt`: 猶予期間の期限（支払い失敗後も機能を維持する期間）
  - `revenueCatUserId`: RevenueCatのユーザーID
- `location`: 地域情報（検索用）
- `businessInfo`: 事業者情報（事業者の場合）

**インデックス**:
- `by_token`: 認証IDでの検索

**ユースケース**:
- ユーザー登録・ログイン
- プロフィール管理
- プレミアム機能の有効化
- サブスクリプション管理（購入、更新、キャンセル）
- 猶予期間の管理
- 事業者アカウントの管理

---

#### 2.1.2 Pets（ペット）
**目的**: ペットの基本情報とプロフィールを管理

**主要フィールド**:
- `ownerId`: 所有者（主管理者）
- `name`: ペット名
- `species`: 種別（犬、猫、爬虫類など）
- `breed`: 品種（ハスキー、レオパなど）
- `gender`: 性別
- `birthDate`: 誕生日（Unixタイムスタンプ）✅ **年齢自動算出機能**
- `photoUrl`: プロフィール画像
- `weight`: 最新体重
- `isNeutered`: 去勢/避妊済みフラグ
- `origin`: 出自（ショップ、ブリーダー、里親など）
- `insurance`: 保険情報
- `bio`: 自己紹介
- `personality`: 性格タグ
- `visibility`: 公開設定（private/shared/public）
- `deletion`: 削除状態（論理削除）✅ **Convexのドキュメント指向な特性を最大限に活用**

**年齢計算機能**:
- `birthDate`から実年齢と人間換算年齢を自動算出
- 種別に応じた適切な換算式を適用（`packages/utils/src/petAge.ts`）
- モバイルアプリと管理画面で計算結果がズレることを防ぐため、ロジックを`packages/utils`に集約

**バースデー・記念日機能**:
- 誕生日の判定とバースデー演出（`packages/utils/src/petCelebrations.ts`）
- 成長の節目通知（1ヶ月、3ヶ月、6ヶ月、1年、2年など）
- 記念日の記録を自動で日記として保存

**アルバム管理機能**:
- `albums`テーブル: アルバム自体を管理
- `album_items`テーブル: アルバムとコンテンツ（活動ログ・画像）を紐付ける中間テーブル
- **設計思想**: 日記や写真をテーマ別（例：「初めてのお散歩」「通院記録」「5歳の誕生日」）に整理することで、ユーザーの愛着が深まる
- **機能制限**:
  - 無料ユーザー: 最大2つまで作成可能、1アルバム20枚まで
  - プレミアムユーザー: 無制限、共同編集可能、共有・送信機能利用可能
- **UX設計**: 日記詳細画面から簡単にアルバムに追加できる「＋」アイコン、複数選択で一括追加可能な「整理モード」

**メモリアル機能（虹の橋を渡った場合）**:
- `memorialStatus`オブジェクトでメモリアルステータスを管理
- **設計思想**: 「記録の封印」ではなく「思い出の保護」という観点で設計
- 命日（`deceasedDate`）が設定されている場合、その日で年齢計算を停止
- 記録を「入力」するボタンが消え、代わりにこれまでの思い出を「振り返る」ボタンに変わる
- ペットのアイコンに、優しく光る輪や淡い背景色を添える
- 年齢表示は命日で固定される（例：「14歳5ヶ月でお空へ」）
- プレミアム限定で、思い出のアルバム作成・エクスポート機能を提供（PDF、ZIP、SNS共有）

**インデックス**:
- `by_owner`: 所有者での検索
- `by_owner_active`: 所有者・削除状態での検索（アクティブなペットのみ取得）
- `by_species_breed`: 種別・品種での検索
- `search_bio`: 全文検索（自己紹介）

**ユースケース**:
- ペット登録
- プロフィール編集
- ペット一覧表示
- 種別・品種での検索
- 公開設定の変更
- ペット削除（論理削除、30日間復元可能）
- ペット復元

---

#### 2.1.3 Pet Members（共同管理者）
**目的**: Phase 2で実装。1匹のペットを複数人で管理するためのリンクテーブル

**主要フィールド**:
- `petId`: ペットID
- `userId`: ユーザーID
- `role`: 権限（admin/editor/viewer）

**インデックス**:
- `by_pet`: ペットでの検索
- `by_user`: ユーザーでの検索

**ユースケース**:
- 家族メンバーの追加
- 権限の設定・変更
- 共同管理者一覧の表示
- 自分が管理できるペット一覧の取得

---

#### 2.1.4 Activities（活動ログ）
**目的**: ペットの日常活動を一元管理（食事、トイレ、散歩、日記、ケアなど）

**主要フィールド**:
- `petId`: ペットID
- `createdBy`: 記録者
- `loggedAt`: 記録日時（過去の日付登録も可能）
- `type`: ログタイプ（food/toilet/walk/health/diary/care）
- `payload`: 実際のデータ（柔軟な構造）
  - `imageIds`: 画像IDの配列（`images`テーブルへの参照）✅ **Convexのプライシングを考慮した設計**
  - `text`: メモ・日記本文
  - `foodId`: 商品ID（食事ログ）
  - `amount`: 量（食事ログ）
  - `toiletType`: トイレタイプ（pee/poo）
  - `condition`: 状態（hard/soft/diarrhea）
  - `durationMin`: 時間（散歩ログ）
  - `distanceKm`: 距離（散歩ログ）
  - `careType`: ケアタイプ（nail/shampoo/vaccine）
- `isPublic`: 公開フラグ（Phase 3）
- `likeCount`: いいね数（Phase 3）
- `deletion`: 削除状態（論理削除）✅ **Convexのドキュメント指向な特性を最大限に活用**

**インデックス**:
- `by_pet_date`: ペット・日時での検索（タイムライン表示用）
- `by_pet_active`: ペット・削除状態での検索（アクティブなログのみ取得）
- `by_public_feed`: 公開フィード用（Phase 3）

**ユースケース**:
- 食事記録
- トイレ記録
- 散歩記録
- 日記投稿
- ケア記録
- タイムライン表示
- グローバルフィード表示（Phase 3）
- 活動ログ削除（論理削除、30日間復元可能）
- 活動ログ復元

---

#### 2.1.5 Images（画像管理）✅ **Convexのプライシングを考慮した設計**

**目的**: 画像を一元管理し、プレミアム機能としての最高画質保存と画像編集機能を実現

**主要フィールド**:
- `previewStorageId`: 表示用WebP（無料ユーザーも参照可能、500KB程度）
- `originalStorageId`: 最高画質WebP（プレミアムユーザーのみ参照可能、数MB以上）
- `editMetadata`: 編集データ（プレミアムのみ：スタンプの位置や文字の内容）
- `hasEdits`: 編集されているかどうか
- `isPremiumAtUpload`: アップロード時のユーザー状態（プレミアムかどうか）

**インデックス**:
- `by_user`: ユーザーでの検索
- `by_pet`: ペットでの検索
- `by_activity`: 活動ログでの検索
- `by_user_active`: ユーザー・削除状態での検索（アクティブな画像のみ取得）

**画像保存戦略**:
- **無料ユーザー**: 累計50枚まで（約25MB）、表示用WebPのみ
- **プレミアムユーザー**: 無制限、最高画質WebPも保存・表示可能
- **編集機能**: 無料ユーザーは編集後の画像のみ保存、プレミアムユーザーは編集前・編集後の両方を保存（非破壊編集）

**詳細**: `IMAGE_STORAGE_STRATEGY.md`を参照してください。

---

#### 2.1.5 Products（商品データベース）
**目的**: Phase 3で実装。ペット用品のマスタデータ

**主要フィールド**:
- `name`: 商品名
- `category`: カテゴリ（food/toy/cageなど）
- `brand`: ブランド名
- `isVerified`: 運営確認済みフラグ
- `submittedBy`: 登録者
- `affiliateLink`: アフィリエイトURL
- `imageUrl`: 商品画像
- `averageRating`: 平均評価
- `reviewCount`: レビュー数

**インデックス**:
- `search_name`: 商品名での全文検索

**ユースケース**:
- 商品登録（ユーザー投稿）
- 商品検索
- 商品詳細表示
- 運営による商品承認
- アフィリエイトリンクの付与

---

#### 2.1.6 Reviews（商品レビュー）
**目的**: Phase 3で実装。商品に対するレビュー・評価

**主要フィールド**:
- `userId`: レビュアー
- `petId`: 使用したペット
- `productId`: 商品ID
- `rating`: 評価（1-5）
- `comment`: コメント
- `petSpecies`: ペット種別（集計用）
- `petBreed`: ペット品種（集計用）

**インデックス**:
- `by_product`: 商品での検索
- `by_species_product`: 種別・商品での検索（「猫に人気のフード」など）

**ユースケース**:
- レビュー投稿
- レビュー一覧表示
- 種別ごとの商品人気ランキング
- レビュー統計の集計

---

#### 2.1.7 Chat Threads（AIチャットスレッド）
**目的**: Phase 1後半 / Phase 2で実装。AI相談の会話スレッドを管理

**主要フィールド**:
- `userId`: ユーザーID
- `petId`: 相談対象のペットID
- `title`: スレッドタイトル（自動生成）
- `createdAt`: 作成日時

**インデックス**:
- `by_user_pet`: ユーザー・ペットでの検索（スレッド一覧）

**ユースケース**:
- チャットスレッド作成
- スレッド一覧表示
- スレッド削除

---

#### 2.1.8 Chat Messages（AIチャットメッセージ）
**目的**: Phase 1後半 / Phase 2で実装。AI相談のメッセージ履歴を管理

**主要フィールド**:
- `threadId`: スレッドID
- `role`: メッセージの役割（user/assistant）
- `content`: メッセージ内容
- `citedSources`: 引用した知識ベースのID配列

**インデックス**:
- `by_thread`: スレッドでの検索（メッセージ一覧）

**ユースケース**:
- メッセージ送信
- メッセージ履歴表示
- 引用元の表示

---

#### 2.1.9 Knowledge Base（知識ベース）
**目的**: Phase 1後半 / Phase 2で実装。RAG用の信頼できる知識データ

**主要フィールド**:
- `title`: 記事タイトル
- `content`: 記事本文
- `sourceUrl`: 情報元のURL（信頼性の担保）
- `category`: カテゴリ（Emergency/Food/Illnessなど）
- `embedding`: ベクトル埋め込み（1536次元）

**インデックス**:
- `by_embedding`: ベクトル検索インデックス（類似度検索用）

**ユースケース**:
- 知識データの投入（運営）
- ベクトル検索による関連知識の取得
- 引用元の表示

---

#### 2.1.10 Articles（コラム・記事）
**目的**: Phase 1後半 / Phase 2で実装。管理者・専門家による信頼できるコラム・記事

**主要フィールド**:
- `authorId`: 投稿者（管理者 or 認定獣医師）
- `title`: 記事タイトル
- `content`: 本文（Markdown形式推奨）
- `thumbnailUrl`: アイキャッチ画像
- `targetSpecies`: 対象種別（配列）
- `tags`: タグ（配列）
- `sources`: 一次ソースのリンク（信頼性の担保）
- `status`: 公開状態（draft/published）
- `isExpertContent`: 専門家による執筆フラグ

**インデックス**:
- `by_status_date`: 公開状態・日時での検索（公開記事を新しい順に）
- `by_species`: 種別でのフィルタリング
- `search_content`: 全文検索

**ユースケース**:
- コラム一覧表示
- コラム詳細表示
- 種別ごとのレコメンデーション
- 管理者用投稿機能

---

#### 2.1.11 Follows（フォロー関係）
**目的**: Phase 3で実装。ユーザー間のフォロー関係を管理

**主要フィールド**:
- `followerId`: フォローする人（フォロワー）
- `followingId`: フォローされる人（フォロイー）
- `createdAt`: フォロー開始日時

**インデックス**:
- `by_follower`: フォローしている人の一覧取得
- `by_following`: フォロワー一覧取得
- `by_follower_following`: フォロー関係の確認（重複防止）

**ユースケース**:
- フォロー・フォロー解除
- フォロー中フィードの取得
- フォロワー一覧表示

---

#### 2.1.12 Likes（いいね）
**目的**: Phase 3で実装。投稿へのいいねを管理

**主要フィールド**:
- `userId`: いいねしたユーザー
- `activityId`: いいねされた投稿（activities）
- `createdAt`: いいね日時

**インデックス**:
- `by_activity`: 投稿ごとのいいね一覧（いいね数カウント）
- `by_user_activity`: ユーザーがいいねしたかどうかの確認（重複防止）
- `by_user`: ユーザーがいいねした投稿一覧

**ユースケース**:
- いいね・いいね解除
- いいね数の表示
- 人気投稿の取得

---

### 2.2 削除機能の設計思想 ✅ **Convexのドキュメント指向な特性を最大限に活用**

**設計思想**: `isDeleted`フラグではなく、削除に関するコンテキストをまとめた`deletion`オブジェクトを使用することで、型安全性とクエリのシンプル化を実現します。

**メリット**:
1. **型安全な条件分岐**: `if (pet.deletion)` というチェックを通るだけで、そのブロック内では削除日時や削除者に型安全にアクセスできます
2. **クエリのシンプル化**: 「オブジェクトが存在するかどうか」で判定できる
   ```typescript
   // アクティブなデータのみ取得
   const activePets = await ctx.db
     .query("pets")
     .withIndex("by_owner_active", (q) => q.eq("deletion", undefined))
     .collect();
   ```
3. **セキュリティと監査（オーディット）**: 「誰が」「いつ」消したかがデータそのものに内包されているため、後から調査するロジックが組みやすい

**実装**:
- `packages/backend/convex/lib/deletionSchema.ts`に共通スキーマ定義を配置
- `pets`、`activities`などの主要テーブルに`deletion: deletionSchema`を追加
- デフォルトで30日間復元可能（`restorableUntil`フィールドで制御）

**UI/UXの考慮**:
- 削除時に「後から元に戻せます（30日間）」というメッセージを表示
- 設定画面に「削除したペット」セクションを追加
- 「残りあと◯日で完全に消去されます」というメッセージを表示
- 復元ボタンを提供

---

### 2.3 プレミアム権限管理 ✅ **機能制限とUXをシームレスに繋ぐ設計**

**設計思想**: プレミアムユーザーの管理は、**「機能制限」**と**「UX（アップグレード案内）」**をシームレスに繋ぐために、Convexのテーブル定義とReactのガード機能を組み合わせます。

**スキーマ設計**:
- `users.subscription`オブジェクトでサブスクリプションの状態を管理
- `tier`: プラン（free/premium、将来的にfamilyなども追加可能）
- `status`: サブスクリプションの状態（active/canceled/past_due/trialing）
- `endsAt`: サブスクリプションの期限
- `gracePeriodEndsAt`: 猶予期間の期限（支払い失敗後も機能を維持する期間）

**バックエンド（Convex）でのガード**:
- `packages/backend/convex/lib/permissions.ts`に権限チェック用のヘルパー関数を実装
- `assertPremium()`: プレミアム会員であることを要求（エラーを投げる）
- `isPremiumUser()`: ユーザーがプレミアム会員かどうかを判定（エラーを投げない）
- 猶予期間（gracePeriodEndsAt）も考慮した判定

**フロントエンド（React）でのガード**:
- `packages/ui/src/components/PremiumGuard.tsx`にプレミアムガードコンポーネントを実装
- プレミアムでない場合、アップグレード案内を表示
- ハーフモーダル（Sheet）やプレースホルダーでの案内

**プレミアム限定機能の例**:
- 詳細な統計情報（US-017: 体重推移グラフ、US-072: 統計情報表示）
- 家族・チーム管理（Phase 2の共同管理機能）
- 高度なAI相談機能（詳細分析、過去の相談履歴の詳細表示）
- データエクスポート機能

**UX（アップグレード案内）の3段階**:
1. **ロックアイコンの表示**: プレミアム機能の横に小さな鍵アイコンを表示
2. **ハーフモーダル（Sheet）**: 機能をクリックした際に下から表示される案内
3. **プレースホルダー**: プレミアム限定の統計画面などは、ぼかし（Blur）をかけた背景に案内テキストを表示

**詳細**: `CONVEX_SCHEMA.md`の「実装時の注意点 > 6. プレミアム権限管理」を参照してください。

### 2.4 画像・動画保存戦略 ✅ **2026年更新 - Cloudflare R2移行・動画対応**

**設計思想**: Cloudflare R2を活用し、画像・動画を効率的に保存することで、コストを最小化しながら、プレミアム機能としての最高画質保存を実現します。

**Cloudflare R2への移行** ✅ **2026年追加**:
- **コスト削減**: 下り通信料（Egress Fee）が完全に無料のため、動画再生時のコストが大幅に削減
- **パフォーマンス向上**: Cloudflare CDNとの統合により、世界中のユーザーに高速なコンテンツ配信
- **スケーラビリティ**: 動画のような大容量ファイルも扱いやすい

**ダブルストレージ構造**（画像）:
- **表示用（Preview）**: 無料ユーザーも参照可能、WebP形式、幅1080px、Quality 0.6-0.7、約500KB
- **最高画質（Original）**: プレミアムユーザーのみ参照可能、WebP形式、リサイズなし、Quality 0.9-1.0、約数MB

**動画の保存** ✅ **2026年追加**:
- **無料ユーザー**: 1本あたり最大15秒、1ペットにつき月間3本まで、720p/HEVC（約15-20MB/分）
- **プレミアムユーザー**: 1本あたり最大60秒、無制限、1080p/HEVC（約30-40MB/分）
- **自動圧縮**: クライアント側（Expo）でアップロード前に自動で圧縮
- **サムネイル生成**: 動画の最初のフレームから自動でサムネイル画像を生成

**「温かみと誠実さ」を感じさせる設計**:
- 無料ユーザーがアップロードした画像も、**裏で最高画質データを保存**
- プレミアムにアップグレードした瞬間、過去の全ての写真が美しくなる「マジックモーメント」を実現
- 「データは消していない（温かみ）」と「今すぐは見られない（制限）」を両立

**画像枚数制限**:
- **無料ユーザー**: 累計50枚まで（約25MB）
- **プレミアムユーザー**: 無制限

**画像編集機能**:
- **無料ユーザー**: 編集後の画像のみ保存（編集前は削除）
- **プレミアムユーザー**: 編集前・編集後の両方を保存し、編集メタデータも保存（非破壊編集）

**画像ダウンロード機能**:
- **無料ユーザー**: 表示用WebP（ウォーターマーク付き）のみダウンロード可能
- **プレミアムユーザー**: 最高画質WebP（ウォーターマークなし）、編集前のオリジナル、一括ダウンロード

**動画ダウンロード機能** ✅ **2026年追加**:
- **無料ユーザー**: 不可（プレミアム案内が表示される）
- **プレミアムユーザー**: 可能（HEVC形式）

**詳細**: `IMAGE_STORAGE_STRATEGY.md`、`CLOUDFLARE_R2_MIGRATION.md`を参照してください。

---

## 3. データフロー設計

### 3.1 認証フロー
```
1. Clerkでログイン
2. Convexでユーザー存在確認
3. 存在しなければ users テーブルに作成
4. セッション確立
```

### 3.2 ペット登録フロー
```
1. ユーザーがペット情報を入力
2. pets テーブルに新規作成
3. ownerId に現在のユーザーIDを設定
4. ペット一覧に追加表示
```

### 3.3 活動ログ記録フロー
```
1. ユーザーが活動ログを入力
2. activities テーブルに新規作成
3. petId と createdBy を設定
4. type に応じて payload にデータを格納
5. タイムラインに反映
```

### 3.4 商品登録フロー（Phase 3）
```
1. ユーザーが活動ログで商品を検索
2. 商品が見つからない場合、新規作成
3. products テーブルに isVerified: false で保存
4. 運営が確認後、isVerified: true に更新
5. アフィリエイトリンクを付与
```

### 3.5 AI相談フロー（Phase 1後半 / Phase 2）
```
1. ユーザーがチャット画面で質問を入力
   - 初回利用時: ウェルカムメッセージと免責事項を表示 ✅
   - 入力中: 専門的なキーワード検出時にリアルタイム警告を表示 ✅
2. chat_threads テーブルにスレッドを作成（初回の場合）
3. chat_messages テーブルにユーザーメッセージを保存
4. chat アクションを呼び出し:
   a. ペットのカルテ情報を取得（pets, activities）
   b. 質問をベクトル化（OpenAI Embeddings API）
   c. 知識ベースをベクトル検索（Convex Vector Search）
   d. 関連知識を取得
   e. システムプロンプト + カルテ + 知識 + 質問をLLMに送信
     - システムプロンプトに免責事項とガードレールを含める ✅
   f. 回答を生成（引用元も含む）
   g. 免責事項タイプを自動判定（medical/food/emergency/general） ✅
5. chat_messages テーブルにAI回答を保存（disclaimerShown, disclaimerTypeを含む） ✅
6. UIに回答を表示:
   - 回答内容を表示
   - 引用元を表示
   - 免責事項を表示（フッターまたはインライン） ✅
   - 推奨アクションを表示
7. 緊急度が高い場合、警告表示と病院マップを表示
```

### 3.6 コラム投稿フロー（Phase 1後半 / Phase 2）
```
1. 管理者または認定専門家がコラムを作成
2. タイトル、本文、対象種別、タグを入力
3. 一次ソースのリンクを追加
4. 下書きとして保存（status: "draft"）
5. プレビューで確認
6. 公開（status: "published"）
7. ホーム画面にレコメンド表示
```

### 3.6-1 キュレーション記事の登録フロー（Phase 1後半 / Phase 2）✅ **外部記事の紹介**
```
1. 管理者が外部記事のURLを入力
2. OGP情報（タイトル、画像、説明）を自動取得（Convex Action）
3. 管理者が紹介文（summary）を入力（「この記事のここがレオくんに役立つかも！」など）
4. カテゴリ、対象種別、プレミアム制限を設定
5. サムネイル画像をConvex Storageに保存（最適化）
6. URLをサニタイズ（悪意のあるスクリプトを除去）
7. curations テーブルに保存
8. キュレーション一覧に表示
```

### 3.6-2 キュレーション記事の閲覧フロー（Phase 1後半 / Phase 2）✅ **外部記事の紹介**
```
1. ユーザーがキュレーション一覧画面を開く
2. ペットの種別に合わせて、関連する記事が優先的に表示される（パーソナライズ）
3. 記事をタップすると、パーソナライズされたポップアップが表示される
   - 「この記事のここがレオくんに役立つかも！」（AIが生成）
4. 記事を開く（expo-web-browserでアプリ内ブラウザ）
5. 記事閲覧中に、「この記事について話す」ボタンが表示される
6. 「あとで読む」ボタンで保存できる
7. 「この記事を参考にアルバムを作る」ボタンで、アルバム作成画面に遷移
8. curation_interactions テーブルに閲覧履歴を記録
```

### 3.7 コラムレコメンデーションフロー
```
1. ユーザーがホーム画面を開く
2. ユーザーが飼っているペットの種別を取得
3. articles テーブルから該当種別の公開記事を検索
4. 新しい順にソート
5. 「あなたにおすすめ」セクションに表示
```

### 3.7-1 キュレーションレコメンデーションフロー（Phase 1後半 / Phase 2）✅ **外部記事の紹介**
```
1. ユーザーがホーム画面またはキュレーション一覧画面を開く
2. ユーザーが飼っているペットの種別と年齢を取得
3. curations テーブルから該当種別のアクティブな記事を検索
4. 新しい順にソート
5. AIがユーザーのペット情報を元に、パーソナライズされた紹介文を生成
6. 「あなたにおすすめ」セクションに表示
7. プレミアムユーザーの場合、記事に基づいた「AIアドバイス」も表示
```

### 3.8 SNSフィード表示フロー（Phase 3）

**フォロー中（Following）タブ**:
```
1. ユーザーが「フォロー中」タブを選択
2. follows テーブルから、現在のユーザーがフォローしている userId リストを取得
3. activities テーブルから、フォローしているユーザーの isPublic: true の投稿を取得
4. createdAt で新しい順にソート
5. タイムラインに表示
6. フォローしている人が新しい投稿をすると、リアルタイムで自動更新
```

**おすすめ（For You）タブ**:
```
1. ユーザーが「おすすめ」タブを選択
2. 以下の要素をミックス:
   a. 人気投稿: likes テーブルからいいね数が多い投稿を取得
   b. 関連性: ユーザーのペットと同じ種別の投稿を取得
   c. 波及効果: フォローしている人がいいねした投稿を取得
   d. **専門家が「いいね」した投稿を優先的に表示**（信頼性の指標）
3. スコアリングして優先順位を決定（専門家のいいねは高スコア）
4. タイムラインに表示
```

**AIパーソナライズ版（オプション）**:
```
1. ユーザーのペット情報（種別、品種、年齢など）をベクトル化
2. 投稿内容をベクトル化（embedding フィールドを使用）
3. Convex Vector Searchで類似度を計算
4. 類似度が高い投稿を優先的に表示
```

### 3.9 フォロー・いいねフロー（Phase 3）

**フォローフロー**:
```
1. ユーザーが他のユーザーのプロフィール画面で「フォロー」ボタンをタップ
2. follows テーブルに新規作成（followerId, followingId）
3. フォローされたユーザーに通知（将来拡張）
4. リアルタイムでフォロー状態が更新される
```

**リアクションフロー** ✅ **2026年更新 - 多機能リアクション**:
```
1. ユーザーが投稿のリアクションボタンをタップ
   - **通常タップ**: デフォルトのリアクション（❤️ 大好き）を追加
   - **長押し**: 複数のリアクションタイプから選択できるメニューを表示
2. リアクションタイプを選択（❤️, 🌻, 💪, 🌟, 🌈）
3. likes テーブルに新規作成（userId, activityId, reactionType）✅ **2026年追加**
4. 投稿ごとのリアクションタイプ別の数を集計して表示 ✅ **2026年追加**
5. リアクションの取り消しができる
6. **専門家（獣医師など）がリアクションした場合**:
   - 投稿に「獣医師が推奨」などの特別なバッジが表示される
   - 専門家のリアクションは通常のリアクションとは区別される
   - おすすめフィードで優先的に表示される
```

---

## 4. 機能設計

### 4.1 Phase 1: 個人管理機能

#### 4.1.1 ユーザー管理
- ユーザー登録・ログイン（Clerk）
- プロフィール編集
- プレミアム会員登録

#### 4.1.2 ペット管理
- ペット登録
- ペット一覧表示
- ペットプロフィール編集
- ペット削除

#### 4.1.3 活動ログ
- 食事記録
- トイレ記録
- 散歩記録
- 日記投稿
- ケア記録
- タイムライン表示
- ログ編集・削除

#### 4.1.4 ダッシュボード
- 今日のサマリー
- 最近の活動ログ
- 統計情報（体重推移など）

#### 4.1.5 AI相談機能 ✅ **キラー機能**
- AIチャット（RAGベース）
- ペットのカルテ情報を活用した相談
- 信頼できる知識ベースからの回答生成
- 緊急度判定と病院案内
- 引用元の明示

---

### 4.4 AI相談機能（Phase 1後半 / Phase 2）✅ **キラー機能**

#### 4.4.1 システム構成

**目的**: 「信頼できるソースに基づいたAI相談」を実現し、単なる記録アプリから「ペットの命を守るパートナー」へと進化させる

**信頼性の担保方法**:
1. **ペットのカルテ（Context）**: `pets`テーブルと`activities`テーブルから、年齢・体重・既往歴や直近の食事・トイレ記録を読み込む
2. **信頼できる知識ベース（Knowledge Base）**: 獣医師監修のガイドラインや信頼できるQ&Aデータをベクトル化してConvexに保存
3. **専門家の検索（Triage）**: AIが「緊急性が高い」と判断した場合、近くの動物病院を案内

#### 4.4.2 RAG（Retrieval-Augmented Generation）アーキテクチャ

**処理フロー**:
```
1. ユーザーが質問を入力
2. ペットのカルテ情報を取得（pets, activities）
3. 質問をベクトル化して知識ベースを検索
4. 関連する知識を取得
5. カルテ情報 + 知識ベース + 質問をLLMに送信
6. 回答を生成（引用元も含む）
7. 回答をchat_messagesに保存
```

#### 4.4.3 機能詳細

**A. 「今の状態」に基づいた相談**
- 直近3日間のログを取得
- ペットのプロフィール（年齢、体重など）を確認
- 知識ベースから関連記事を検索
- 個別化された回答を生成

**B. 緊急度の判定と相談窓口への誘導**
- 知識ベースの「中毒物質リスト」と照合
- ペットの体重を考慮した危険度判定
- 緊急時は画面を警告色に変更
- 現在地周辺の救急対応可能な動物病院マップを表示（Google Maps API連携）

**C. 引用元の明示**
- 回答に使用した知識ベースの記事を引用
- `citedSources`フィールドに保存
- UIで引用元を表示

**D. 免責事項（ディスクレイマー）の表示** ✅ **信頼性と誠実さを担保**
- **表示タイミング**:
  1. **初回利用時のウェルカムメッセージ**: AI自身が自己紹介と共に「できないこと」を伝える
  2. **チャット画面のフッター**: メッセージ入力欄の下に常駐表示（控えめなサイズ）
  3. **回答ごとのインライン注釈**: 特定のキーワード（「病気」「薬」「症状」など）が含まれる回答の最後に自動表示
- **免責事項の種類**:
  - `general`: 一般的な免責事項（初回利用時など）
  - `medical`: 医療・健康に関する免責事項（症状、病気、治療など）
  - `food`: 食事・栄養に関する免責事項（フード、サプリメントなど）
  - `emergency`: 緊急時の免責事項（誤飲、事故など）
- **デザインの方向性**:
  - 警告色（赤）ではなく、薄い黄色やグレーなどの「親切な助言」として感じられる配色
  - ⚠️マークよりも、💡やℹ️マークを使用してアプリのトーン＆マナーに合わせる
- **システムプロンプトでの制御**:
  - AIに「医療的な診断を断定的に行わないこと」を指示
  - 「必ず獣医師への相談を推奨する一文を添えること」を指示
  - 誤った情報を提供する可能性があることを常に意識させる

#### 4.4.4 技術実装

**使用技術**:
- **OpenAI Embeddings API**: テキストのベクトル化（`text-embedding-3-small`）
- **OpenAI ChatCompletion API**: 回答生成（GPT-4o推奨）
- **Convex Vector Search**: ベクトル検索
- **Convex Actions**: 外部API呼び出し

**実装ステップ**:
1. **知識データの投入（Ingestion）**
   - 信頼できるデータ（PDF、Webサイト）をテキスト化
   - OpenAI Embedding APIでベクトル化
   - `knowledge_base`テーブルに保存

2. **回答生成アクション（Generation）**
   - `chat`アクションを作成
   - 引数: `petId`, `message`
   - 処理フロー:
     1. `pets`と直近の`activities`を取得
     2. `message`をベクトル化して`knowledge_base`を検索
     3. システムプロンプトに含めてOpenAI ChatCompletion APIを呼ぶ
     4. 結果を`chat_messages`に保存して返す

3. **UIへの反映**
   - チャット画面を作成
   - 通常の吹き出し表示
   - 「推奨アクション」をリッチなカードとして表示
   - 引用元の表示

#### 4.4.5 法的・安全上の注意点

**重要**: AIによる医療相談機能を作る際、**「診断（Diagnosis）」をしてはいけない**という法律（獣医師法など）の壁があります。

**対策**:
- **免責事項**: アプリの初回起動時に「このAI機能は情報提供のみを目的としており、獣医師の診断に代わるものではありません」という同意を得る
- **システムプロンプトでの制御**: AIに対して「あなたは獣医師ではありません。診断を下さず、あくまで一般的なアドバイスと受診の目安を提示してください」と強く指示
- **緊急時の案内**: 緊急度が高い場合は、必ず動物病院への受診を推奨

#### 4.4.6 使用例

**例1: 食欲不振の相談**
```
ユーザー: 「最近食欲がないみたい」

AIの処理:
1. 直近3日間のログを取得 → 「食事量：通常の50%」「嘔吐：あり」
2. ペットプロフィールを確認 → 「14歳、高齢犬」
3. 知識ベースから「高齢犬 食欲不振 嘔吐」を検索
4. 回答生成

AIの回答:
「ポチくん（14歳）の記録を見ると、昨日から食事量が半分に減っており、
今朝一度嘔吐の記録がありますね。高齢なので脱水症状が心配です。
一般的なガイドラインでは、高齢犬の食欲不振が24時間続く場合は受診が推奨されます。
歯茎が乾いていないか確認し、かかりつけ医への相談をお勧めします。」

引用元:
- 「高齢犬の健康管理ガイド」（獣医師監修）
- 「嘔吐時の対応方法」
```

**例2: 緊急時の相談**
```
ユーザー: 「チョコレートを食べてしまったかも」

AIの処理:
1. 知識ベースの「中毒物質リスト」と照合 → 危険度：高
2. ペットの体重を取得 → 3kg（少量でも致死的）
3. 緊急判定フラグを立てる

AIの回答（UI表示を変更）:
[警告画面を表示]
「⚠️ 緊急事態です！今すぐ病院へ！」

チョコレートは犬にとって非常に危険な物質です。
ポチくん（3kg）の場合、少量でも致死的な可能性があります。
すぐに動物病院を受診してください。

[現在地周辺の救急対応可能な動物病院マップを表示]
```

---

### 4.2 Phase 2: 家族・チーム管理機能

#### 4.2.1 共同管理
- 共同管理者の追加
- 権限設定（admin/editor/viewer）
- 共同管理者一覧表示
- 共同管理者の削除

#### 4.2.2 共有機能
- 共有ペット一覧の表示
- 共有ペットへのアクセス制御

---

### 4.3 Phase 3: SNS・商品データベース機能

#### 4.3.1 SNS機能

**概要**: 2026年版のモダンなSNS機能。XやThreadsのような「フォロー中（Following）」と「おすすめ（For You）」のタブ切り替えを実装。

##### A. タイムラインの2つのロジック

**① フォロー中（Following）**
- **ロジック**: 自分がフォローしている`userId`のリストを取得し、その人たちが投稿した`isPublic: true`の記事を、日付が新しい順に表示
- **実装**: Convexのインデックス機能を使って、フォローしているID群に合致する投稿を高速にスキャン
- **特徴**: Convexのリアルタイム更新により、フォローしている人が新しい投稿をすると、自動的にタイムラインに反映される

**② おすすめ（For You）**
- **ロジック**: 以下の要素をミックスして表示
  - **人気投稿**: 全体の「いいね数」が多いもの
  - **関連性**: 自分の飼っているペットと同じ種別の投稿
  - **波及効果**: フォローしている人が「いいね」した投稿（ネットワークが広がる）
- **実装**: Convexの`searchIndex`や、定期的に集計する「人気スコア」を利用
- **特徴**: AI（RAG）を活用した超パーソナライズも可能（後述）

##### B. UI/UX実装（Expo / Tamagui）

**タブ切り替えUI**:
- 画面上部にSegmented Controlを配置
- 2つのタブ: 「おすすめ」と「フォロー中」
- タブ切り替え時に、Convexの`query`関数を動的に切り替え

**実装例**:
```typescript
// ステート管理
const [feedType, setFeedType] = useState<"recommended" | "following">("recommended");

// データ取得（動的切り替え）
const feed = useQuery(
  feedType === "following"
    ? api.activities.getFollowingFeed
    : api.activities.getRecommendedFeed,
  { userId: currentUserId }
);
```

**UXの特徴**:
- タブ切り替えが即座に反映される（Convexのリアルタイム更新）
- スクロール位置を保持（タブ切り替え後も元の位置に戻れる）
- 無限スクロール対応

##### C. AI（RAG）を活用した超パーソナライズ ✅ **2026年版の先進機能**

**概要**: 単なる「いいね数順」ではなく、**「あなたのペットに役立つ投稿」**を最優先で表示

**例**:
- あなたが「ハスキー」を飼っている場合
- 他のハスキー飼い主が投稿した「夏場の温度管理日記」や「おすすめの冷却マット（商品リンク付き）」を、フォローしていなくても「おすすめ」のトップに表示

**仕組み**:
1. あなたのペット情報（種別、品種、年齢など）をベクトル化
2. 投稿内容（テキスト、タグ、種別など）をベクトル化
3. Convex Vector Searchで類似度を計算
4. 類似度が高い投稿を優先的に表示

**実装**:
- Convex Vector Searchを使用
- 投稿に`embedding`フィールドを追加（オプション）
- ユーザーのペット情報と投稿の類似度を計算

##### D. パフォーマンス最適化

**初期段階**:
- 「フォローしている人の投稿」と「全体の人気投稿」を単純に分けるだけで十分
- Convexのインデックスを活用して高速に取得

**スケール時**:
- Convexの`Action`を使って、バックグラウンドで「おすすめリスト」を事前に計算（キャッシュ）
- 人気スコアを定期的に更新
- ベクトル検索結果をキャッシュ

##### E. 機能詳細

- **グローバルフィード（公開日記）**: すべての公開投稿を時系列で表示
- **いいね機能**: 投稿へのいいね・いいね解除
- **フォロー機能**: ユーザーのフォロー・フォロー解除
- **コメント機能**: 将来拡張予定

#### 4.3.2 商品データベース
- 商品検索
- 商品詳細表示
- 商品登録（ユーザー投稿）
- 商品承認（運営）

#### 4.3.2.1 商品データ取得戦略 ✅ **2026年追加 - 初回シードとオンデマンド更新の分離**

**設計思想**: 初回用の一括データ蓄積（シード）と、運用時のオンデマンド更新を分離し、商品ごとに1日1回の更新制限を設けることで、APIコストとリスクを最小化します。

**1. 初回シード（一括データ蓄積）**
- **目的**: カテゴリごとに絞った定期実行による初期データ収集
- **実行タイミング**: 管理者の手動起動（カテゴリ別）
- **重複チェック**: ASINで重複チェック、既存商品は更新しない
- **実装**: `seedProductsByCategory` Action（カテゴリごとに最大100件まで取得、10件ずつバッチ処理）
- **API制限の遵守**: 1秒待機を挟みながら、10件ずつまとめて詳細情報を取得

**2. オンデマンド更新（1日1回制限）**
- **目的**: ユーザーが商品詳細を開いた際、24時間以上経過している場合のみ更新
- **実行タイミング**: ユーザーが詳細画面を開いた時
- **更新対象**: 24時間以上経過した商品のみ（価格・在庫・評価のみ更新、画像や説明は変更されないため）
- **実装**: `getProductDetail` Query（即座にDB値を返し、裏側で`updateProductFromApi` Actionをスケジュール）
- **パターン**: Stale-While-Revalidate（SWR）パターンで、ユーザーを待たせずに裏側で更新

**3. 定期Cronジョブ（優先度付き更新）**
- **目的**: 閲覧数の多い商品を優先的に更新
- **実行タイミング**: 毎日深夜2時（JST）
- **更新対象**: 過去3日間に閲覧された商品（優先度: 高）、最大100件まで
- **実装**: `updatePopularProductsBatch` Action（10件ずつまとめて更新、API制限を守るため1秒待機）

**4. データ取得戦略のまとめ**

| 機能 | 実行タイミング | 更新対象 | 重複チェック |
|------|---------------|---------|------------|
| **初回シード** | 管理者の手動起動（カテゴリ別） | 新規商品のみ | ASINで重複チェック、既存商品は更新しない |
| **オンデマンド更新** | ユーザーが詳細を開いた時 | 24時間以上経過した商品のみ | `lastUpdatedAt`で判定、1日1回制限 |
| **定期Cron更新** | 毎日深夜2時 | 閲覧数の多い商品（過去3日間） | `lastUpdatedAt`で判定、1日1回制限 |

**設計のポイント**:
- **重複更新の防止**: 初回シードでは既存商品を更新しない、オンデマンド更新では24時間以内の更新をスキップ
- **APIコストの最小化**: バッチ処理（10件ずつ）とレート制限の遵守（1秒待機）
- **ユーザー体験の最適化**: Stale-While-Revalidateパターンで、即座にDB値を返し、裏側で更新
- **エラー耐性**: APIエラー時は`lastUpdatedAt`を更新せず、30分後に再試行

#### 4.3.3 レビュー機能
- レビュー投稿
- レビュー一覧表示
- 種別ごとの商品人気ランキング
- レビュー統計

---

### 4.5 コラム・記事機能（Phase 1後半 / Phase 2）✅ **信頼性向上・フック機能**

#### 4.5.1 概要

**目的**: 専門家による信頼できる一次ソースに特化したコラム・記事機能。アプリの信頼性を高め、ユーザーが毎日アプリを開く強力な動機（フック）を提供。

**特徴**:
- 管理者・認定専門家のみが投稿可能
- 一次ソースの明示による信頼性の担保
- ペット種別に合わせたレコメンデーション
- 情報の不確かなSNSとの差別化

#### 4.5.2 段階的な拡張プラン

**フェーズ1: 管理者（運営）による配信**
- 運営が信頼できるソースを元に記事を作成・公開
- Convex Dashboardまたはアプリ内の管理者用投稿ページから投稿
- ユーザーの飼っているペットの種類に合わせたコラムをホーム画面にレコメンド

**フェーズ2: 獣医師・専門家の登録と認証**
- 事業者ユーザーの中から、免許証などの確認が取れた人を「認定獣医師」フラグで管理
- 有料機能として、獣医師が「自分のクリニックの宣伝」としてコラムを書く権利をサブスクリプションで販売
- 一部有料コラムの仕組みを導入

#### 4.5.3 AIを活用したコンテンツ作成補助

**執筆サポートツール**:
- 信頼できる医学論文のURLを渡すと、その内容を要約し、初心者向けの分かりやすいコラムの下書きをMarkdownで生成
- 構成は「結論、理由、具体的な対策」に自動フォーマット
- 一次ソースの自動チェック（厚生労働省や獣医師会のガイドラインとの矛盾チェック）

**AIへの指示例**:
```
「信頼できる医学論文のURLを渡すので、その内容を要約し、
『初めて猫を飼う人向け』の分かりやすいコラムの下書きをMarkdownで生成して。
構成は『結論、理由、具体的な対策』にして。」
```

#### 4.5.4 住環境シミュレーター（発展アイデア）

**機能概要**:
- ペットの種別と、部屋の広さ・設備を入力すると、AIが改善点をアドバイスする診断機能

**使用例**:
- 「シベリアンハスキーを6畳の部屋で飼う場合」
- → 「運動量不足と温度管理のリスク」を指摘
- → 推奨されるエアコン設定や近隣のドッグランを提案

#### 4.5.5 機能詳細

**A. コラム一覧表示**
- 公開済みのコラムを一覧表示
- 種別でフィルタリング
- タグでフィルタリング
- 新しい順・人気順でソート

**B. コラム詳細表示**
- タイトル、本文、アイキャッチ画像
- 一次ソースのリンク表示
- 著者情報（専門家の場合）
- 関連コラムのレコメンデーション

**C. レコメンデーション**
- ユーザーが飼っているペットの種別に合わせたコラムをホーム画面に表示
- 「あなたにおすすめ」セクション

**D. 管理者用投稿機能**
- コラムの作成・編集・削除
- 下書き保存
- 公開・非公開の切り替え
- 一次ソースの追加

---

## 5. 画面設計（Phase 1）

### 5.1 認証画面
- ログイン画面
- サインアップ画面

### 5.2 ホーム画面
- ペット一覧
- 今日のサマリー
- クイックアクション（記録ボタン）
- **コラムレコメンドセクション** ✅ **フック機能**
  - 「あなたにおすすめ」コラム表示
  - 飼っているペットの種別に合わせたコラム
  - 新しいコラムの通知

### 5.3 ペット詳細画面
- プロフィール情報
- タイムライン
  - **広告表示（無料ユーザー）** ✅ **2026年追加 - さりげない広告配置**
    - 日記タイムラインの合間: 日記の3枚〜5枚ごとに1つ、日記と同じデザインのカード（「Sponsored」と表記）として表示
    - プレミアムユーザー: 広告の代わりに「過去の同じ日の思い出（1年前の今日）」などのパーソナライズされたコンテンツが表示される
  - **タイムラインビューの拡張機能** ✅ **2026年追加 - フィルター・リマインダー完了状況**
    - **ペットでの絞り込みUI** ✅ **2026年追加**
      - 画面上部にペット選択UI（Segmented Controlまたはドロップダウン）を配置
      - 複数ペットを飼っている場合、各ペットのタブを表示
      - 「すべて」タブを選択すると、すべてのペットの記録を時系列で統合表示
    - **記録タイプでのフィルターUI** ✅ **2026年追加**
      - フィルターボタン（チップ形式）を画面上部に配置
      - 記録タイプ: 「日記」「トイレ」「餌」「散歩」「ケア」など
      - 複数選択可能（チェックボックス形式）
      - フィルター適用中は、選択したタイプの記録のみを時系列で表示
    - **リマインダー完了状況の表示** ✅ **2026年追加**
      - リマインダーの完了記録（`reminder_logs`）をタイムラインに統合
      - 完了したリマインダー: 「✅ [リマインダー名] 完了」として表示
      - 未完了のリマインダー: 「⏰ [リマインダー名] 未完了」として表示（予定日時が過ぎている場合）
      - リマインダーカードをタップすると、リマインダー詳細画面に遷移
    - **詳細画面への遷移と戻る機能** ✅ **2026年追加**
      - 各記録カードをタップすると、記録タイプに応じた詳細画面に遷移
        - 活動ログ: 活動ログ詳細画面
        - リマインダー完了記録: リマインダー詳細画面
      - 詳細画面のヘッダーに「戻る」ボタンを配置
      - 戻る際に、元のスクロール位置とフィルター設定を保持
      - React Navigationのスタックナビゲーションを使用
- 統計情報

### 5.4 記録画面
- **食事記録** ✅ **2026年更新 - 前回入力内容の保持**
  - 前回の入力内容を自動的に表示（商品名、量）✅ **2026年追加**
  - 前回の記録がない場合のみ、手動で入力
  - 前回の内容をそのまま使用する場合は、確認して記録ボタンをタップするだけ
  - 前回の内容を変更する場合は、商品名や量を編集してから記録
  - 前回の記録から一定期間（例: 7日）経過した場合は、デフォルト値として使用しない
  - 商品選択（商品データベースから選択、または新規登録）
  - 量の入力（g単位）
  - 写真の添付（オプション）
  - メモの入力（オプション）
- **トイレ記録** ✅ **2026年更新 - 種別ごとの最適化された選択肢**
  - **動的UI表示**: ペットの種別を判定し、該当する選択肢のみを表示 ✅ **2026年追加**
    - 犬・猫: 便の状態、尿の状態の選択肢を表示
    - 鳥類・爬虫類: 排泄物の色、尿酸の状態、水分量の選択肢を表示
    - うさぎ・ハムスター: フンの数・大きさ、盲腸便の選択肢を表示
  - **全種共通の基本的な状態** ✅ **2026年追加**
    - ⭕️ 絶好調 / ⚠️ いつもと違う / ❌ 異常あり
  - **犬・猫: 消化器・泌尿器フォーカス** ✅ **2026年追加**
    - 💩 便の状態: カチカチ / ちょうど良い / 柔らかめ / 泥状 / 水状 / 血便あり / 異物混入
    - 💧 尿の状態: 回数/量（少ない/普通/多い）、色（薄い/普通/濃い/血尿）
  - **鳥類・爬虫類: 尿酸と排泄物の色** ✅ **2026年追加**
    - 📊 排泄物の構成: 便の色（緑色/茶色/黒色）、尿酸（正常/黄色・緑色/固形・ザラザラ）、水分量（正常/多尿）
  - **うさぎ・ハムスター: 数と大きさ、盲腸便** ✅ **2026年追加**
    - 💩 フンの状態: 大きいフンがたっぷり / 小さいフン / 数が少ない
    - 盲腸便（うさぎ限定）: 正常（自分で食べた）/ 食べ残しあり / 連結（毛で繋がったフン）
  - **清掃アクション（全種共通）** ✅ **2026年追加**
    - トイレ掃除（部分）/ シート/砂の全交換 / ケージ/水槽の丸洗い / 水換え
    - 清掃アクション実行時にポイントが付与される
  - **前回の記録の表示** ✅ **2026年追加**
    - 選択肢の横に「昨日は『柔らかめ』だった」という前回の記録を小さく表示
    - 前回の記録と比較しやすくする
  - トイレタイプ（おしっこ/うんち）をワンタップで選択
  - 写真の添付（オプション）
  - メモの入力（オプション）
  - 異常な状態を記録した場合、AI相談への導線を表示
- **リマインダー設定画面** ✅ **2026年追加 - 掃除のタイマー・リマインダー**
  - **ペットの種類に応じたおすすめリマインダーの表示** ✅ **2026年追加**
    - 犬: 足拭きタオルの洗濯、歯磨き、ブラッシング、ケージ消毒
    - 猫: 猫砂の全換水、フィルター掃除（給水器）、爪とぎ交換
    - 鳥: 敷紙の交換、止まり木の洗浄、日光浴、水浴び
    - 爬虫類: 温浴、シェルター洗浄、床材の全交換、霧吹き（加湿）
    - うさぎ: 牧草入れの清掃、グルーミング、すのこ洗浄
    - ハムスター: 巣材の交換、回し車の洗浄、砂浴び場の掃除
  - **カスタムリマインダーの設定** ✅ **2026年追加**
    - 名称をテキストで自由入力
    - アイコンを選択
    - プリセットにない特殊なケアにも対応
  - **頻度の設定** ✅ **2026年追加**
    - 毎日 / 毎週（曜日選択）/ 隔週 / 毎月（日付指定）/ 間隔指定（例: 3日おき）
    - カレンダー感覚で頻度をタップするだけの直感的なフォーム
  - **時間の設定** ✅ **2026年追加**
    - ユーザーが反応しやすい夜間や週末の朝などを自由に設定
  - **完了条件の選択** ✅ **2026年追加**
    - チェックのみ / 写真撮影を必須（オプション）
- **リマインダー通知と完了画面** ✅ **2026年追加**
  - **Push通知** ✅ **2026年追加**
    - 設定された時間に「[ペット名] の [リマインダー名] の時間です」という通知が送信される
    - 通知から直接「完了」ボタンを押せる（クイックアクション）
  - **「今日のやること」リスト** ✅ **2026年追加**
    - トップ画面に「今日のやること」リストが表示される
    - リストからワンタップで完了できる
  - **完了記録** ✅ **2026年追加**
    - 完了時にポイントが付与される
    - 完了記録がタイムラインに表示される（「〇〇の掃除を完了しました！」）
    - トイレ記録などから自動完了（リマインダーを待たずに「掃除した」にチェックを入れた場合、その日のリマインダーを自動的に「完了」扱い）
  - **サンクス画面の広告表示（無料ユーザー）** ✅ **2026年追加 - さりげない広告配置**
    - 掃除や給餌の記録が終わった後の「お疲れ様！」という画面の隅に、控えめなバッジ型広告を表示
    - プレミアムユーザー: 広告は表示されない
- 散歩記録
- 日記投稿
- ケア記録

### 5.5 AI相談画面
- チャットスレッド一覧
- チャット画面
  - メッセージ履歴表示
  - 入力欄
  - 引用元表示
  - 推奨アクションカード
  - 緊急時の警告表示
  - 病院マップ表示（緊急時）

### 5.6 コラム画面
- コラム一覧画面
  - 種別フィルター
  - タグフィルター
  - ソート機能（新しい順・人気順）
  - **広告表示（無料ユーザー）** ✅ **2026年追加 - さりげない広告配置**
    - 管理者厳選記事の中に、外部広告を1つ混ぜる（記事と同じデザインのカードとして表示）
    - プレミアムユーザー: 広告は表示されない
- コラム詳細画面
  - タイトル、本文（Markdown表示）
  - アイキャッチ画像
  - 一次ソースリンク
  - 著者情報
  - 関連コラム
  - **コラムの末尾にAIへの質問ボタン**（例：熱中症のコラムの最後に「うちの子の今の体調を相談する」ボタン）✅ **キラー機能とフック機能の連動**
  - AI相談ボタンをタップすると、コラムの内容をコンテキストとして含めた状態でAI相談画面が開く
  - 記事の重要ポイントがハイライト表示される
  - 「後で読む」機能
- ホーム画面のレコメンドセクション
  - 「あなたにおすすめ」コラム表示

### 5.7 管理者用画面（運営）
- コラム投稿画面
  - タイトル、本文入力（Markdownエディタ）
  - 対象種別選択
  - タグ入力
  - 一次ソース追加
  - プレビュー機能
  - 下書き保存・公開
- AI執筆サポート画面
  - 論文URL入力
  - 対象読者指定
  - 下書き生成
- **商品一覧・詳細閲覧画面** ✅ **2026年追加**
  - 商品一覧画面
    - 商品一覧の表示（ページネーション対応）
    - カテゴリフィルター（food/toy/litter/accessoryなど）
    - 検索機能（商品名、ブランド、製造会社）
    - 承認状態フィルター（isVerified: true/false）
    - ソート機能（新着順、閲覧数順、レビュー数順）
  - 商品詳細画面
    - 基本情報セクション（商品名、カテゴリ、ブランド、製造会社、説明）
    - アソシエイトAPI情報セクション（APIソース、商品ID、取得日時、APIステータス、データ取得状況）
    - 価格情報セクション（現在価格、定価、割引率、通貨、在庫状況）
    - 評価情報セクション（Amazon評価、レビュー数、アプリ内評価、レビュー数）
    - ペットフード専用情報セクション（成分表、栄養成分、対象種別、対象ライフステージ、パッケージサイズ、カロリー）
    - 画像セクション（商品画像の表示）
    - アフィリエイトリンクセクション（Amazon/楽天へのリンク）
    - 統計情報セクション（閲覧数、最終閲覧日時、最終更新日時）
    - レビュー一覧セクション（商品のレビュー一覧）
    - 承認状態表示（承認待ち/承認済み）
- **商品カテゴリの優先順位** ✅ **2026年追加 - 段階的展開**
  - **Phase 1（最優先）**: ペットの餌（food）
  - **Phase 2（次優先）**: ペットのトイレ用品（litter）
  - **Phase 3（その他）**: その他の用品（toy, cage, accessory, insuranceなど）

### 5.9 SNSフィード画面（Phase 3）✅ **2026年版モダンSNS**
- フィード画面
  - 画面上部にSegmented Control（「おすすめ」「フォロー中」タブ）
  - 「おすすめ」タブ: 人気投稿、関連性の高い投稿、フォローしている人がいいねした投稿をミックス
  - 「フォロー中」タブ: フォローしているユーザーの公開投稿を時系列で表示
  - 無限スクロール対応
  - リアルタイム更新（Convex）
- 投稿カード
  - 投稿者情報（プロフィール画像、名前）
  - 投稿内容（テキスト、写真）
  - いいねボタン・いいね数
  - **専門家が「いいね」した投稿には「獣医師が推奨」バッジが表示される**
  - **信頼できる飼い主の証バッジ**（一定期間以上記録を続けているユーザー、専門家から「いいね」を受けたユーザー）
  - 投稿日時
  - ペット情報（種別、品種）

### 5.10 設定画面
- ユーザー設定
- ペット設定
- アプリ設定
- AI相談の免責事項同意
- **プレミアム移行への導線** ✅ **2026年追加 - 広告表示機能**
  - 広告の下に小さく「プレミアムなら広告なしで、もっとサクサク記録できます」という文字を添え、ワンタップでプラン比較画面へ
  - 設定画面にも「広告なしで快適に利用する」というオプションからプレミアムプラン比較画面へ導線を設置

### 5.11 公式サイト（Next.js + Vercel）✅ **2026年追加 - SEO・LLMフレンドリーな公式サイト**

#### 5.11.1 ブランド戦略：公式サイトの役割 ✅ **2026年追加**
公式サイトは、単なる「機能の説明」ではなく、**「このアプリがある生活がいかに安心で、温かいか」**をブランドとして伝える聖域です。

- **アプリ**: 「実用的な道具」
- **公式サイト**: 「ペットと飼い主が紡ぐ物語のショーケース」

#### 5.11.2 ビジュアル・アイデンティティ：幸福の想起 ✅ **2026年追加**
「清潔感（信頼）」と「体温（幸福）」の共存を目指します。

- **メインビジュアル（ヒーローセクション）**:
  - 構図：スマートフォンの中でアプリを操作する手元と、その奥でリラックスして眠るペットの「ボケ感」を活かした写真
  - メッセージ：「記録は、愛した証。」のような、情緒的で短いコピーを配置
- **カラーパレット**:
  - アプリのベースカラー（例：柔らかなベージュやパステルブルー）を使いつつ、ウェブでは**「余白（ホワイトスペース）」**をアプリの1.5倍広く取り、情報の呼吸を助ける
- **タイポグラフィ**:
  - 見出しには少し丸みのある、親しみやすいフォントを採用
  - ただし、信頼性を損なわないよう、本文は可読性の高い明朝体やクリーンなゴシック体を使い分ける

#### 5.11.3 UIコンポーネントの共通化と拡張 ✅ **2026年追加 - モノレポ活用**
モノレポでアプリとUIライブラリを共有する利点を最大化します。

- **インタラクティブ・デモ**:
  - アプリで使っている「トイレ記録の選択肢」や「動くフレーム」のUIコンポーネントを、ウェブ上で擬似的に操作できるセクションを設ける
  - ユーザーがクリックすると、バッジが光ったりフレームが動いたりする演出をNext.jsで見せることで、DL前の「手触り感」を伝える
  - `packages/ui`のコンポーネントをウェブ用に拡張して使用
- **カードデザインの共通化**:
  - アプリ内の「日記カード」のデザインをウェブの「ニュース」や「ギャラリー」でも流用
  - `packages/ui`のコンポーネントを共有し、アプリと公式サイトで一貫したデザインを実現

#### 5.11.4 ストーリーテリング型のコンテンツ構成 ✅ **2026年追加**
上から下へスクロールするだけで、不安が解消され、期待感が高まる構成にします。

- **Empathy（共感）セクション**:
  - 「今日、何回トイレに行ったっけ？」「この子の小さな変化、見逃したくない。」という飼い主の不安に寄り添う
  - 飼い主の悩みを可視化し、共感を生む
- **Solution（解決）セクション**:
  - アプリの機能（種類別記録、リマインダー）を、実際の操作画面アニメーションで提示
  - インタラクティブ・デモを活用し、機能の価値を実感できる
- **Future（未来）セクション**:
  - 「虹の橋」や「アルバム」の機能を見せ、このアプリが一生（あるいは一生を超えて）寄り添う存在であることを提示
  - ペットとの長期的な関係をイメージさせる
- **Social Proof（信頼）セクション**:
  - バッジを付けた誇らしいペットたちのギャラリーや、最新のアップデートニュース
  - アプリの成長とコミュニティの活発さを示す

#### 5.11.5 トップページ ✅ **2026年追加**
- **メインビジュアル（ヒーローセクション）**:
  - 構図：スマートフォンの中でアプリを操作する手元と、その奥でリラックスして眠るペットの「ボケ感」を活かした写真
  - メッセージ：「記録は、愛した証。」のような、情緒的で短いコピーを配置
- **ストーリーテリング型のコンテンツ構成**:
  - Empathy（共感）、Solution（解決）、Future（未来）、Social Proof（信頼）のセクションを配置
- ダウンロードボタン（App Store / Google Play）をヘッダーと各セクションに配置
- 主要機能の概要を視覚的に分かりやすく表示
- SEO最適化：適切なメタタグ、OGPタグ、構造化データ（JSON-LD）を設定
- LLMフレンドリー：Semantic HTML（article, section, navなど）を正しく使用

#### 5.11.6 機能詳細ページ ✅ **2026年追加**
- 各機能ごとに個別のLP（ランディングページ）として詳しく解説
- **機能ごとの専用サブページ** ✅ **2026年追加 - SEO・LLM最適化**:
  - `features/cat-toilet`、`features/reptile-care`のように、ペット種別ごとのランディングページを生成
  - 専門性の高いSEOキーワード（バーティカルSEO）として機能
  - 各ページに適切なメタタグと構造化データを設定
- 検索キーワード対策：例「レオパ 餌 記録 アプリ」など、種別ごとのキーワードに対応
- 機能のスクリーンショットや動画を表示
- **インタラクティブ・デモ** ✅ **2026年追加 - UIコンポーネントの共通化**:
  - アプリで使っている「トイレ記録の選択肢」や「動くフレーム」のUIコンポーネントを、ウェブ上で擬似的に操作できるセクションを設ける
  - ユーザーがクリックすると、バッジが光ったりフレームが動いたりする演出をNext.jsで見せることで、DL前の「手触り感」を伝える
- SEO最適化：各機能ページに適切なメタタグと構造化データを設定

#### 5.11.7 ニュース・更新情報ページ ✅ **2026年追加**
- ニュース一覧を時系列で表示（新しい順）
- 各ニュースにカテゴリ（機能追加、バグ修正、お知らせなど）を表示
- ニュースの公開日時を表示
- ニュース詳細ページでタイトル、本文、関連画像を表示
- SEO最適化：ニュースページに適切なメタタグと構造化データを設定
- **自動更新** ✅ **2026年追加 - モノレポ運用**:
  - Convexの`news`テーブルを更新すると、VercelのOn-demand ISR（Incremental Static Regeneration）により、公式サイトのニュース一覧が瞬時に（かつ静的ファイルとして高速に）更新される

#### 5.11.8 法務ドキュメントページ ✅ **2026年追加**
- プライバシーポリシー、利用規約、特定商取引法表記などを表示
- 改定日時とバージョンを表示
- 改定履歴を表示
- SEO最適化：適切なメタタグを設定
- **一元管理** ✅ **2026年追加 - モノレポ運用**:
  - `packages/policy/`にMarkdownファイルを置き、アプリの「設定 > 規約」と、公式サイトの「フッター > 規約」が常に同じファイルを読み込むようにビルド設定
  - 法務ドキュメントの更新が、アプリと公式サイトの両方に即座に反映される

#### 5.11.9 アプリダウンロードページ ✅ **2026年追加**
- App StoreとGoogle Playへのリンクを表示
- デバイス検出：iOS/Androidに応じて適切なストアに誘導
- ダウンロードボタンを目立つ位置に配置

#### 5.11.10 FAQセクション ✅ **2026年追加 - SEO・LLM最適化**
- 「猫の多飲多尿を記録するには？」「爬虫類の掃除頻度は？」といった具体的な悩みへの回答をFAQ形式で配置
- FAQPageの構造化データ（JSON-LD）を付与
- SEO最適化：各FAQに適切なメタタグを設定
- LLMフレンドリー：FAQの内容を構造化された形式で記述
- 検索キーワード対策：具体的な悩みをキーワードとして含める

#### 5.11.11 グローバル公開データのギャラリー（将来機能）✅ **2026年追加**
- 公開設定されているペットのバッジやアルバムを一覧表示
- 種別ごとにフィルタリング可能
- 個別ページ（/pets/[id]）で詳細を表示
- OGPタグ：SNS共有時に適切なプレビューが表示される

#### 5.11.12 SEO最適化 ✅ **2026年追加**
- sitemap.xmlの自動生成
- robots.txtの設定
- 適切なメタタグ（title, description, keywords）の設定
- OGPタグの設定
- 構造化データ（JSON-LD）の設定

#### 5.11.13 LLMフレンドリーな構成 ✅ **2026年追加**
- Semantic HTML（article, section, navなど）の使用
- 構造化データ（JSON-LD）の設定
- API Route（/api/ai-info）でアプリの機能一覧や最新ニュースをJSON形式で提供
- FAQセクションの構造化（FAQPageの構造化データ）

---

## 6. API設計（Convex Functions）

### 6.1 Users関連
- `storeUser`: ユーザー作成・更新
- `getCurrentUser`: 現在のユーザー取得
- `updateUser`: ユーザー情報更新

### 6.2 Pets関連
- `createPet`: ペット作成
- `getPetsByOwner`: 所有者のペット一覧取得
- `getPetById`: ペット詳細取得
- `updatePet`: ペット情報更新
- `deletePet`: ペット削除
- `searchPets`: ペット検索（種別・品種）

### 6.3 Activities関連
- `createActivity`: 活動ログ作成
- `getActivitiesByPet`: ペットの活動ログ取得
- `getTimeline`: タイムライン取得
  - **拡張機能** ✅ **2026年追加 - フィルター・リマインダー完了状況**
    - `petId`パラメータ: 特定のペットで絞り込み（`undefined`の場合はすべてのペット）
    - `types`パラメータ: 記録タイプの配列でフィルター（例: `["food", "toilet", "diary"]`）
    - `includeReminders`パラメータ: リマインダー完了記録を含めるかどうか（デフォルト: `true`）
    - 返り値: 活動ログとリマインダー完了記録を時系列で統合した配列
- `getTimelineWithFilters`: フィルター付きタイムライン取得 ✅ **2026年追加**
  - ペットID、記録タイプ、日付範囲でフィルター可能
  - リマインダー完了記録を含めるかどうかを指定可能
  - ページネーション対応（`limit`、`cursor`パラメータ）
- **日記フィルタリング** ✅ **2026年追加 - 日記の検索性向上**
  - `getDiaryActivitiesWithFilters`: 日記をシーン、感情、時間帯、場所でフィルタリング
    - `scenes`パラメータ: シーンIDの配列（複数選択可能）
    - `emotion`パラメータ: 感情ID
    - `timeOfDay`パラメータ: 時間帯（"morning", "noon", "evening", "night", "midnight"）
    - `location`パラメータ: 場所（"home", "park", "dog_run", "clinic", "travel"）
    - 複数のフィルターを組み合わせて検索可能
    - ページネーション対応
- `updateActivity`: 活動ログ更新
- `deleteActivity`: 活動ログ削除
- `getLastFeedingActivity`: 前回の食事記録を取得（食事記録画面のデフォルト値用）✅ **2026年追加**
  - 指定されたペットの最新の食事記録（type: "food"）を取得
  - 一定期間（例: 7日）以内の記録のみを返す
  - 商品ID、量、商品名などの情報を含む
- `getLastToiletActivity`: 前回のトイレ記録を取得（トイレ記録画面のデフォルト値用）✅ **2026年追加**
  - 指定されたペットの最新のトイレ記録（type: "toilet"）を取得
  - 一定期間（例: 7日）以内の記録のみを返す
  - 種別ごとの詳細な状態情報を含む

### 6.3.1 マスターデータ関連 ✅ **2026年追加 - 種別ごとの選択肢**
- `getToiletConditionMasters`: トイレ記録用の選択肢マスターデータを取得
  - ペットの種別を指定して、該当する選択肢のみを取得
  - カテゴリ（general_condition, stool_condition, urine_conditionなど）でフィルタリング可能
  - 表示順序でソート済み
- `getCleaningActionMasters`: 清掃アクションのマスターデータを取得
  - ペットの種別を指定して、該当するアクションのみを取得
  - 表示順序でソート済み
- **日記関連マスターデータ** ✅ **2026年追加 - 日記の簡単記録**
  - `getDiaryScenes`: 日記シーンマスターデータを取得
    - 有効なシーンのみを取得
    - 表示順序でソート済み
    - アイコンとシーン名を含む
  - `getDiaryEmotions`: 日記感情マスターデータを取得
    - 有効な感情のみを取得
    - 表示順序でソート済み
    - 顔文字アイコンと感情名を含む
  - `getContextStamps`: コンテキストスタンプマスターデータを取得
    - 有効なスタンプのみを取得
    - 表示順序でソート済み
    - シーンIDの配列と感情IDを含む
  - `getReactionTypes`: リアクションタイプマスターデータを取得
    - 有効なリアクションタイプのみを取得
    - 表示順序でソート済み
    - 絵文字アイコンとリアクション名を含む

### 6.3.2 リマインダー関連 ✅ **2026年追加 - 掃除のタイマー・リマインダー**
- `getReminderCategoryMasters`: リマインダーカテゴリのマスターデータを取得
  - ペットの種別を指定して、該当するカテゴリのみを取得
  - おすすめのリマインダーを表示するために使用
  - 表示順序でソート済み
- `createReminder`: リマインダーを作成
  - カテゴリIDまたはカスタムタイトルを指定
  - スケジュール（頻度、時間）を設定
  - 完了条件とポイントを設定
  - 次回の通知日時を自動計算
- `updateReminder`: リマインダーを更新
  - スケジュール、完了条件、ポイントなどを更新
  - 次回の通知日時を再計算
- `deleteReminder`: リマインダーを削除（論理削除）
- `getRemindersByPet`: ペットのリマインダー一覧を取得
  - 有効/無効でフィルタリング可能
- `getTodayReminders`: 今日のリマインダー一覧を取得（「今日のやること」リスト用）
  - 次回の通知日時が今日のリマインダーのみを取得
- `completeReminder`: リマインダーを完了
  - 完了履歴（reminder_logs）を作成
  - ポイントを付与
  - 次回の通知日時を再計算
  - トイレ記録などから自動完了した場合、relatedActivityIdを設定
- `getReminderLogsForTimeline`: タイムライン統合用のリマインダー完了記録取得 ✅ **2026年追加**
  - 指定されたペットのリマインダー完了記録を取得
  - 日付範囲でフィルタリング可能（`startDate`、`endDate`パラメータ）
  - 活動ログと統合しやすい形式で返す（`loggedAt`、`type: "reminder"`など）
  - 未完了のリマインダーも含めるかどうかを指定可能（`includeIncomplete`パラメータ）
  - 返り値: `{ id, type: "reminder", loggedAt, reminderId, reminderTitle, completedAt, isCompleted }`形式の配列
- `calculateNextNotificationAt`: 次回の通知日時を計算（内部関数）
  - 頻度（daily, weekly, biweekly, monthly, interval）に基づいて計算
  - RRULE準拠のスケジュール計算

### 6.4 Pet Members関連（Phase 2）
- `addPetMember`: 共同管理者追加
- `getPetMembers`: 共同管理者一覧取得
- `updatePetMemberRole`: 権限更新
- `removePetMember`: 共同管理者削除
- `getPetsByMember`: 自分が管理できるペット一覧取得

### 6.5 Products関連（Phase 3）
- `createProduct`: 商品作成
- `searchProducts`: 商品検索
- `getProductById`: 商品詳細取得
- `getProductDetail`: 商品詳細取得（オンデマンド更新付き）✅ **2026年追加**
- `verifyProduct`: 商品承認（運営）
- `seedProductsByCategory`: カテゴリごとの商品一括登録（初回シード用）✅ **2026年追加**
- `updateProductFromApi`: 商品をAPIから更新（オンデマンド更新用）✅ **2026年追加**
- `updatePopularProductsBatch`: 閲覧数の多い商品をバッチ更新（Cron用）✅ **2026年追加**
- **管理画面用** ✅ **2026年追加**:
  - `getProductsForAdmin`: 管理画面用の商品一覧取得（検索・フィルタリング・ページネーション対応）
  - `getProductDetailForAdmin`: 管理画面用の商品詳細取得（全情報を含む）

### 6.6 Reviews関連（Phase 3）
- `createReview`: レビュー作成
- `getReviewsByProduct`: 商品のレビュー一覧取得
- `getPopularProductsBySpecies`: 種別ごとの人気商品取得

### 6.7 AI相談関連（Phase 1後半 / Phase 2）
- `createChatThread`: チャットスレッド作成
- `getChatThreads`: チャットスレッド一覧取得
- `getChatMessages`: メッセージ一覧取得
- `chat`: AI相談アクション（Action）
  - ペットのカルテ情報を取得
  - 質問をベクトル化して知識ベースを検索
  - OpenAI APIで回答生成
  - メッセージを保存
- `searchKnowledgeBase`: 知識ベース検索（内部用）
- `embedText`: テキストのベクトル化（内部用Action）

### 6.8 知識ベース管理（運営用）
- `createKnowledge`: 知識ベース作成
- `updateKnowledge`: 知識ベース更新
- `deleteKnowledge`: 知識ベース削除
- `ingestDocument`: ドキュメントの取り込み（PDF等からテキスト抽出→ベクトル化→保存）

### 6.9 コラム・記事関連（Phase 1後半 / Phase 2）
- `getArticles`: コラム一覧取得（公開済み）
- `getArticleById`: コラム詳細取得
- `getRecommendedArticles`: レコメンドコラム取得（種別ベース）
- `searchArticles`: コラム検索（全文検索）
- `createArticle`: コラム作成（管理者・専門家のみ）
- `updateArticle`: コラム更新（管理者・専門家のみ）
- `deleteArticle`: コラム削除（管理者・専門家のみ）
- `publishArticle`: コラム公開（管理者・専門家のみ）

### 6.10 AI執筆サポート（運営用）
- `generateArticleDraft`: AIでコラムの下書きを生成（Action）
  - 医学論文のURLを入力
  - 対象読者を指定（例：「初めて猫を飼う人向け」）
  - Markdown形式の下書きを生成
- `validateArticle`: 記事の信頼性チェック（Action）
  - 厚生労働省や獣医師会のガイドラインとの矛盾チェック

### 6.11 SNS機能関連（Phase 3）
- `getFollowingFeed`: フォロー中フィード取得
  - フォローしているユーザーの公開投稿を時系列で取得
  - リアルタイム更新対応
- `getRecommendedFeed`: おすすめフィード取得
  - 人気投稿、関連性、波及効果をミックスして取得
  - オプション: AIパーソナライズ（ベクトル検索）
- `followUser`: ユーザーをフォロー
- `unfollowUser`: ユーザーのフォロー解除
- `getFollowingList`: フォローしているユーザー一覧取得
- `getFollowersList`: フォロワー一覧取得
- `likeActivity`: 投稿にいいね
- `unlikeActivity`: いいね解除
- `getLikesByActivity`: 投稿のいいね一覧取得
- `checkLikeStatus`: ユーザーがいいねしたかどうか確認

### 6.12 データライフサイクル管理（Cronジョブ）✅ **2026年最終設計検証で追加**
- `deleteExpiredData`: 期限切れデータの物理削除（Cronジョブ）
  - `restorableUntil`を過ぎたデータを自動で物理削除
  - 関連する画像ストレージも同時に削除
  - 毎日午前3時に実行
- `permanentDeleteAccount`: 退会後のデータ完全削除
  - 退会後30日経過で画像ストレージからも完全に削除（GDPR等の法的要件対応）
  - ユーザーのすべてのデータ（ペット、活動ログ、画像）を削除

### 6.13 リマインダー通知管理（Cronジョブ）✅ **2026年追加 - Push通知の送信**
- `sendReminderNotifications`: リマインダー通知の送信（Cronジョブ）
  - `nextNotificationAt`が現在時刻に達したリマインダーを検索
  - Push通知を送信（Expo Notifications経由）
  - 通知送信後、次回の通知日時を再計算して`nextNotificationAt`を更新
  - 毎時間実行（または15分ごと）
- `calculateNextNotificationAt`: 次回の通知日時を計算（内部関数）
  - 頻度（daily, weekly, biweekly, monthly, interval）に基づいて計算
  - RRULE準拠のスケジュール計算
  - 完了後に自動的に次回の通知日時を更新

### 6.13 オフライン画像アップロード ✅ **2026年最終設計検証で追加**
- `createPending`: 中間状態の画像レコード作成（StorageIdは空）
- `upload`: 画像をConvex Storageにアップロードし、StorageIdを設定
- `getPendingUploads`: アップロード待ちの画像一覧取得（再試行用）

### 6.14 広告表示管理 ✅ **2026年追加 - 無料ユーザーへの広告表示**
- **広告表示の制御**:
  - フロントエンドで`user.subscription.tier`を確認し、`"free"`の場合のみ広告を表示
  - 広告の表示頻度を制御（`users.adLastSeenAt`を参照）
  - 同じ広告を短時間で繰り返し表示しない
- **広告配置の実装**:
  - **日記タイムライン**: `getTimeline`の結果に、3〜5件ごとに広告カードを挿入（フロントエンド側で実装）
  - **キュレーション記事一覧**: `getArticles`の結果に、広告カードを1つ混ぜる（フロントエンド側で実装）
  - **リマインダー完了後のサンクス画面**: 完了画面のコンポーネント内で、無料ユーザーの場合のみ広告を表示
- **プレミアム移行の導線**:
  - 広告カードの下に「プレミアムなら広告なしで、もっとサクサク記録できます」というメッセージとプラン比較画面へのリンクを表示
  - 設定画面にも「広告なしで快適に利用する」というオプションからプレミアムプラン比較画面へ導線を設置
- **広告クリックの記録**:
  - 広告をクリックした際に、`updateUser`で`adLastClickedAt`を更新
  - 広告表示時に`adLastSeenAt`を更新

### 6.15 競合解決（楽観的ロック）✅ **2026年最終設計検証で追加**
- `updateActivityWithVersion`: バージョン番号をチェックして活動ログを更新
  - 競合が発生した場合はエラーを返し、UI側で優しいメッセージを表示

### 6.16 ゲーミフィケーション要素関連 ✅ **2026年追加 - ポイント・バッジ・ショップ**
- **ポイント関連**:
  - `getCurrentPoints`: 現在の所持ポイント取得（US-083）
  - `getPointHistory`: ポイント取得履歴取得（US-088）
    - 時系列順に履歴を取得
    - フィルター機能（獲得のみ、消費のみ、期間でフィルター）
    - ソート機能（新しい順、古い順、ポイント数順）
    - ページネーション対応
    - 合計獲得ポイントと合計消費ポイントを返す
  - `getPointEarningMethods`: ポイント取得方法一覧取得（US-084）
- **バッジ関連**:
  - `getUserBadges`: ユーザーが獲得したバッジ一覧取得
  - `getBadgeDefinitions`: バッジ定義一覧取得（管理者用）
  - `checkAndAwardBadges`: バッジ獲得条件をチェックして付与（内部用）
- **ショップ関連**:
  - `getShopItems`: ショップアイテム一覧取得（US-085）
    - フィルター機能（ポイント購入可能、現金購入可能、期間限定）
    - ソート機能（ポイント価格順、現金価格順、新着順）
    - カテゴリ別フィルタリング（静止画フレーム、動くフレーム、アルバム表紙など）
  - `getAssetById`: アイテム詳細取得（US-087）
  - `getUserAssets`: ユーザーが所有しているアイテム一覧取得（US-086）
  - `purchaseAssetWithPoints`: ポイントでアイテム交換（US-070）
  - `purchaseAssetWithMoney`: 現金でアイテム購入（US-070、RevenueCat連携）

### 6.17 公式サイト関連（Next.js + Vercel）✅ **2026年追加 - SEO・LLMフレンドリーな公式サイト**
- **ニュース関連**:
  - `getNews`: 公開済みニュース一覧取得（時系列順、カテゴリフィルタリング対応）
  - `getNewsById`: ニュース詳細取得
  - `getLatestNews`: 最新ニュース取得（トップページ用、最新5件など）
  - `createNews`: ニュース作成（管理者のみ）
  - `updateNews`: ニュース更新（管理者のみ）
  - `deleteNews`: ニュース削除（管理者のみ）
  - `publishNews`: ニュース公開（管理者のみ）
  - **自動更新** ✅ **2026年追加 - モノレポ運用**:
    - Convexの`news`テーブルを更新すると、VercelのOn-demand ISR（Incremental Static Regeneration）により、公式サイトのニュース一覧が瞬時に（かつ静的ファイルとして高速に）更新される
    - Next.js側で`revalidatePath`または`revalidateTag`を使用して実装
- **法務ドキュメント関連**:
  - `getLegalDocument`: 最新版の法務ドキュメント取得（タイプ指定）
  - `getLegalDocumentByVersion`: 特定バージョンの法務ドキュメント取得
  - `getLegalDocumentHistory`: 法務ドキュメントの改定履歴取得
  - `createLegalDocument`: 法務ドキュメント作成（管理者のみ）
  - `updateLegalDocument`: 法務ドキュメント更新（管理者のみ）
  - **一元管理** ✅ **2026年追加 - モノレポ運用**:
    - `packages/policy/`にMarkdownファイルを置き、アプリの「設定 > 規約」と、公式サイトの「フッター > 規約」が常に同じファイルを読み込むようにビルド設定
    - 法務ドキュメントの更新が、アプリと公式サイトの両方に即座に反映される
    - Convexの`legal_documents`テーブルと`packages/policy/`のMarkdownファイルを同期する仕組みを構築
- **FAQ関連** ✅ **2026年追加 - SEO・LLM最適化**:
  - FAQは`packages/policy/faq.md`または`apps/www/content/faq.md`にMarkdown形式で管理
  - Next.js側でFAQを読み込み、FAQPageの構造化データ（JSON-LD）を生成
  - SEO最適化：各FAQに適切なメタタグを設定
  - LLMフレンドリー：FAQの内容を構造化された形式で記述
  - 検索キーワード対策：具体的な悩みをキーワードとして含める
- **統計情報（公式サイト用）**:
  - `getPublicStats`: 公開可能な統計情報取得（例: 総ユーザー数、総記録数など）
  - プライバシー保護：個人や特定のペットが特定されないよう集計処理
- **グローバル公開データ（将来機能）**:
  - `getPublicPets`: 公開設定されているペット一覧取得
  - `getPublicPetById`: 公開設定されているペットの詳細取得
  - `getPublicBadges`: 公開設定されているバッジ一覧取得
  - `getPublicAlbums`: 公開設定されているアルバム一覧取得
- **SEO・LLM最適化**:
  - sitemap.xmlの自動生成（Next.jsのsitemap.ts）
  - robots.txtの設定
  - 構造化データ（JSON-LD）の生成
  - API Route（/api/ai-info）でアプリの機能一覧や最新ニュースをJSON形式で提供
  - FAQPageの構造化データ（JSON-LD）をNext.js側で生成 ✅ **2026年追加**

---

## 7. セキュリティ設計

### 7.1 認証・認可
- Clerkによる認証
- Convexでの認証トークン検証
- ユーザーIDベースのアクセス制御

### 7.2 データアクセス制御
- `ownerId` による所有権チェック
- `pet_members` による共同管理権限チェック
- `visibility` による公開設定の尊重

### 7.3 入力検証
- スキーマレベルでの型チェック
- バリデーション関数の実装
- 不正データの防止

---

## 8. パフォーマンス最適化

### 8.1 インデックス戦略
- 頻繁に検索されるフィールドにインデックス
- 複合インデックスによる高速検索
- 全文検索インデックスの活用

### 8.2 キャッシュ戦略
- Convexの自動キャッシュ
- クライアント側のキャッシュ
- 統計データの非正規化

### 8.3 データ取得最適化
- 必要なフィールドのみ取得
- ページネーションの実装
- リアルタイム更新の最適化

---

## 9. 将来の拡張性

### 9.1 スケーラビリティ
- Convexの自動スケーリング
- データベースのパーティショニング検討
- CDNによる画像配信

### 9.2 機能拡張
- 通知機能の拡張
- チャット機能（将来）
- イベント機能（将来）
- マーケットプレイス機能（将来）

---

## 10. 技術的制約と考慮事項

### 10.1 Convexの制約
- ファイルサイズ制限
- クエリの複雑さ制限
- リアルタイム更新の制限

### 10.2 モバイルアプリの制約
- **オフライン対応**: 画像アップロードキュー管理と再試行ロジックを実装 ✅ **2026年最終設計検証で追加**
- 画像の最適化
- バッテリー消費の最適化

### 10.3 データライフサイクルと物理削除 ✅ **2026年最終設計検証で追加**

#### 自動物理削除（Convex Cronジョブ）
- `restorableUntil`を過ぎたデータを自動で物理削除するCronジョブを実装
- 毎日午前3時に実行し、期限切れのデータを物理削除
- 関連する画像ストレージも同時に削除

#### 退会後のデータ削除（法的要件対応）
- **GDPR等の個人情報保護法に基づき、退会後30日経過で画像ストレージからも完全に削除**
- 退会時に30日後の物理削除をスケジュール
- ユーザーのすべてのデータ（ペット、活動ログ、画像）を削除

### 10.4 オフラインエクスペリエンス ✅ **2026年最終設計検証で追加**

#### 画像アップロードキュー管理
- Expo（クライアント側）にアップロードキューを持ち、再試行するロジックを実装
- ConvexのMutationで「画像レコードはあるが、StorageIdがまだ空」という中間状態を許容
- UIで「アップロード中...」と表示し続ける設計
- 最大3回まで自動的に再試行

#### 中間状態の許容
- 画像レコードは作成されるが、StorageIdは空文字列
- アップロードが完了すると、StorageIdが設定される
- UIでは「アップロード中...」と表示され、完了すると通常の画像として表示される

### 10.5 追悼（メモリアル）プラン ✅ **2026年最終設計検証で追加**

#### 設計思想
- ペットが亡くなり、新しい記録がなくなった後も、思い出（高画質画像）を見るために課金を続けなければならない問題を解決
- 「追悼（メモリアル）プラン」の導入により、経済的な負担を感じることなく思い出を大切にできる

#### 機能
- 月額無料または極安価で、データの保持と閲覧だけを許可する「読み取り専用」の状態
- プレミアム会員だった期間のデータは、退会後も一定期間（例：1年間）「最高画質」でエクスポート可能
- メモリアルプランでは、新しい記録の追加はできないが、これまでの記録と写真は最高画質で閲覧可能

### 10.6 家族共有の競合解決 ✅ **2026年最終設計検証で追加**

#### 楽観的ロック
- Convexは楽観的ロックで保護してくれるが、UI側で「他の人が更新しました」と優しく伝える配慮を追加
- `activities.version`フィールドでバージョン番号を管理
- 更新時にバージョン番号をチェックし、競合が発生した場合は優しいメッセージを表示

### 10.7 ゲーミフィケーション要素 ✅ **2026年追加 - 習慣化と収益性の両立**

#### 設計の目的
- **習慣化**: 毎日の記録が楽しくなり、継続的な健康管理ができる
- **収益性**: サブスクリプションに加えて、個別課金による追加収益を確保
- **コミュニティの質**: バッジによる「金で買えない名誉」で、真剣にペットを大切にしている飼い主を可視化

#### ポイント獲得システム
- **1日の最大獲得ポイント**: 30pt
- **ポイント獲得ルール**:
  - 餌の記録: 5pt（1日3回までOK、計15pt）
  - トイレの記録: 5pt（1日2回までOK、計10pt）
  - 日記の更新: 10pt（1日1回）
- **ポイント獲得履歴**: `point_history`テーブルで記録（監査用）
- **実装**: 活動ログ記録時に自動でポイントを付与（`activities.createActivity` Mutation内で処理）

#### バッジ獲得システム
- **設計思想**: バッジは「金で買えない名誉」として設計（ポイントや現金では購入不可）
- **バッジの種類**:
  - **健康の守護者**: トイレと餌の記録を連続30日達成
  - **愛の語り部**: 日記を累計100件投稿
  - 将来的に追加可能（管理者が`badge_definitions`テーブルに登録）
- **グローバル表示**: `isGlobal: true`のバッジは、他のユーザーのペットプロフィールにも表示される
- **実装**: 活動ログ記録後に`badges.checkAndAwardBadges` Mutationを呼び出し、条件を満たしているかチェック

#### ショップ機能
- **アイテムの種類**:
  - 静止画フレーム: 500pt 〜 または 300円 〜
  - 動くフレーム: 2,000pt 〜 または 800円 〜
  - アルバム表紙: 1,000pt 〜 または 500円 〜
- **購入方法**:
  - ポイント交換: `shop.purchaseAssetWithPoints` Mutation
  - 現金購入: `shop.purchaseAssetWithMoney` Mutation（RevenueCat連携）
- **期間限定アイテム**: `assets.availableFrom`と`assets.availableUntil`で管理
- **実装**: 管理者が`assets`テーブルにアイテムを登録し、ユーザーが購入/交換できる

#### 収益性の試算
- **ライトユーザー（無料）**: 毎日コツコツ記録し、月間約700〜900pt獲得。2ヶ月に1回、少し豪華な「動くフレーム」を交換
- **コアユーザー（課金）**: ポイントを待たずに、新作の「季節限定動くフレーム」や「プレミアム表紙」を都度課金で購入
- **試算**: 1,000人のアクティブユーザーのうち、3%が毎月1つアイテムを買うだけで、月間約1.5万〜3万円の追加収益（ConvexのProプラン代を余裕で賄える）

#### ポイント管理機能 ✅ **2026年追加**
- **所持ポイント確認（US-083）**:
  - プロフィール画面またはショップ画面に現在の所持ポイントを大きく表示
  - ポイント数が視覚的に分かりやすく表示される（例: 1,234pt）
  - ポイントの増減がリアルタイムで反映される
  - ポイント獲得履歴へのリンクが表示される
- **ポイント取得方法確認（US-084）**:
  - ポイント取得方法の一覧を表示
  - 各取得方法のポイント数と説明を明記
  - 各取得方法から直接記録画面に遷移できる
  - 1日の最大獲得ポイント（30pt）を明示
- **ポイント取得履歴確認（US-088）**:
  - ポイント取得履歴画面で、時系列順に履歴を表示
  - 各履歴に獲得/消費日時、ポイント数、理由、関連する活動ログやアイテムへのリンクを表示
  - フィルター機能（獲得のみ、消費のみ、期間でフィルター）
  - ソート機能（新しい順、古い順、ポイント数順）
  - ページネーション機能（履歴が多い場合）
  - 合計獲得ポイントと合計消費ポイントを表示

#### ショップ機能の拡張 ✅ **2026年追加**
- **ショップ一覧表示（US-085）**:
  - 利用可能なアイテムを一覧表示
  - アイテムの種類別にカテゴリ分け（静止画フレーム、動くフレーム、アルバム表紙など）
  - 各アイテムにポイント価格、現金価格、交換済みかどうかを表示
  - フィルター機能（ポイント購入可能、現金購入可能、期間限定）
  - ソート機能（ポイント価格順、現金価格順、新着順）
- **交換済みアイテム確認（US-086）**:
  - プロフィール画面またはショップ画面に「所有しているアイテム」セクションを表示
  - 交換済みアイテムを一覧で表示（アイテム名、画像、交換日時、交換方法）
  - アイテムをタップすると詳細画面に遷移
  - アイテムを直接使用できる（フレームを選択してペットの写真に適用など）
- **交換アイテム詳細確認（US-087）**:
  - アイテム詳細画面でアイテム名、画像、説明、価格、種類、使用可能な場所を表示
  - 期間限定アイテムの場合、利用可能期間を表示
  - 所有しているアイテムの場合、「所有済み」と表示し、「使用する」ボタンを表示
  - 所有していないアイテムの場合、「ポイントで交換」または「現金で購入」ボタンを表示
  - アイテムのプレビューを表示（実際に使用した場合の見た目）

#### UX設計
- **ポイント獲得時のアニメーション**: 活動ログ記録時に、ポイント獲得を視覚的に通知
- **バッジ獲得時の祝福**: バッジ獲得時に祝福のアニメーションを表示
- **ショップUI**: Discord風のUIで、ポイント交換と現金購入を選択できる
- **プロフィール画面**: 獲得したバッジと所有しているアイテムを表示
- **ポイント表示**: プロフィール画面やショップ画面に現在の所持ポイントを大きく表示
- **ショップ一覧**: カテゴリ分けとフィルター・ソート機能で、欲しいアイテムを素早く見つけられる
- **アイテム詳細**: プレビュー機能で、実際に使用した場合の見た目を確認できる

---

### 10.8 監視・アラートシステム ✅ **2026年追加 - サービス停止防止**

#### 設計の目的
- **サービス停止防止**: Convexの無料枠やプランの限界を越えて、サービスが突然停止するのを防ぐ
- **予兆検知**: リソースの枯渇を事前に検知し、適切な対策を講じる
- **自動レポート**: 毎日のアプリの状況を自動で把握し、問題を早期発見する
- **高度な監視**: Better Stackを活用した構造化ログと分析により、システムの健全性を可視化する

#### 監視対象リソース

**Convexのリソース限界**:
- **Database Size（レコード数/容量）**: 無料枠の制限を監視
- **Storage（ファイルストレージ）**: 画像やファイルの使用量を監視
- **Monthly Operations（実行数）**: Action/Mutation/Queryの月間実行数を監視
- **Action Duration（実行時間）**: Actionの実行時間がタイムアウト（最大10分）に近づいていないか監視

**外部サービスの監視**:
- **Amazon PA-API**: APIキーの状態、レート制限の状況
- **Clerk（認証）**: 認証サービスの稼働状況
- **RevenueCat（課金）**: サブスクリプション管理の稼働状況

#### Convexリソース監視ダッシュボード（ADM-012）

**実装方法**:
- **内部Query関数**: `internal.health.getResourceUsage`で各テーブルのレコード数を集計
- **ストレージ使用量**: Convex Storage APIを使用してファイルサイズを集計
- **実行数**: Convexの内部メトリクス（利用可能な場合）またはログから集計
- **ダッシュボード表示**: 管理画面（`apps/admin/`）でリアルタイムに表示

**表示内容**:
- データベースの総レコード数（テーブル別の内訳）
- ストレージ使用量（GB）
- 月間のAction実行数
- 各リソースの使用率（無料枠に対する割合）
- リソース使用状況の推移グラフ（過去30日間）
- 閾値（80%、90%、95%）を超えた場合の警告表示
- 各リソースの残り容量

**技術実装**:
```typescript
// packages/backend/convex/health.ts
export const getResourceUsage = internalQuery({
  handler: async (ctx) => {
    // 各テーブルのレコード数をカウント
    const tableCounts = await Promise.all([
      ctx.db.query("users").collect().then(rows => rows.length),
      ctx.db.query("pets").collect().then(rows => rows.length),
      ctx.db.query("activities").collect().then(rows => rows.length),
      // ... 他のテーブル
    ]);
    
    // ストレージ使用量を取得（Convex Storage APIを使用）
    // 実行数はConvexの内部メトリクスから取得（利用可能な場合）
    
    return {
      dbRows: tableCounts.reduce((sum, count) => sum + count, 0),
      storageGB: 0, // Convex Storage APIから取得
      monthlyOperations: 0, // Convex内部メトリクスから取得
      usageRate: {
        db: (tableCounts.reduce((sum, count) => sum + count, 0) / 50000) * 100, // 無料枠50,000レコード
        storage: 0,
        operations: 0,
      },
    };
  },
});
```

#### Discord日報送信機能（ADM-013）

**実装方法**:
- **Cronジョブ**: Convexの`crons.ts`で毎日決まった時間（デフォルト: 朝9時）に実行
- **内部Action**: `internal.discord.sendDailyReport`でDiscord Webhookに送信
- **統計Query**: `internal.stats.getYesterdayStats`で昨日の統計データを取得

**送信内容**:
```
📊 ペットケアアプリ日報 [2026/02/01]

👤 ユーザーアクティビティ
- 新規登録: 15名
- アクティブユーザー: 120名
- プレミアム移行: 2名

📝 記録統計
- 日記: 45件 (😊 20 / 😴 15 / 🥺 10)
- トイレ: 80件 / 餌: 150件
- リマインダー完了率: 85%

💰 ビジネス・システム
- Amazon API更新: 1,200件
- ポイント発行総数: 4,500pt
- エラーログ発生: 0件 ✅

🚨 システム健全性
- APIレスポンス平均: 120ms (正常)
- エラーログ（Level: Error）: 2件 [詳細リンク]
- 外部API（Amazon/Clerk）生存確認: 100%

[管理画面で詳細を確認する](https://admin.example.com/dashboard)
```

**技術実装**:
```typescript
// packages/backend/convex/discord.ts
export const sendDailyReport = internalAction({
  handler: async (ctx) => {
    // 1. 昨日の統計データを取得
    const stats = await ctx.runQuery(internal.stats.getYesterdayStats);
    
    // 2. Discord Webhookへ送信
    const webhookUrl = process.env.DISCORD_WEBHOOK_URL!;
    await fetch(webhookUrl, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        embeds: [{
          title: `📊 アプリ日報 [${stats.date}]`,
          description: stats.summary,
          color: 0x5865F2, // Discord Blurple
          fields: [
            { name: "👤 ユーザーアクティビティ", value: stats.userActivity, inline: false },
            { name: "📝 記録統計", value: stats.records, inline: false },
            { name: "💰 ビジネス・システム", value: stats.business, inline: false },
            { name: "🚨 システム健全性", value: stats.health, inline: false },
          ],
        }],
      }),
    });
  },
});

// packages/backend/convex/crons.ts
import { cronJobs } from "convex/server";
import { internal } from "./_generated/api";

export const crons = cronJobs({
  dailyReport: {
    cron: "0 9 * * *", // 毎日朝9時
    args: {},
    handler: internal.discord.sendDailyReport,
  },
});
```

#### Better Stack連携（ADM-014）

**実装方法**:
- **構造化ログ送信**: Convex Action内で、特定のイベント（日記投稿、リマインダー完了、プレミアム登録など）をBetter Stack Logsへ送信
- **Heartbeat監視**: ConvexのCronが正常に動作していることをBetter Stack Uptimeに報告
- **アラート設定**: Better Stack側でSQLクエリベースのアラートを設定

**送信するログの種類**:
- **ビジネスメトリクス**: 日記投稿、リマインダー完了、プレミアム登録などのイベント
- **エラーログ**: システムエラー、APIエラーなど
- **パフォーマンスログ**: APIレスポンス時間、Action実行時間など

**技術実装**:
```typescript
// packages/backend/convex/betterstack.ts
export const sendToBetterStack = internalAction({
  args: {
    level: v.union(v.literal("info"), v.literal("warn"), v.literal("error"), v.literal("crit")),
    message: v.string(),
    data: v.any(),
  },
  handler: async (ctx, args) => {
    await fetch("https://in.logs.betterstack.app", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${process.env.BETTER_STACK_TOKEN}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        level: args.level,
        message: args.message,
        ...args.data,
        timestamp: Date.now(),
      }),
    });
  },
});

// 日報送信完了時にHeartbeatを報告
export const reportHeartbeat = internalAction({
  handler: async (ctx) => {
    await fetch(`https://uptime.betterstack.com/api/v1/heartbeat/${process.env.BETTER_STACK_HEARTBEAT_ID}`, {
      method: "POST",
    });
  },
});
```

**Better Stack側のアラート設定例**:
- **SQLクエリ**: `SELECT COUNT(*) FROM logs WHERE level = 'crit' AND timestamp > NOW() - INTERVAL '1 hour'`
- **アラート条件**: 1時間以内に`crit`レベルのログが3件以上発生したらDiscordに通知

#### アラート設定機能（ADM-015）

**閾値設定**:
- **警告（80%）**: リソース使用率が80%に達した際に通知
- **注意（90%）**: リソース使用率が90%に達した際に通知
- **緊急（95%）**: リソース使用率が95%に達した際に通知（@everyoneメンション付き）

**自動対策**:
- **データ圧縮**: 1年以上前のログを自動でアーカイブまたは削除
- **クロール制限**: Amazon APIの更新頻度を自動で下げる（1日1回→3日に1回）
- **オンデマンド無効化**: 一時的にオンデマンド更新を停止し、キャッシュされたデータを使用

**技術実装**:
```typescript
// packages/backend/convex/alerts.ts
export const checkResourceLimits = internalAction({
  handler: async (ctx) => {
    const stats = await ctx.runQuery(internal.health.getResourceUsage);
    
    // 閾値をチェック
    if (stats.usageRate.db > 95) {
      // 緊急: @everyoneメンション付きでDiscordに通知
      await ctx.runAction(internal.discord.sendAlert, {
        level: "crit",
        message: `🚨 緊急: データベース使用率が${stats.usageRate.db.toFixed(1)}%に達しました！`,
        mentionEveryone: true,
      });
      
      // 自動対策: 古いログを削除
      await ctx.runMutation(internal.cleanup.purgeOldLogs, {
        olderThanDays: 365,
      });
    } else if (stats.usageRate.db > 90) {
      // 注意: 通常の通知
      await ctx.runAction(internal.discord.sendAlert, {
        level: "warn",
        message: `⚠️ 注意: データベース使用率が${stats.usageRate.db.toFixed(1)}%に達しました。`,
      });
    } else if (stats.usageRate.db > 80) {
      // 警告: 通常の通知
      await ctx.runAction(internal.discord.sendAlert, {
        level: "info",
        message: `ℹ️ 警告: データベース使用率が${stats.usageRate.db.toFixed(1)}%に達しました。`,
      });
    }
    
    // Better Stackにも送信
    await ctx.runAction(internal.betterstack.sendToBetterStack, {
      level: stats.usageRate.db > 95 ? "crit" : stats.usageRate.db > 90 ? "warn" : "info",
      message: "Convex Resource Health Check",
      data: {
        db_rows: stats.dbRows,
        storage_gb: stats.storageGB,
        action_calls: stats.monthlyOperations,
        usage_rate: stats.usageRate,
      },
    });
  },
});

// Cronで1時間ごとにチェック
export const crons = cronJobs({
  resourceCheck: {
    cron: "0 * * * *", // 毎時0分
    args: {},
    handler: internal.alerts.checkResourceLimits,
  },
});
```

#### ダッシュボードUI設計

**管理画面のダッシュボード構成**:
- **リソース監視セクション**: 各リソースの使用率を視覚的に表示（プログレスバー、グラフ）
- **統計情報セクション**: ユーザー数、記録数、プレミアム会員数などの統計
- **アラート履歴セクション**: 過去のアラート送信履歴
- **設定セクション**: Discord Webhook URL、Better Stack設定、アラート閾値の設定

**UX設計**:
- **色分け**: 使用率が80%未満は緑、80-90%は黄、90-95%はオレンジ、95%以上は赤
- **リアルタイム更新**: ダッシュボードを開いている間、定期的に（例: 5分ごと）データを更新
- **詳細リンク**: 各リソースの詳細ページへのリンクを提供

---

## 11. 用語集

- **Species（種別）**: ペットの大分類（犬、猫、爬虫類など）
- **Breed（品種）**: 種別内の細分類（ハスキー、レオパなど）
- **Activity（活動ログ）**: ペットの日常活動の記録
- **Payload（ペイロード）**: 活動ログの実際のデータ部分
- **Visibility（公開設定）**: データの公開範囲（private/shared/public）
- **Pet Member（共同管理者）**: ペットを共同で管理するユーザー
