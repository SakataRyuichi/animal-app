# 3. データフロー設計

**📚 インデックス**: [DESIGN_DOCUMENT_INDEX.md](../DESIGN_DOCUMENT_INDEX.md)

データフロー設計

### 3.1 認証フロー
```
1. Clerkでログイン
2. Convexでユーザー存在確認
3. 存在しなければ users テーブルに作成
4. セッション確立
```

### 3.2 ペット登録フロー
```
1. ユーザーがペット情報を入力
2. pets テーブルに新規作成
3. ownerId に現在のユーザーIDを設定
4. ペット一覧に追加表示
```

### 3.3 活動ログ記録フロー
```
1. ユーザーが活動ログを入力
2. activities テーブルに新規作成
3. petId と createdBy を設定
4. type に応じて payload にデータを格納
5. タイムラインに反映
```

### 3.4 商品登録フロー（Phase 3）
```
1. ユーザーが活動ログで商品を検索
2. 商品が見つからない場合、新規作成
3. products テーブルに isVerified: false で保存
4. 運営が確認後、isVerified: true に更新
5. アフィリエイトリンクを付与
```

### 3.5 AI相談フロー（Phase 1後半 / Phase 2）
```
1. ユーザーがチャット画面で質問を入力
   - 初回利用時: ウェルカムメッセージと免責事項を表示 ✅
   - 入力中: 専門的なキーワード検出時にリアルタイム警告を表示 ✅
2. chat_threads テーブルにスレッドを作成（初回の場合）
3. chat_messages テーブルにユーザーメッセージを保存
4. chat アクションを呼び出し:
   a. ペットのカルテ情報を取得（pets, activities）
   b. 質問をベクトル化（OpenAI Embeddings API）
   c. 知識ベースをベクトル検索（Convex Vector Search）
   d. 関連知識を取得
   e. システムプロンプト + カルテ + 知識 + 質問をLLMに送信
     - システムプロンプトに免責事項とガードレールを含める ✅
   f. 回答を生成（引用元も含む）
   g. 免責事項タイプを自動判定（medical/food/emergency/general） ✅
5. chat_messages テーブルにAI回答を保存（disclaimerShown, disclaimerTypeを含む） ✅
6. UIに回答を表示:
   - 回答内容を表示
   - 引用元を表示
   - 免責事項を表示（フッターまたはインライン） ✅
   - 推奨アクションを表示
7. 緊急度が高い場合、警告表示と病院マップを表示
```

### 3.6 コラム投稿フロー（Phase 1後半 / Phase 2）
```
1. 管理者または認定専門家がコラムを作成
2. タイトル、本文、対象種別、タグを入力
3. 一次ソースのリンクを追加
4. 下書きとして保存（status: "draft"）
5. プレビューで確認
6. 公開（status: "published"）
7. ホーム画面にレコメンド表示
```

### 3.6-1 キュレーション記事の登録フロー（Phase 1後半 / Phase 2）✅ **外部記事の紹介**
```
1. 管理者が外部記事のURLを入力
2. OGP情報（タイトル、画像、説明）を自動取得（Convex Action）
3. 管理者が紹介文（summary）を入力（「この記事のここがレオくんに役立つかも！」など）
4. カテゴリ、対象種別、プレミアム制限を設定
5. サムネイル画像をConvex Storageに保存（最適化）
6. URLをサニタイズ（悪意のあるスクリプトを除去）
7. curations テーブルに保存
8. キュレーション一覧に表示
```

### 3.6-2 キュレーション記事の閲覧フロー（Phase 1後半 / Phase 2）✅ **外部記事の紹介**
```
1. ユーザーがキュレーション一覧画面を開く
2. ペットの種別に合わせて、関連する記事が優先的に表示される（パーソナライズ）
3. 記事をタップすると、パーソナライズされたポップアップが表示される
   - 「この記事のここがレオくんに役立つかも！」（AIが生成）
4. 記事を開く（expo-web-browserでアプリ内ブラウザ）
5. 記事閲覧中に、「この記事について話す」ボタンが表示される
6. 「あとで読む」ボタンで保存できる
7. 「この記事を参考にアルバムを作る」ボタンで、アルバム作成画面に遷移
8. curation_interactions テーブルに閲覧履歴を記録
```

### 3.7 コラムレコメンデーションフロー
```
1. ユーザーがホーム画面を開く
2. ユーザーが飼っているペットの種別を取得
3. articles テーブルから該当種別の公開記事を検索
4. 新しい順にソート
5. 「あなたにおすすめ」セクションに表示
```

### 3.7-1 キュレーションレコメンデーションフロー（Phase 1後半 / Phase 2）✅ **外部記事の紹介**
```
1. ユーザーがホーム画面またはキュレーション一覧画面を開く
2. ユーザーが飼っているペットの種別と年齢を取得
3. curations テーブルから該当種別のアクティブな記事を検索
4. 新しい順にソート
5. AIがユーザーのペット情報を元に、パーソナライズされた紹介文を生成
6. 「あなたにおすすめ」セクションに表示
7. プレミアムユーザーの場合、記事に基づいた「AIアドバイス」も表示
```

### 3.8 SNSフィード表示フロー（Phase 3）

**フォロー中（Following）タブ**:
```
1. ユーザーが「フォロー中」タブを選択
2. follows テーブルから、現在のユーザーがフォローしている userId リストを取得
3. activities テーブルから、フォローしているユーザーの isPublic: true の投稿を取得
4. createdAt で新しい順にソート
5. タイムラインに表示
6. フォローしている人が新しい投稿をすると、リアルタイムで自動更新
```

**おすすめ（For You）タブ**:
```
1. ユーザーが「おすすめ」タブを選択
2. 以下の要素をミックス:
   a. 人気投稿: likes テーブルからいいね数が多い投稿を取得
   b. 関連性: ユーザーのペットと同じ種別の投稿を取得
   c. 波及効果: フォローしている人がいいねした投稿を取得
   d. **専門家が「いいね」した投稿を優先的に表示**（信頼性の指標）
3. スコアリングして優先順位を決定（専門家のいいねは高スコア）
4. タイムラインに表示
```

**AIパーソナライズ版（オプション）**:
```
1. ユーザーのペット情報（種別、品種、年齢など）をベクトル化
2. 投稿内容をベクトル化（embedding フィールドを使用）
3. Convex Vector Searchで類似度を計算
4. 類似度が高い投稿を優先的に表示
```

### 3.9 フォロー・いいねフロー（Phase 3）

**フォローフロー**:
```
1. ユーザーが他のユーザーのプロフィール画面で「フォロー」ボタンをタップ
2. follows テーブルに新規作成（followerId, followingId）
3. フォローされたユーザーに通知（将来拡張）
4. リアルタイムでフォロー状態が更新される
```

**リアクションフロー** ✅ **2026年更新 - 多機能リアクション**:
```
1. ユーザーが投稿のリアクションボタンをタップ
   - **通常タップ**: デフォルトのリアクション（❤️ 大好き）を追加
   - **長押し**: 複数のリアクションタイプから選択できるメニューを表示
2. リアクションタイプを選択（❤️, 🌻, 💪, 🌟, 🌈）
3. likes テーブルに新規作成（userId, activityId, reactionType）✅ **2026年追加**
4. 投稿ごとのリアクションタイプ別の数を集計して表示 ✅ **2026年追加**
5. リアクションの取り消しができる
6. **専門家（獣医師など）がリアクションした場合**:
   - 投稿に「獣医師が推奨」などの特別なバッジが表示される
   - 専門家のリアクションは通常のリアクションとは区別される
   - おすすめフィードで優先的に表示される
```

---
