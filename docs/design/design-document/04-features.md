# 4. 機能設計

**📚 インデックス**: [DESIGN_DOCUMENT_INDEX.md](../DESIGN_DOCUMENT_INDEX.md)

機能設計

### 4.1 Phase 1: 個人管理機能

#### 4.1.1 ユーザー管理
- ユーザー登録・ログイン（Clerk）
- プロフィール編集
- プレミアム会員登録

#### 4.1.2 ペット管理
- ペット登録
- ペット一覧表示
- ペットプロフィール編集
- ペット削除

#### 4.1.3 活動ログ
- 食事記録
- トイレ記録
- 散歩記録
- 日記投稿
- ケア記録
- タイムライン表示
- ログ編集・削除

#### 4.1.4 ダッシュボード
- 今日のサマリー
- 最近の活動ログ
- 統計情報（体重推移など）

#### 4.1.5 AI相談機能 ✅ **キラー機能**
- AIチャット（RAGベース）
- ペットのカルテ情報を活用した相談
- 信頼できる知識ベースからの回答生成
- 緊急度判定と病院案内
- 引用元の明示

---

### 4.4 AI相談機能（Phase 1後半 / Phase 2）✅ **キラー機能**

#### 4.4.1 システム構成

**目的**: 「信頼できるソースに基づいたAI相談」を実現し、単なる記録アプリから「ペットの命を守るパートナー」へと進化させる

**信頼性の担保方法**:
1. **ペットのカルテ（Context）**: `pets`テーブルと`activities`テーブルから、年齢・体重・既往歴や直近の食事・トイレ記録を読み込む
2. **信頼できる知識ベース（Knowledge Base）**: 獣医師監修のガイドラインや信頼できるQ&Aデータをベクトル化してConvexに保存
3. **専門家の検索（Triage）**: AIが「緊急性が高い」と判断した場合、近くの動物病院を案内

#### 4.4.2 RAG（Retrieval-Augmented Generation）アーキテクチャ

**処理フロー**:
```
1. ユーザーが質問を入力
2. ペットのカルテ情報を取得（pets, activities）
3. 質問をベクトル化して知識ベースを検索
4. 関連する知識を取得
5. カルテ情報 + 知識ベース + 質問をLLMに送信
6. 回答を生成（引用元も含む）
7. 回答をchat_messagesに保存
```

#### 4.4.3 機能詳細

**A. 「今の状態」に基づいた相談**
- 直近3日間のログを取得
- ペットのプロフィール（年齢、体重など）を確認
- 知識ベースから関連記事を検索
- 個別化された回答を生成

**B. 緊急度の判定と相談窓口への誘導**
- 知識ベースの「中毒物質リスト」と照合
- ペットの体重を考慮した危険度判定
- 緊急時は画面を警告色に変更
- 現在地周辺の救急対応可能な動物病院マップを表示（Google Maps API連携）

**C. 引用元の明示**
- 回答に使用した知識ベースの記事を引用
- `citedSources`フィールドに保存
- UIで引用元を表示

**D. 免責事項（ディスクレイマー）の表示** ✅ **信頼性と誠実さを担保**
- **表示タイミング**:
  1. **初回利用時のウェルカムメッセージ**: AI自身が自己紹介と共に「できないこと」を伝える
  2. **チャット画面のフッター**: メッセージ入力欄の下に常駐表示（控えめなサイズ）
  3. **回答ごとのインライン注釈**: 特定のキーワード（「病気」「薬」「症状」など）が含まれる回答の最後に自動表示
- **免責事項の種類**:
  - `general`: 一般的な免責事項（初回利用時など）
  - `medical`: 医療・健康に関する免責事項（症状、病気、治療など）
  - `food`: 食事・栄養に関する免責事項（フード、サプリメントなど）
  - `emergency`: 緊急時の免責事項（誤飲、事故など）
- **デザインの方向性**:
  - 警告色（赤）ではなく、薄い黄色やグレーなどの「親切な助言」として感じられる配色
  - ⚠️マークよりも、💡やℹ️マークを使用してアプリのトーン＆マナーに合わせる
- **システムプロンプトでの制御**:
  - AIに「医療的な診断を断定的に行わないこと」を指示
  - 「必ず獣医師への相談を推奨する一文を添えること」を指示
  - 誤った情報を提供する可能性があることを常に意識させる

#### 4.4.4 技術実装

**使用技術**:
- **OpenAI Embeddings API**: テキストのベクトル化（`text-embedding-3-small`）
- **OpenAI ChatCompletion API**: 回答生成（GPT-4o推奨）
- **Convex Vector Search**: ベクトル検索
- **Convex Actions**: 外部API呼び出し

**実装ステップ**:
1. **知識データの投入（Ingestion）**
   - 信頼できるデータ（PDF、Webサイト）をテキスト化
   - OpenAI Embedding APIでベクトル化
   - `knowledge_base`テーブルに保存

2. **回答生成アクション（Generation）**
   - `chat`アクションを作成
   - 引数: `petId`, `message`
   - 処理フロー:
     1. `pets`と直近の`activities`を取得
     2. `message`をベクトル化して`knowledge_base`を検索
     3. システムプロンプトに含めてOpenAI ChatCompletion APIを呼ぶ
     4. 結果を`chat_messages`に保存して返す

3. **UIへの反映**
   - チャット画面を作成
   - 通常の吹き出し表示
   - 「推奨アクション」をリッチなカードとして表示
   - 引用元の表示

#### 4.4.5 法的・安全上の注意点

**重要**: AIによる医療相談機能を作る際、**「診断（Diagnosis）」をしてはいけない**という法律（獣医師法など）の壁があります。

**対策**:
- **免責事項**: アプリの初回起動時に「このAI機能は情報提供のみを目的としており、獣医師の診断に代わるものではありません」という同意を得る
- **システムプロンプトでの制御**: AIに対して「あなたは獣医師ではありません。診断を下さず、あくまで一般的なアドバイスと受診の目安を提示してください」と強く指示
- **緊急時の案内**: 緊急度が高い場合は、必ず動物病院への受診を推奨

#### 4.4.6 使用例

**例1: 食欲不振の相談**
```
ユーザー: 「最近食欲がないみたい」

AIの処理:
1. 直近3日間のログを取得 → 「食事量：通常の50%」「嘔吐：あり」
2. ペットプロフィールを確認 → 「14歳、高齢犬」
3. 知識ベースから「高齢犬 食欲不振 嘔吐」を検索
4. 回答生成

AIの回答:
「ポチくん（14歳）の記録を見ると、昨日から食事量が半分に減っており、
今朝一度嘔吐の記録がありますね。高齢なので脱水症状が心配です。
一般的なガイドラインでは、高齢犬の食欲不振が24時間続く場合は受診が推奨されます。
歯茎が乾いていないか確認し、かかりつけ医への相談をお勧めします。」

引用元:
- 「高齢犬の健康管理ガイド」（獣医師監修）
- 「嘔吐時の対応方法」
```

**例2: 緊急時の相談**
```
ユーザー: 「チョコレートを食べてしまったかも」

AIの処理:
1. 知識ベースの「中毒物質リスト」と照合 → 危険度：高
2. ペットの体重を取得 → 3kg（少量でも致死的）
3. 緊急判定フラグを立てる

AIの回答（UI表示を変更）:
[警告画面を表示]
「⚠️ 緊急事態です！今すぐ病院へ！」

チョコレートは犬にとって非常に危険な物質です。
ポチくん（3kg）の場合、少量でも致死的な可能性があります。
すぐに動物病院を受診してください。

[現在地周辺の救急対応可能な動物病院マップを表示]
```

---

### 4.2 Phase 2: 家族・チーム管理機能

#### 4.2.1 共同管理
- 共同管理者の追加
- 権限設定（admin/editor/viewer）
- 共同管理者一覧表示
- 共同管理者の削除

#### 4.2.2 共有機能
- 共有ペット一覧の表示
- 共有ペットへのアクセス制御

---

### 4.3 Phase 3: SNS・商品データベース機能

#### 4.3.1 SNS機能

**概要**: 2026年版のモダンなSNS機能。XやThreadsのような「フォロー中（Following）」と「おすすめ（For You）」のタブ切り替えを実装。

##### A. タイムラインの2つのロジック

**① フォロー中（Following）**
- **ロジック**: 自分がフォローしている`userId`のリストを取得し、その人たちが投稿した`isPublic: true`の記事を、日付が新しい順に表示
- **実装**: Convexのインデックス機能を使って、フォローしているID群に合致する投稿を高速にスキャン
- **特徴**: Convexのリアルタイム更新により、フォローしている人が新しい投稿をすると、自動的にタイムラインに反映される

**② おすすめ（For You）**
- **ロジック**: 以下の要素をミックスして表示
  - **人気投稿**: 全体の「いいね数」が多いもの
  - **関連性**: 自分の飼っているペットと同じ種別の投稿
  - **波及効果**: フォローしている人が「いいね」した投稿（ネットワークが広がる）
- **実装**: Convexの`searchIndex`や、定期的に集計する「人気スコア」を利用
- **特徴**: AI（RAG）を活用した超パーソナライズも可能（後述）

##### B. UI/UX実装（Expo / Tamagui）

**タブ切り替えUI**:
- 画面上部にSegmented Controlを配置
- 2つのタブ: 「おすすめ」と「フォロー中」
- タブ切り替え時に、Convexの`query`関数を動的に切り替え

**実装例**:
```typescript
// ステート管理
const [feedType, setFeedType] = useState<"recommended" | "following">("recommended");

// データ取得（動的切り替え）
const feed = useQuery(
  feedType === "following"
    ? api.activities.getFollowingFeed
    : api.activities.getRecommendedFeed,
  { userId: currentUserId }
);
```

**UXの特徴**:
- タブ切り替えが即座に反映される（Convexのリアルタイム更新）
- スクロール位置を保持（タブ切り替え後も元の位置に戻れる）
- 無限スクロール対応

##### C. AI（RAG）を活用した超パーソナライズ ✅ **2026年版の先進機能**

**概要**: 単なる「いいね数順」ではなく、**「あなたのペットに役立つ投稿」**を最優先で表示

**例**:
- あなたが「ハスキー」を飼っている場合
- 他のハスキー飼い主が投稿した「夏場の温度管理日記」や「おすすめの冷却マット（商品リンク付き）」を、フォローしていなくても「おすすめ」のトップに表示

**仕組み**:
1. あなたのペット情報（種別、品種、年齢など）をベクトル化
2. 投稿内容（テキスト、タグ、種別など）をベクトル化
3. Convex Vector Searchで類似度を計算
4. 類似度が高い投稿を優先的に表示

**実装**:
- Convex Vector Searchを使用
- 投稿に`embedding`フィールドを追加（オプション）
- ユーザーのペット情報と投稿の類似度を計算

##### D. パフォーマンス最適化

**初期段階**:
- 「フォローしている人の投稿」と「全体の人気投稿」を単純に分けるだけで十分
- Convexのインデックスを活用して高速に取得

**スケール時**:
- Convexの`Action`を使って、バックグラウンドで「おすすめリスト」を事前に計算（キャッシュ）
- 人気スコアを定期的に更新
- ベクトル検索結果をキャッシュ

##### E. 機能詳細

- **グローバルフィード（公開日記）**: すべての公開投稿を時系列で表示
- **いいね機能**: 投稿へのいいね・いいね解除
- **フォロー機能**: ユーザーのフォロー・フォロー解除
- **コメント機能**: 将来拡張予定

#### 4.3.2 商品データベース
- 商品検索
- 商品詳細表示
- 商品登録（ユーザー投稿）
- 商品承認（運営）

#### 4.3.2.1 商品データ取得戦略 ✅ **2026年追加 - 初回シードとオンデマンド更新の分離**

**設計思想**: 初回用の一括データ蓄積（シード）と、運用時のオンデマンド更新を分離し、商品ごとに1日1回の更新制限を設けることで、APIコストとリスクを最小化します。

**1. 初回シード（一括データ蓄積）**
- **目的**: カテゴリごとに絞った定期実行による初期データ収集
- **実行タイミング**: 管理者の手動起動（カテゴリ別）
- **重複チェック**: ASINで重複チェック、既存商品は更新しない
- **実装**: `seedProductsByCategory` Action（カテゴリごとに最大100件まで取得、10件ずつバッチ処理）
- **API制限の遵守**: 1秒待機を挟みながら、10件ずつまとめて詳細情報を取得

**2. オンデマンド更新（1日1回制限）**
- **目的**: ユーザーが商品詳細を開いた際、24時間以上経過している場合のみ更新
- **実行タイミング**: ユーザーが詳細画面を開いた時
- **更新対象**: 24時間以上経過した商品のみ（価格・在庫・評価のみ更新、画像や説明は変更されないため）
- **実装**: `getProductDetail` Query（即座にDB値を返し、裏側で`updateProductFromApi` Actionをスケジュール）
- **パターン**: Stale-While-Revalidate（SWR）パターンで、ユーザーを待たせずに裏側で更新

**3. 定期Cronジョブ（優先度付き更新）**
- **目的**: 閲覧数の多い商品を優先的に更新
- **実行タイミング**: 毎日深夜2時（JST）
- **更新対象**: 過去3日間に閲覧された商品（優先度: 高）、最大100件まで
- **実装**: `updatePopularProductsBatch` Action（10件ずつまとめて更新、API制限を守るため1秒待機）

**4. データ取得戦略のまとめ**

| 機能 | 実行タイミング | 更新対象 | 重複チェック |
|------|---------------|---------|------------|
| **初回シード** | 管理者の手動起動（カテゴリ別） | 新規商品のみ | ASINで重複チェック、既存商品は更新しない |
| **オンデマンド更新** | ユーザーが詳細を開いた時 | 24時間以上経過した商品のみ | `lastUpdatedAt`で判定、1日1回制限 |
| **定期Cron更新** | 毎日深夜2時 | 閲覧数の多い商品（過去3日間） | `lastUpdatedAt`で判定、1日1回制限 |

**設計のポイント**:
- **重複更新の防止**: 初回シードでは既存商品を更新しない、オンデマンド更新では24時間以内の更新をスキップ
- **APIコストの最小化**: バッチ処理（10件ずつ）とレート制限の遵守（1秒待機）
- **ユーザー体験の最適化**: Stale-While-Revalidateパターンで、即座にDB値を返し、裏側で更新
- **エラー耐性**: APIエラー時は`lastUpdatedAt`を更新せず、30分後に再試行

#### 4.3.3 レビュー機能
- レビュー投稿
- レビュー一覧表示
- 種別ごとの商品人気ランキング
- レビュー統計

---

### 4.5 コラム・記事機能（Phase 1後半 / Phase 2）✅ **信頼性向上・フック機能**

#### 4.5.1 概要

**目的**: 専門家による信頼できる一次ソースに特化したコラム・記事機能。アプリの信頼性を高め、ユーザーが毎日アプリを開く強力な動機（フック）を提供。

**特徴**:
- 管理者・認定専門家のみが投稿可能
- 一次ソースの明示による信頼性の担保
- ペット種別に合わせたレコメンデーション
- 情報の不確かなSNSとの差別化

#### 4.5.2 段階的な拡張プラン

**フェーズ1: 管理者（運営）による配信**
- 運営が信頼できるソースを元に記事を作成・公開
- Convex Dashboardまたはアプリ内の管理者用投稿ページから投稿
- ユーザーの飼っているペットの種類に合わせたコラムをホーム画面にレコメンド

**フェーズ2: 獣医師・専門家の登録と認証**
- 事業者ユーザーの中から、免許証などの確認が取れた人を「認定獣医師」フラグで管理
- 有料機能として、獣医師が「自分のクリニックの宣伝」としてコラムを書く権利をサブスクリプションで販売
- 一部有料コラムの仕組みを導入

#### 4.5.3 AIを活用したコンテンツ作成補助

**執筆サポートツール**:
- 信頼できる医学論文のURLを渡すと、その内容を要約し、初心者向けの分かりやすいコラムの下書きをMarkdownで生成
- 構成は「結論、理由、具体的な対策」に自動フォーマット
- 一次ソースの自動チェック（厚生労働省や獣医師会のガイドラインとの矛盾チェック）

**AIへの指示例**:
```
「信頼できる医学論文のURLを渡すので、その内容を要約し、
『初めて猫を飼う人向け』の分かりやすいコラムの下書きをMarkdownで生成して。
構成は『結論、理由、具体的な対策』にして。」
```

#### 4.5.4 住環境シミュレーター（発展アイデア）

**機能概要**:
- ペットの種別と、部屋の広さ・設備を入力すると、AIが改善点をアドバイスする診断機能

**使用例**:
- 「シベリアンハスキーを6畳の部屋で飼う場合」
- → 「運動量不足と温度管理のリスク」を指摘
- → 推奨されるエアコン設定や近隣のドッグランを提案

#### 4.5.5 機能詳細

**A. コラム一覧表示**
- 公開済みのコラムを一覧表示
- 種別でフィルタリング
- タグでフィルタリング
- 新しい順・人気順でソート

**B. コラム詳細表示**
- タイトル、本文、アイキャッチ画像
- 一次ソースのリンク表示
- 著者情報（専門家の場合）
- 関連コラムのレコメンデーション

**C. レコメンデーション**
- ユーザーが飼っているペットの種別に合わせたコラムをホーム画面に表示
- 「あなたにおすすめ」セクション

**D. 管理者用投稿機能**
- コラムの作成・編集・削除
- 下書き保存
- 公開・非公開の切り替え
- 一次ソースの追加

---
