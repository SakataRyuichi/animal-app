# 管理画面ユーザーストーリー

**📚 ドキュメントインデックス**: [DOCUMENTATION_INDEX.md](./DOCUMENTATION_INDEX.md)

## 概要
このドキュメントは、管理画面（Next.js）の機能を管理者視点で整理したユーザーストーリーです。

**関連ドキュメント**:
- [USER_STORIES.md](./USER_STORIES.md): モバイルアプリ側のストーリー
- [CONVEX_SCHEMA.md](./CONVEX_SCHEMA.md): スキーマ定義（curations, articlesテーブルなど）
- [DESIGN_DOCUMENT.md](./DESIGN_DOCUMENT.md): アプリ設計の詳細
各ストーリーは「As a / I want to / So that」の形式で記述され、管理者の作業効率とサービスの品質向上を目的としています。

**このドキュメントは「開発の憲法」として機能します。**
CursorなどのAI開発ツールに機能の実装を依頼する際、このドキュメントを参照することで、管理者が効率的にコンテンツを管理できる機能を作り出すことができます。

### AI（Cursor）への指示への活用

このドキュメントをCursorで活用する際は、以下のように指示してください：

**例1: コラム投稿機能の実装**
```
管理画面ユーザーストーリードキュメントの ADM-001（コラム投稿）を実装して。
特に、Markdown形式での記述とプレビュー機能を重視して。
下書き保存機能も忘れずに実装して。
```

**例2: キュレーション記事の登録**
```
ADM-004（キュレーション記事の登録）を実装して。
OGP情報の自動取得とサムネイル画像の最適化を忘れずに。
URLのサニタイズも実装して。
```

### ストーリーの構成
各ユーザーストーリーには以下の要素が含まれます：
- **As a**: 管理者のペルソナ（誰が）
- **I want to**: 管理者の行動（何をしたいか）
- **So that**: 管理者の価値・目的（なぜそれが価値があるか）
- **受け入れ基準**: 機能の具体的な要件
- **体験価値**: 管理者が得られる価値や効率性
- **使用シーン**: 実際の使用場面の例
- **優先度**: 開発の優先順位

---

## コラム・記事管理機能

### ADM-001: コラム投稿（管理者）
**As a** 管理者  
**I want to** 信頼できるコラムを投稿する  
**So that** ユーザーに価値のある情報を提供できる

**受け入れ基準**:
- タイトル、本文を入力できる
- Markdown形式で記述できる
- 対象種別を選択できる
- タグを追加できる
- 一次ソースのリンクを追加できる
- 下書き保存ができる
- プレビューで確認できる
- 公開・非公開を切り替えられる
- アイキャッチ画像をアップロードできる

**体験価値**:
- **効率性**: Markdown形式で素早く記述でき、プレビューで確認できる
- **品質管理**: 下書き保存機能により、公開前に内容を確認できる
- **信頼性**: 一次ソースのリンクを追加することで、情報の信頼性を担保できる

**使用シーン**:
- 新しいコラムを作成する時
- 既存のコラムを編集する時
- コラムの公開タイミングを管理する時

**優先度**: 高

---

### ADM-002: AI執筆サポート（管理者）
**As a** 管理者  
**I want to** AIを使ってコラムの下書きを生成する  
**So that** 効率的にコンテンツを作成できる

**受け入れ基準**:
- 医学論文のURLを入力できる
- 対象読者を指定できる（例：「初めて猫を飼う人向け」）
- AIがMarkdown形式の下書きを生成する
- 構成が「結論、理由、具体的な対策」になる
- 生成された下書きを編集できる
- 生成履歴が保存される

**体験価値**:
- **効率性**: AIが下書きを生成することで、執筆時間を短縮できる
- **品質**: 医学論文を基にした信頼性の高い下書きを生成できる
- **一貫性**: 統一された構成で下書きが生成される

**使用シーン**:
- 新しいトピックのコラムを作成する時
- 医学論文を基にしたコラムを作成する時
- 効率的にコンテンツを作成したい時

**優先度**: 中

---

### ADM-003: 記事の信頼性チェック（管理者）
**As a** 管理者  
**I want to** 記事の信頼性をAIでチェックする  
**So that** 不正確な情報を公開しないようにできる

**受け入れ基準**:
- 記事の内容をAIでチェックできる
- 厚生労働省や獣医師会のガイドラインとの矛盾を検出できる
- 問題点がリストで表示される
- 修正提案が表示される
- チェック履歴が保存される

**体験価値**:
- **品質管理**: 不正確な情報を公開前に検出できる
- **信頼性**: ガイドラインとの整合性を確認できる
- **効率性**: AIによる自動チェックで、手動での確認時間を短縮できる

**使用シーン**:
- コラムを公開する前に、信頼性を確認する時
- 既存のコラムの内容を見直す時
- ガイドラインとの整合性を確認する時

**優先度**: 低

---

## キュレーション記事管理機能

### ADM-004: キュレーション記事の登録（管理者）
**As a** 管理者  
**I want to** 外部記事をキュレーションとして登録する  
**So that** ユーザーに価値ある外部情報を提供できる

**受け入れ基準**:
- 外部記事のURLを入力できる
- OGP情報（タイトル、画像、説明）を自動取得できる（`packages/backend/convex/actions/fetchOGP.ts`）
- URLをサニタイズ（悪意のあるスクリプトを除去）できる
- 管理者による紹介文（summary）を入力できる
- カテゴリ（health/food/lifestyle/care/emergency）を選択できる
- 対象ペット種別を選択できる（複数選択可能）
- サムネイル画像をConvex Storageに保存できる（`packages/backend/convex/actions/optimizeThumbnail.ts`）
- プレミアム制限を設定できる（isPremium）
- 公開日時を設定できる
- 下書き保存ができる
- プレビューで確認できる

**体験価値**:
- **効率性**: OGP情報の自動取得により、手動での入力時間を短縮できる
- **品質管理**: URLのサニタイズにより、セキュリティを担保できる
- **パーソナライズ**: 管理者による紹介文により、アプリの独自価値を提供できる

**使用シーン**:
- 信頼できる外部記事を見つけた時
- ユーザーに役立つ情報をキュレーションとして登録する時
- 定期的にキュレーション記事を追加する時

**優先度**: 高

---

### ADM-005: キュレーション記事の編集・削除（管理者）
**As a** 管理者  
**I want to** 既存のキュレーション記事を編集・削除する  
**So that** 情報の正確性を保ち、古い情報を更新できる

**受け入れ基準**:
- キュレーション記事の一覧が表示される
- 記事を選択して編集できる
- 紹介文（summary）を更新できる
- カテゴリや対象種別を変更できる
- 記事を削除できる（論理削除）
- 削除した記事を復元できる
- 編集履歴が記録される

**体験価値**:
- **品質管理**: 情報の正確性を保つために、記事を更新できる
- **柔軟性**: 削除と復元機能により、誤操作を防げる

**使用シーン**:
- 外部記事のURLが変更された時
- 紹介文を更新したい時
- 古い記事を削除したい時

**優先度**: 中

---

## 商品データベース管理機能

### ADM-006: 商品一覧・詳細閲覧（運営）✅ **2026年追加**
**As a** 運営者  
**I want to** 商品データベースの商品を閲覧する  
**So that** 商品情報の状況を把握し、データベースの品質を管理できる

**受け入れ基準**:
- 商品一覧が表示される（ページネーション対応）
- 商品をカテゴリでフィルタリングできる（food/toy/litter/accessoryなど）
- 商品を検索できる（商品名、ブランド、製造会社で検索）
- 商品の承認状態（isVerified）でフィルタリングできる
- 商品の詳細情報を表示できる
  - 基本情報（商品名、カテゴリ、ブランド、製造会社、説明）
  - アソシエイトAPI情報（APIソース、商品ID、取得日時、APIステータス、データ取得状況）
  - 価格情報（現在価格、定価、割引率、通貨、在庫状況）
  - 評価情報（Amazon評価、レビュー数、アプリ内評価、レビュー数）
  - ペットフード専用情報（成分表、栄養成分、対象種別、対象ライフステージ、パッケージサイズ、カロリー）
  - 画像（商品画像の表示）
  - アフィリエイトリンク（Amazon/楽天へのリンク）
  - 統計情報（閲覧数、最終閲覧日時、最終更新日時）
- 商品のレビュー一覧を表示できる
- 商品の承認待ち状態を確認できる
- 商品のデータ更新状況（lastUpdatedAt）を確認できる

**体験価値**:
- **可視性**: 商品データベースの全体像を把握できる
- **効率性**: 検索・フィルタリング機能により、特定の商品を素早く見つけられる
- **品質管理**: 商品情報の正確性やAPI取得状況を確認できる

**使用シーン**:
- 商品データベースの状況を確認する時
- 特定の商品の詳細情報を確認する時
- 商品の承認待ち状態を確認する時
- 商品のデータ更新状況を確認する時
- 商品のレビュー状況を確認する時

**優先度**: 中

**商品カテゴリの優先順位** ✅ **2026年追加 - 段階的展開**:
- **Phase 1（最優先）**: ペットの餌（food）
- **Phase 2（次優先）**: ペットのトイレ用品（litter）
- **Phase 3（その他）**: その他の用品（toy, cage, accessory, insuranceなど）

---

### ADM-007: 商品承認（運営）
**As a** 運営者  
**I want to** ユーザーが投稿した商品を承認する  
**So that** 商品データベースを充実させられる

**受け入れ基準**:
- 承認待ちの商品一覧が表示される
- 商品情報を確認できる
- 商品画像を確認できる
- 承認後、isVerified: trueになる
- アフィリエイトリンクを付与できる
- 承認を拒否できる（理由を記録）
- 承認履歴が記録される

**体験価値**:
- **効率性**: 承認待ちの商品を一覧で確認でき、効率的に承認できる
- **品質管理**: 商品情報を確認してから承認することで、データベースの品質を保てる

**使用シーン**:
- ユーザーが投稿した商品を承認する時
- 商品データベースを充実させる時
- 不適切な商品を拒否する時

**優先度**: 低

---

### ADM-008: 商品データベースの管理（運営）
**As a** 運営者  
**I want to** 商品データベースを管理する  
**So that** 商品情報の正確性を保ち、ユーザーに価値ある情報を提供できる

**受け入れ基準**:
- 商品一覧が表示される
- 商品を検索できる
- 商品情報を編集できる
- 商品を削除できる（論理削除）
- アフィリエイトリンクを管理できる
- 商品の統計情報（レビュー数、平均評価など）が表示される

**体験価値**:
- **品質管理**: 商品情報の正確性を保つために、商品を管理できる
- **効率性**: 検索機能により、特定の商品を素早く見つけられる

**使用シーン**:
- 商品情報を更新する時
- 不適切な商品を削除する時
- 商品データベースの統計を確認する時

**優先度**: 低

---

## ユーザー管理機能

### ADM-009: ユーザー一覧表示（管理者）
**As a** 管理者  
**I want to** ユーザー一覧を表示する  
**So that** ユーザーの状況を把握できる

**受け入れ基準**:
- ユーザー一覧が表示される
- ユーザーを検索できる
- ユーザーの詳細情報（登録日、プレミアム状態など）が表示される
- ユーザーの活動状況（記録数、ログイン頻度など）が表示される

**体験価値**:
- **可視性**: ユーザーの状況を把握できる
- **効率性**: 検索機能により、特定のユーザーを素早く見つけられる

**使用シーン**:
- ユーザーの状況を確認する時
- サポート対応の際にユーザー情報を確認する時

**優先度**: 低

---

### ADM-010: プレミアム会員の管理（管理者）
**As a** 管理者  
**I want to** プレミアム会員の状況を管理する  
**So that** サブスクリプションの状況を把握できる

**受け入れ基準**:
- プレミアム会員一覧が表示される
- サブスクリプションの状態（active/canceled/past_due/trialing）が表示される
- 猶予期間（Grace Period）の状況が表示される
- サブスクリプションの統計情報が表示される

**体験価値**:
- **可視性**: プレミアム会員の状況を把握できる
- **分析**: サブスクリプションの統計情報により、ビジネス状況を分析できる

**使用シーン**:
- プレミアム会員の状況を確認する時
- サブスクリプションの統計を分析する時

**優先度**: 低

---

## 統計・分析機能

### ADM-011: アプリの統計情報表示（管理者）
**As a** 管理者  
**I want to** アプリの統計情報を表示する  
**So that** サービスの状況を把握できる

**受け入れ基準**:
- ユーザー数、アクティブユーザー数が表示される
- プレミアム会員数、解約率が表示される
- 記録数、画像アップロード数が表示される
- AIチャットの利用状況が表示される
- 期間を選択して統計を表示できる

**体験価値**:
- **可視性**: サービスの状況を把握できる
- **分析**: 統計情報により、ビジネス状況を分析できる

**使用シーン**:
- サービスの状況を確認する時
- ビジネス状況を分析する時
- レポートを作成する時

**優先度**: 低

---

### ADM-012: Convexリソース監視ダッシュボード表示（管理者） ✅ **2026年追加 - サービス停止防止**
**As a** 管理者  
**I want to** Convexのリソース使用状況をダッシュボードで確認する  
**So that** サービスが停止する前に適切な対策を講じられる

**受け入れ基準**:
- データベースの総レコード数が表示される（テーブル別の内訳も表示）
- ストレージ使用量（GB）が表示される
- 月間のAction実行数が表示される
- 各リソースの使用率（無料枠に対する割合）が表示される
- リソース使用状況の推移グラフが表示される（過去30日間）
- 閾値（80%、90%、95%）を超えた場合に警告表示される
- 各リソースの残り容量が表示される

**体験価値**:
- **予兆検知**: リソースの枯渇を事前に検知できる
- **安心感**: サービスが突然停止するリスクを回避できる
- **計画性**: リソース使用状況に基づいて、データ削除やプラン変更のタイミングを判断できる

**使用シーン**:
- 毎日のリソース使用状況を確認する時
- リソース使用率が高くなってきた時
- データ削除やプラン変更を検討する時

**優先度**: 高（サービス停止防止のため）

---

### ADM-013: Discord日報送信設定と履歴確認（管理者） ✅ **2026年追加 - 自動レポート**
**As a** 管理者  
**I want to** Discordへの日報送信を設定し、送信履歴を確認する  
**So that** 毎日のアプリの状況を自動で把握できる

**受け入れ基準**:
- Discord Webhook URLを設定できる
- 日報の送信時刻を設定できる（デフォルト: 朝9時）
- 日報の送信内容をカスタマイズできる（含める項目の選択）
- 日報の送信履歴が表示される（送信日時、成功/失敗、エラーメッセージ）
- 日報の送信を一時停止/再開できる
- テスト送信ができる（手動で日報を送信）

**日報の送信内容**:
- 📊 ユーザーアクティビティ（新規登録、アクティブユーザー、プレミアム移行）
- 📝 記録統計（日記、トイレ、餌、リマインダー完了率）
- 💰 ビジネス・システム（Amazon API更新、ポイント発行総数、エラーログ発生）
- 🚨 システム健全性（APIレスポンス平均、エラーログ数、外部API生存確認）

**体験価値**:
- **自動化**: 毎日の状況を自動で把握できる
- **効率性**: 手動で統計を確認する手間が省ける
- **即時性**: 問題が発生した際にすぐに気づける

**使用シーン**:
- 毎日のアプリの状況を確認する時
- Discord日報の設定を変更する時
- 日報が正常に送信されているか確認する時

**優先度**: 中

---

### ADM-014: Better Stack連携設定（管理者） ✅ **2026年追加 - 高度な監視**
**As a** 管理者  
**I want to** Better Stackと連携してログ送信と監視を設定する  
**So that** より高度な監視と分析ができる

**受け入れ基準**:
- Better Stack LogsのHTTP Source URLを設定できる
- Better Stack API Tokenを設定できる
- Better Stack UptimeのHeartbeat URLを設定できる
- ログ送信の有効/無効を切り替えられる
- 送信するログの種類を選択できる（ビジネスメトリクス、エラーログ、パフォーマンスログなど）
- Better Stackへの送信履歴が表示される（送信日時、成功/失敗、エラーメッセージ）
- Better Stackダッシュボードへのリンクが表示される

**Better Stackの活用方法**:
- **構造化ログ**: 日記投稿、リマインダー完了、プレミアム登録などのイベントを構造化ログとして送信
- **Heartbeat監視**: ConvexのCronが正常に動作していることを確認（日報送信の完了を報告）
- **アラート設定**: Better Stack側でSQLクエリベースのアラートを設定（例: db_rowsが40,000を超えたら通知）

**体験価値**:
- **分析の容易さ**: Better Stack上でSQLクエリを使って深い分析ができる
- **信頼性**: アプリがダウンしていても、Better Stackが外部から監視してくれる
- **拡張性**: 将来的に「ユーザーが何曜日の何時に一番日記を書いているか」などの分析が可能

**使用シーン**:
- Better Stackとの連携を設定する時
- Better Stackでログを分析する時
- システムの健全性を監視する時

**優先度**: 中

---

### ADM-015: アラート設定（管理者） ✅ **2026年追加 - リソース枯渇防止**
**As a** 管理者  
**I want to** リソース使用率が閾値を超えた際にアラートを受け取る  
**So that** サービスが停止する前に適切な対策を講じられる

**受け入れ基準**:
- 各リソース（DB容量、ストレージ、Action実行数）の閾値を設定できる
- 閾値のレベル（警告、注意、緊急）を設定できる
- アラートの通知先を設定できる（Discord、メールなど）
- アラートの送信履歴が表示される（送信日時、リソース、閾値、通知先）
- アラートの送信を一時停止/再開できる
- アラート発生時の自動対策を設定できる（例: 古いログの自動削除、Cron頻度の自動調整）

**アラートの種類**:
- **警告（80%）**: リソース使用率が80%に達した際に通知
- **注意（90%）**: リソース使用率が90%に達した際に通知
- **緊急（95%）**: リソース使用率が95%に達した際に通知（@everyoneメンション付き）

**自動対策の例**:
- **データ圧縮**: 1年以上前のログを自動でアーカイブまたは削除
- **クロール制限**: Amazon APIの更新頻度を自動で下げる（1日1回→3日に1回）
- **オンデマンド無効化**: 一時的にオンデマンド更新を停止し、キャッシュされたデータを使用

**体験価値**:
- **予兆検知**: リソースの枯渇を事前に検知できる
- **自動化**: アラート発生時に自動で対策を実行できる
- **安心感**: サービスが突然停止するリスクを回避できる

**使用シーン**:
- リソース使用率の閾値を設定する時
- アラートの通知先を変更する時
- アラート発生時の自動対策を設定する時

**優先度**: 高（サービス停止防止のため）

---

## 優先度マトリックス

### Phase 1（必須）
- ADM-001: コラム投稿（高）
- ADM-004: キュレーション記事の登録（高）

### Phase 2（高優先度）
- ADM-002: AI執筆サポート（中）
- ADM-005: キュレーション記事の編集・削除（中）

### Phase 3（低優先度）
- ADM-003: 記事の信頼性チェック（低）
- ADM-006: 商品一覧・詳細閲覧（中）✅ **2026年追加**
- ADM-007: 商品承認（低）
- ADM-008: 商品データベースの管理（低）
- ADM-009: ユーザー一覧表示（低）
- ADM-010: プレミアム会員の管理（低）
- ADM-011: アプリの統計情報表示（低）
- ADM-012: Convexリソース監視ダッシュボード表示（高）✅ **2026年追加 - サービス停止防止**
- ADM-013: Discord日報送信設定と履歴確認（中）✅ **2026年追加 - 自動レポート**
- ADM-014: Better Stack連携設定（中）✅ **2026年追加 - 高度な監視**
- ADM-015: アラート設定（高）✅ **2026年追加 - リソース枯渇防止**

---

## エピック

### Epic ADM-1: コラム・記事管理機能
- ADM-001: コラム投稿
- ADM-002: AI執筆サポート
- ADM-003: 記事の信頼性チェック

### Epic ADM-2: キュレーション記事管理機能
- ADM-004: キュレーション記事の登録
- ADM-005: キュレーション記事の編集・削除

### Epic ADM-3: 商品データベース管理機能
- ADM-006: 商品一覧・詳細閲覧 ✅ **2026年追加**
- ADM-007: 商品承認
- ADM-008: 商品データベースの管理

### Epic ADM-4: ユーザー管理機能
- ADM-009: ユーザー一覧表示
- ADM-010: プレミアム会員の管理

### Epic ADM-5: 統計・分析機能
- ADM-011: アプリの統計情報表示

### Epic ADM-6: 監視・アラート機能 ✅ **2026年追加 - サービス停止防止**
- ADM-012: Convexリソース監視ダッシュボード表示
- ADM-013: Discord日報送信設定と履歴確認
- ADM-014: Better Stack連携設定
- ADM-015: アラート設定
