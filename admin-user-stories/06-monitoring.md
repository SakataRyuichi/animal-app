# Epic ADM-6: 監視・アラート機能

**📚 インデックス**: [ADMIN_USER_STORIES_INDEX.md](../ADMIN_USER_STORIES_INDEX.md)

## 監視・アラート機能

### ADM-012: Convexリソース監視ダッシュボード表示（管理者） ✅ **2026年追加 - サービス停止防止**
**As a** 管理者  
**I want to** Convexのリソース使用状況をダッシュボードで確認する  
**So that** サービスが停止する前に適切な対策を講じられる

**受け入れ基準**:
- データベースの総レコード数が表示される（テーブル別の内訳も表示）
- ストレージ使用量（GB）が表示される
- 月間のAction実行数が表示される
- 各リソースの使用率（無料枠に対する割合）が表示される
- リソース使用状況の推移グラフが表示される（過去30日間）
- 閾値（80%、90%、95%）を超えた場合に警告表示される
- 各リソースの残り容量が表示される

**体験価値**:
- **予兆検知**: リソースの枯渇を事前に検知できる
- **安心感**: サービスが突然停止するリスクを回避できる
- **計画性**: リソース使用状況に基づいて、データ削除やプラン変更のタイミングを判断できる

**使用シーン**:
- 毎日のリソース使用状況を確認する時
- リソース使用率が高くなってきた時
- データ削除やプラン変更を検討する時

**優先度**: 高（サービス停止防止のため）

---

---

### ADM-013: Discord日報送信設定と履歴確認（管理者） ✅ **2026年追加 - 自動レポート**
**As a** 管理者  
**I want to** Discordへの日報送信を設定し、送信履歴を確認する  
**So that** 毎日のアプリの状況を自動で把握できる

**受け入れ基準**:
- Discord Webhook URLを設定できる
- 日報の送信時刻を設定できる（デフォルト: 朝9時）
- 日報の送信内容をカスタマイズできる（含める項目の選択）
- 日報の送信履歴が表示される（送信日時、成功/失敗、エラーメッセージ）
- 日報の送信を一時停止/再開できる
- テスト送信ができる（手動で日報を送信）

**日報の送信内容**:
- 📊 ユーザーアクティビティ（新規登録、アクティブユーザー、プレミアム移行）
- 📝 記録統計（日記、トイレ、餌、リマインダー完了率）
- 💰 ビジネス・システム（Amazon API更新、ポイント発行総数、エラーログ発生）
- 🚨 システム健全性（APIレスポンス平均、エラーログ数、外部API生存確認）

**体験価値**:
- **自動化**: 毎日の状況を自動で把握できる
- **効率性**: 手動で統計を確認する手間が省ける
- **即時性**: 問題が発生した際にすぐに気づける

**使用シーン**:
- 毎日のアプリの状況を確認する時
- Discord日報の設定を変更する時
- 日報が正常に送信されているか確認する時

**優先度**: 中

---

---

### ADM-014: Better Stack連携設定（管理者） ✅ **2026年追加 - 高度な監視**
**As a** 管理者  
**I want to** Better Stackと連携してログ送信と監視を設定する  
**So that** より高度な監視と分析ができる

**受け入れ基準**:
- Better Stack LogsのHTTP Source URLを設定できる
- Better Stack API Tokenを設定できる
- Better Stack UptimeのHeartbeat URLを設定できる
- ログ送信の有効/無効を切り替えられる
- 送信するログの種類を選択できる（ビジネスメトリクス、エラーログ、パフォーマンスログなど）
- Better Stackへの送信履歴が表示される（送信日時、成功/失敗、エラーメッセージ）
- Better Stackダッシュボードへのリンクが表示される

**Better Stackの活用方法**:
- **構造化ログ**: 日記投稿、リマインダー完了、プレミアム登録などのイベントを構造化ログとして送信
- **Heartbeat監視**: ConvexのCronが正常に動作していることを確認（日報送信の完了を報告）
- **アラート設定**: Better Stack側でSQLクエリベースのアラートを設定（例: db_rowsが40,000を超えたら通知）

**体験価値**:
- **分析の容易さ**: Better Stack上でSQLクエリを使って深い分析ができる
- **信頼性**: アプリがダウンしていても、Better Stackが外部から監視してくれる
- **拡張性**: 将来的に「ユーザーが何曜日の何時に一番日記を書いているか」などの分析が可能

**使用シーン**:
- Better Stackとの連携を設定する時
- Better Stackでログを分析する時
- システムの健全性を監視する時

**優先度**: 中

---

---

### ADM-015: アラート設定（管理者） ✅ **2026年追加 - リソース枯渇防止**
**As a** 管理者  
**I want to** リソース使用率が閾値を超えた際にアラートを受け取る  
**So that** サービスが停止する前に適切な対策を講じられる

**受け入れ基準**:
- 各リソース（DB容量、ストレージ、Action実行数）の閾値を設定できる
- 閾値のレベル（警告、注意、緊急）を設定できる
- アラートの通知先を設定できる（Discord、メールなど）
- アラートの送信履歴が表示される（送信日時、リソース、閾値、通知先）
- アラートの送信を一時停止/再開できる
- アラート発生時の自動対策を設定できる（例: 古いログの自動削除、Cron頻度の自動調整）

**アラートの種類**:
- **警告（80%）**: リソース使用率が80%に達した際に通知
- **注意（90%）**: リソース使用率が90%に達した際に通知
- **緊急（95%）**: リソース使用率が95%に達した際に通知（@everyoneメンション付き）

**自動対策の例**:
- **データ圧縮**: 1年以上前のログを自動でアーカイブまたは削除
- **クロール制限**: Amazon APIの更新頻度を自動で下げる（1日1回→3日に1回）
- **オンデマンド無効化**: 一時的にオンデマンド更新を停止し、キャッシュされたデータを使用

**体験価値**:
- **予兆検知**: リソースの枯渇を事前に検知できる
- **自動化**: アラート発生時に自動で対策を実行できる
- **安心感**: サービスが突然停止するリスクを回避できる

**使用シーン**:
- リソース使用率の閾値を設定する時
- アラートの通知先を変更する時
- アラート発生時の自動対策を設定する時

**優先度**: 高（サービス停止防止のため）

---

