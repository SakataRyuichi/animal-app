# AIチャット免責事項（ディスクレイマー）設計書

**📚 ドキュメントインデックス**: [DOCUMENTATION_INDEX.md](./DOCUMENTATION_INDEX.md)

**関連ドキュメント**:
- [CONVEX_SCHEMA.md](./CONVEX_SCHEMA.md): chat_messagesテーブルの定義
- [AI_CHAT_REVIEW.md](./AI_CHAT_REVIEW.md): AIチャット機能のレビュー
- [USER_STORIES.md](./USER_STORIES.md): US-020〜US-025（AI相談機能）

## 設計目的

AIチャット機能において「AIは誤った情報を生成する可能性がある」という免責事項を明示することで、信頼性と誠実さを担保します。特にペットの健康や飼育に関わるアドバイスを行う場合、ユーザーの安心とリスク管理の両面で不可欠な設計要素となります。

---

## 1. UI/UX設計：表示のタイミングと配置

ユーザーがAIを過信しすぎないよう、かつアプリの「温かみ」を損なわない形で、3つのポイントで表示します。

### A. チャット画面の下部に常駐（フッター）✅

最も一般的な設計です。メッセージ入力欄のすぐ下、またはチャットの末尾に、控えめなサイズで表示します。

**文言例**:
```
AIは時として不正確な回答をすることがあります。特に医療や健康に関する重要な判断は獣医師にご相談ください。
```

**デザイン要件**:
- フォントサイズ: 12px程度（控えめ）
- 色: グレー系（#888888など）
- アイコン: ℹ️ または 💡
- 背景: 透明または薄いグレー（#F5F5F5）

### B. 初回利用時のウェルカムメッセージ ✅

初めてチャットを開いた際に、AI自身が自己紹介と共に「できないこと」を伝えます。

**UXフロー**:
1. ユーザーが初めてチャット画面を開く
2. AIが自動的にウェルカムメッセージを送信
3. メッセージ内に免責事項を含める

**文言例**:
```
こんにちは！${petName}くんの記録を元にアドバイスします。

私はAIなので、間違いを言ってしまうこともあります。特に医療や健康に関する重要な判断は、必ず専門家（獣医師）にも確認してくださいね。

それでは、何かお困りのことがあれば、お気軽にご相談ください。
```

**デザイン要件**:
- AIメッセージのスタイルで表示
- 免責事項部分は少し小さめのフォントで表示
- アイコン: 💡 または ℹ️

### C. 回答ごとの注釈（インライン）✅

特定のキーワード（「病気」「薬」「症状」など）が含まれる回答の最後に、自動的に警告アイコンと共に注釈を添えます。

**表示条件**:
- `disclaimerType`が`medical`、`food`、または`emergency`の場合
- 回答の最後に自動的に追加

**文言例（medical）**:
```
💡 この回答は一般的な情報提供を目的としており、診断や治療を保証するものではありません。気になる症状がある場合は、必ず獣医師にご相談ください。
```

**文言例（food）**:
```
💡 フードやサプリメントの選択は、ペットの個体差や健康状態によって異なります。新しいフードに切り替える際は、かかりつけの獣医師にご相談ください。
```

**文言例（emergency）**:
```
🚨 緊急時は、すぐに動物病院に連絡してください。この回答は一般的な情報提供であり、緊急時の対応を保証するものではありません。
```

**デザイン要件**:
- 回答の最後に小さなボックスとして表示
- 背景色: 薄い黄色（#FFF9E6）または薄いグレー（#F5F5F5）
- ボーダー: 1px solid #E0E0E0
- パディング: 8px 12px
- フォントサイズ: 11-12px

---

## 2. テーブル設計

`chat_messages`テーブルに免責事項の表示状態を記録します。

### スキーマ定義

```typescript
chat_messages: defineTable({
  threadId: v.id("chat_threads"),
  role: v.union(v.literal("user"), v.literal("assistant")),
  content: v.string(),
  citedSources: v.optional(v.array(v.id("knowledge_base"))),
  
  // ✅ 免責事項表示の管理
  disclaimerShown: v.boolean(), // 免責事項を表示したかどうかのフラグ
  disclaimerType: v.optional(
    v.union(
      v.literal("general"), // 一般的な免責事項
      v.literal("medical"), // 医療・健康に関する免責事項
      v.literal("food"), // 食事・栄養に関する免責事項
      v.literal("emergency") // 緊急時の免責事項
    )
  ),
}).index("by_thread", ["threadId"]),
```

### 免責事項タイプの判定ロジック

```typescript
function determineDisclaimerType(
  userMessage: string,
  aiResponse: string
): "general" | "medical" | "food" | "emergency" {
  const message = (userMessage + " " + aiResponse).toLowerCase();
  
  // 緊急時のキーワード
  const emergencyKeywords = [
    "誤飲", "誤食", "中毒", "けいれん", "意識", 
    "呼吸困難", "大量出血", "倒れた", "動かない"
  ];
  if (emergencyKeywords.some((kw) => message.includes(kw))) {
    return "emergency";
  }
  
  // 医療・健康のキーワード
  const medicalKeywords = [
    "病気", "症状", "治療", "薬", "診断", "病院", 
    "獣医", "痛み", "発熱", "下痢", "嘔吐", "腫れ", 
    "炎症", "感染", "ウイルス", "細菌"
  ];
  if (medicalKeywords.some((kw) => message.includes(kw))) {
    return "medical";
  }
  
  // 食事・栄養のキーワード
  const foodKeywords = [
    "フード", "食事", "栄養", "サプリメント", "おやつ", 
    "食べ物", "給餌", "ドッグフード", "キャットフード", 
    "レシピ", "手作り"
  ];
  if (foodKeywords.some((kw) => message.includes(kw))) {
    return "food";
  }
  
  // デフォルトは一般的な免責事項
  return "general";
}
```

---

## 3. システムプロンプトでの制御

AIへの基本命令文（システムプロンプト）に免責事項とガードレールを含めます。

### システムプロンプトの例

```typescript
const systemPrompt = `あなたはペットの健康管理をサポートするAIアシスタントです。

【重要な免責事項とガードレール】
- あなたは獣医師ではありません。診断を下さず、あくまで一般的なアドバイスと受診の目安を提示してください。
- 緊急度が高い場合は、必ず動物病院への受診を推奨してください。
- 回答には引用元を明示してください。
- 医療的な判断が必要な場合は、必ず「この判断は専門家（獣医師）にご相談ください」という一文を回答の最後に含めてください。
- 薬物や治療法について具体的な指示は行わず、一般的な情報提供にとどめてください。
- 誤った情報を提供する可能性があることを常に意識し、不確実な場合は「確実な情報ではないため、専門家にご確認ください」と明記してください。

飼い主情報:
- 名前: ${currentUser.name || "飼い主さん"}

ペット情報:
- 名前: ${pet.name}
- 種別: ${pet.species}
- 品種: ${pet.breed || "不明"}
- 年齢: ${ageDisplay}
- 体重: ${pet.weight || "不明"}g
${pet.memorialStatus 
  ? `- メモリアルモード: このペットは虹の橋を渡りました（命日: ${new Date(pet.memorialStatus.deceasedDate).toLocaleDateString("ja-JP")}）\n- 注意: 過去の記録に基づいたアドバイスを提供しますが、現在の状態に関する質問には対応できません。`
  : ""}

直近の記録:
${recentActivities.length > 0 
  ? recentActivities.map((a) => `- ${a.type}: ${JSON.stringify(a.payload)}`).join("\n")
  : "- 記録がありません。より詳しいアドバイスのために、日々の記録を続けてください。"}

参考知識:
${knowledgeResults.map((k) => `- ${k.title}: ${k.content}`).join("\n")}`;
```

---

## 4. 動的な警告表示（リアルタイム）

ユーザーが入力中に、専門的なキーワードを検出した場合、入力欄の上にそっと注意書きを表示します。

### 実装例（フロントエンド）

```typescript
// 入力中のテキストを監視
const [inputText, setInputText] = useState("");
const [showWarning, setShowWarning] = useState(false);

useEffect(() => {
  const medicalKeywords = ["病気", "症状", "治療", "薬", "診断"];
  const hasMedicalKeyword = medicalKeywords.some((kw) => 
    inputText.toLowerCase().includes(kw)
  );
  
  setShowWarning(hasMedicalKeyword);
}, [inputText]);

// UI表示
{showWarning && (
  <View style={styles.warningBanner}>
    <Text style={styles.warningIcon}>💡</Text>
    <Text style={styles.warningText}>
      専門的なアドバイスは控えさせていただきます。重要な判断は獣医師にご相談ください。
    </Text>
  </View>
)}
```

### デザイン要件

- 位置: 入力欄の上、メッセージ一覧の下
- 背景色: 薄い黄色（#FFF9E6）
- ボーダー: 1px solid #FFD700（薄い黄色のボーダー）
- アニメーション: フェードイン（0.3秒）
- 自動非表示: 5秒後、またはユーザーが入力欄をタップした時

---

## 5. デザインの方向性（Pencil用）

### カラーパレット

- **警告色**: 赤（#FF0000）ではなく、薄い黄色（#FFF9E6）またはグレー（#F5F5F5）
- **テキスト色**: グレー（#888888）またはダークグレー（#666666）
- **ボーダー色**: 薄いグレー（#E0E0E0）または薄い黄色（#FFD700）

### アイコン

- ⚠️マークよりも、💡（電球）やℹ️（情報）マークを使用
- アプリのトーン＆マナーに合わせて、温かみのあるデザイン

### タイポグラフィ

- フォントサイズ: 11-12px（控えめ）
- フォントウェイト: Regular（太字にしない）
- 行間: 1.4-1.5（読みやすさを重視）

---

## 6. 実装チェックリスト

### バックエンド（Convex）
- [ ] `chat_messages`テーブルに`disclaimerShown`と`disclaimerType`フィールドを追加
- [ ] `determineDisclaimerType`関数を実装
- [ ] システムプロンプトに免責事項とガードレールを追加
- [ ] `chat` actionで免責事項タイプを自動判定して保存

### フロントエンド（React Native）
- [ ] チャット画面のフッターに常駐免責事項を表示
- [ ] 初回利用時のウェルカムメッセージを実装
- [ ] 回答ごとのインライン注釈を実装（`disclaimerType`に応じて）
- [ ] 入力中のリアルタイム警告を実装
- [ ] 免責事項の文言を多言語対応（将来的に）

### UI/UX
- [ ] デザインシステムに免責事項のスタイルを追加
- [ ] アイコン（💡、ℹ️）のアセットを準備
- [ ] アニメーション（フェードイン）を実装

---

## 7. 免責事項の文言（テンプレート）

### 一般的な免責事項（general）

```
AIは時として不正確な回答をすることがあります。特に医療や健康に関する重要な判断は獣医師にご相談ください。
```

### 医療・健康に関する免責事項（medical）

```
💡 この回答は一般的な情報提供を目的としており、診断や治療を保証するものではありません。気になる症状がある場合は、必ず獣医師にご相談ください。
```

### 食事・栄養に関する免責事項（food）

```
💡 フードやサプリメントの選択は、ペットの個体差や健康状態によって異なります。新しいフードに切り替える際は、かかりつけの獣医師にご相談ください。
```

### 緊急時の免責事項（emergency）

```
🚨 緊急時は、すぐに動物病院に連絡してください。この回答は一般的な情報提供であり、緊急時の対応を保証するものではありません。
```

---

## 8. ユーザーストーリーとの連携

### US-020: AI相談の開始
- ✅ 初回利用時に免責事項を表示
- ✅ チャット画面のフッターに常駐表示

### US-021: ペットのカルテ情報を活用した相談
- ✅ 医療的な内容の場合、`medical`タイプの免責事項を表示

### US-022: 信頼できる知識ベースからの回答
- ✅ 引用元と合わせて免責事項を表示

### US-023: 緊急度の判定と病院案内
- ✅ 緊急時は`emergency`タイプの免責事項を表示

---

## 9. 法的・安全上の考慮事項

### 免責事項の法的効果

- 免責事項は法的責任を完全に免除するものではありません
- ただし、ユーザーに適切な注意喚起を行うことで、リスクを軽減できます
- 特に医療に関する情報提供については、獣医師法などの規制に注意が必要

### 推奨される追加対策

1. **利用規約への明記**: アプリの利用規約にAIチャット機能の免責事項を明記
2. **初回起動時の同意**: アプリ初回起動時に「このAI機能は情報提供のみを目的としており、獣医師の診断に代わるものではありません」という同意を得る
3. **定期的な更新**: 免責事項の文言を定期的に見直し、必要に応じて更新

---

## 10. 次のステップ

1. **Pencilでのデザイン作成**: チャット画面のデザインに免責事項を組み込む
2. **実装**: バックエンドとフロントエンドの実装
3. **テスト**: 各種シナリオでの免責事項表示をテスト
4. **ユーザーフィードバック**: 実際のユーザーから免責事項の分かりやすさについてフィードバックを収集
