# ç”»åƒä¿å­˜æˆ¦ç•¥

**ğŸ“š ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**: [DOCUMENTATION_INDEX.md](./DOCUMENTATION_INDEX.md)

**é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**:
- [CONVEX_SCHEMA.md](./CONVEX_SCHEMA.md): imagesãƒ†ãƒ¼ãƒ–ãƒ«ã®å®šç¾©
- [PREMIUM_FEATURES.md](./PREMIUM_FEATURES.md): ç”»åƒç®¡ç†ã®ãƒ—ãƒ¬ãƒŸã‚¢ãƒ æ©Ÿèƒ½
- [USER_STORIES.md](./USER_STORIES.md): US-051ã€œUS-054ï¼ˆç”»åƒç®¡ç†æ©Ÿèƒ½ï¼‰

**ä½œæˆæ—¥**: 2026å¹´2æœˆ1æ—¥  
**ç›®çš„**: Convexã®ãƒ—ãƒ©ã‚¤ã‚·ãƒ³ã‚°ã‚’è€ƒæ…®ã—ãŸç”»åƒä¿å­˜æˆ¦ç•¥ã¨ã€ãƒ—ãƒ¬ãƒŸã‚¢ãƒ æ©Ÿèƒ½ã¨ã—ã¦ã®ç”»åƒç®¡ç†æ©Ÿèƒ½ã®è¨­è¨ˆ

---

## 1. Convexã®ç„¡æ–™æ ã¨åˆ¶é™

### 1.1 Convexç„¡æ–™ãƒ—ãƒ©ãƒ³ã®åˆ¶é™

- **Database Storage**: 1 GB
- **File Storage**: 1 GB
- **Monthly Bandwidth**: 10 GB
- **Monthly Computes**: 10ä¸‡å›ï¼ˆFunctionã®å®Ÿè¡Œå›æ•°ï¼‰

### 1.2 ç”»åƒãƒ‡ãƒ¼ã‚¿é‡ã®è©¦ç®—

**å‰ææ¡ä»¶**:
- ã‚¹ãƒãƒ›ç”»åƒ1æšã‚ãŸã‚Šï¼ˆåœ§ç¸®å‰ï¼‰: 3MB ã€œ 6MBï¼ˆJPEG/HEICï¼‰
- WebPå½¢å¼ï¼ˆåœ§ç¸®å¾Œï¼‰:
  - è¡¨ç¤ºç”¨ï¼ˆPreviewï¼‰: ç´„250KB ã€œ 500KBï¼ˆå¹…1080pxã€Quality 0.6-0.7ï¼‰
  - æœ€é«˜ç”»è³ªï¼ˆOriginalï¼‰: ç´„1.5MB ã€œ 3MBï¼ˆãƒªã‚µã‚¤ã‚ºãªã—ã€Quality 0.9-1.0ï¼‰

**1ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚ãŸã‚Šã®æœˆé–“ãƒ‡ãƒ¼ã‚¿é‡**ï¼ˆ1æ—¥1æšã€æœˆ30æšã¨ä»®å®šï¼‰:
- è¡¨ç¤ºç”¨ã®ã¿: 30æš Ã— 500KB = 15MB / æœˆ
- æœ€é«˜ç”»è³ªã‚‚ä¿å­˜: 30æš Ã— 2.5MB = 75MB / æœˆ

**ç„¡æ–™æ ï¼ˆ1GBï¼‰ã§è€ãˆã‚‰ã‚Œã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°**:
- è¡¨ç¤ºç”¨ã®ã¿: ç´„66,000ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆ1ãƒ¶æœˆåˆ†ï¼‰
- æœ€é«˜ç”»è³ªã‚‚ä¿å­˜: ç´„13,000ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆ1ãƒ¶æœˆåˆ†ï¼‰

---

## 2. ãƒ•ãƒªãƒ¼ï¼ˆç„¡æ–™ï¼‰ã¨ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã®å¢ƒç•Œç·š

| æ©Ÿèƒ½ | ãƒ•ãƒªãƒ¼ï¼ˆç„¡æ–™ï¼‰ | ãƒ—ãƒ¬ãƒŸã‚¢ãƒ  | ç‹™ã„ |
|------|---------------|-----------|------|
| **åŸºæœ¬ã®è¨˜éŒ²** | ç„¡åˆ¶é™ï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰ | ç„¡åˆ¶é™ | æ¯æ—¥ä½¿ã£ã¦ã‚‚ã‚‰ã„ã€é›¢è„±ã‚’é˜²ãï¼ˆç¿’æ…£åŒ–ï¼‰ |
| **ç”»åƒä¿å­˜** | ç´¯è¨ˆ50æšã¾ã§ï¼ˆç´„25MBï¼‰ã¾ãŸã¯ç›´è¿‘1ãƒ¶æœˆåˆ†ã®ã¿è¡¨ç¤º | ç„¡åˆ¶é™ï¼ˆã¾ãŸã¯å¤§å®¹é‡ï¼‰ | Convexã®File Storageã‚³ã‚¹ãƒˆã‚’è»¢å« |
| **ç”»åƒç”»è³ª** | è¡¨ç¤ºç”¨WebPï¼ˆ500KBç¨‹åº¦ï¼‰ã®ã¿ | æœ€é«˜ç”»è³ªWebPï¼ˆæ•°MBï¼‰ã‚‚ä¿å­˜ãƒ»è¡¨ç¤ºå¯èƒ½ | ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚³ã‚¹ãƒˆã®å›å |
| **ç”»åƒç·¨é›†** | ç·¨é›†å¾Œã®ç”»åƒã®ã¿ä¿å­˜ï¼ˆç·¨é›†å‰ã¯å‰Šé™¤ï¼‰ | ç·¨é›†å‰ãƒ»ç·¨é›†å¾Œã®ä¸¡æ–¹ã‚’ä¿å­˜ï¼ˆéç ´å£Šç·¨é›†ï¼‰ | ä»˜åŠ ä¾¡å€¤ã®æä¾› |
| **ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰** | è¡¨ç¤ºç”¨WebPã®ã¿ï¼ˆã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒãƒ¼ã‚¯ä»˜ãï¼‰ | æœ€é«˜ç”»è³ªWebPï¼ˆã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒãƒ¼ã‚¯ãªã—ï¼‰ã€ä¸€æ‹¬ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ | åç›ŠåŒ–ã¨ä»˜åŠ ä¾¡å€¤ |
| **AIãƒãƒ£ãƒƒãƒˆ** | ãªã—ï¼ˆã¾ãŸã¯1æ—¥1å›ï¼‰ | ç„¡åˆ¶é™ | APIã‚³ã‚¹ãƒˆã®å›åã¨ä»˜åŠ ä¾¡å€¤ã®æä¾› |
| **å®¶æ—å…±æœ‰** | 2äººã¾ã§ | ç„¡åˆ¶é™ï¼ˆè¦ªæˆšã‚‚æ‹›å¾…å¯ï¼‰ | ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã®æ‹¡å¤§ã¨å®šç€ |
| **ãƒ‡ãƒ¼ã‚¿æ›¸ãå‡ºã—** | ãªã— | PDF/CSVå‡ºåŠ› | ã€Œå¤§åˆ‡ãªè¨˜éŒ²ã‚’æ®‹ã—ãŸã„ã€å±¤ã®ç²å¾— |

---

## 3. ç”»åƒä¿å­˜ã®è¨­è¨ˆæ€æƒ³

### 3.1 ãƒ€ãƒ–ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æ§‹é€ 

**ã€Œæ¸©ã‹ã¿ã¨èª å®Ÿã•ã€ã‚’æ„Ÿã˜ã•ã›ã‚‹è¨­è¨ˆ**:
- ç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸç”»åƒã‚‚ã€**è£ã§æœ€é«˜ç”»è³ªãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜**
- ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ãŸç¬é–“ã€éå»ã®å…¨ã¦ã®å†™çœŸãŒç¾ã—ããªã‚‹ã€Œãƒã‚¸ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ¡ãƒ³ãƒˆã€ã‚’å®Ÿç¾
- ã€Œãƒ‡ãƒ¼ã‚¿ã¯æ¶ˆã—ã¦ã„ãªã„ï¼ˆæ¸©ã‹ã¿ï¼‰ã€ã¨ã€Œä»Šã™ãã¯è¦‹ã‚‰ã‚Œãªã„ï¼ˆåˆ¶é™ï¼‰ã€ã‚’ä¸¡ç«‹

### 3.2 WebPå½¢å¼ã®æ¡ç”¨

**2026å¹´ã®ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªé–‹ç™ºã«ãŠã„ã¦ã€WebPã¯å¿…é ˆã®æ¨™æº–**:
- JPEG/PNGã¨æ¯”è¼ƒã—ã¦ã€åŒç­‰ã®ç”»è³ªã§25%ã€œ34%ã‚‚è»½é‡
- Convexã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æ–™é‡‘ã‚’æŠ‘ãˆã‚‰ã‚Œã‚‹
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é€šä¿¡é‡ï¼ˆã‚®ã‚¬ï¼‰ã®ç¯€ç´„
- ã‚¢ãƒ—ãƒªã®èª­ã¿è¾¼ã¿é€Ÿåº¦ï¼ˆUXï¼‰ã®å‘ä¸Š

### 3.3 ç”»åƒç·¨é›†æ©Ÿèƒ½ã®è¨­è¨ˆ

**Instagramã®ã‚ˆã†ãªç·¨é›†æ©Ÿèƒ½**:
- **ç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼**: ç·¨é›†å¾Œã®ç”»åƒã®ã¿ä¿å­˜ï¼ˆç·¨é›†å‰ã¯ä¸Šæ›¸ãã¾ãŸã¯å‰Šé™¤ï¼‰
- **ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼**:
  - ç·¨é›†å‰ï¼ˆæœ€é«˜ç”»è³ªï¼‰
  - ç·¨é›†å¾Œï¼ˆè¡¨ç¤ºç”¨WebPï¼‰
  - ç·¨é›†ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚¹ã‚¿ãƒ³ãƒ—ã®ä½ç½®ã‚„æ–‡å­—ã®å†…å®¹ï¼‰
  - å¾Œã‹ã‚‰ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å‹•ã‹ã—ãŸã‚Šæ–‡å­—ã‚’æ›¸ãæ›ãˆãŸã‚Šã§ãã‚‹ã€Œéç ´å£Šç·¨é›†ã€

---

## 4. ã‚¹ã‚­ãƒ¼ãƒè¨­è¨ˆ

### 4.1 imagesãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ–°è¦è¿½åŠ ï¼‰

ç”»åƒã‚’ä¸€å…ƒç®¡ç†ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```typescript
// convex/schema.ts
images: defineTable({
  userId: v.id("users"),
  petId: v.optional(v.id("pets")), // ãƒšãƒƒãƒˆé–¢é€£ã®ç”»åƒã®å ´åˆ
  activityId: v.optional(v.id("activities")), // æ´»å‹•ãƒ­ã‚°é–¢é€£ã®ç”»åƒã®å ´åˆ

  // 1. è¡¨ç¤ºç”¨ï¼ˆç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚‚å‚ç…§å¯èƒ½ / 500KBç¨‹åº¦ï¼‰
  previewStorageId: v.string(), // WebPå½¢å¼ã€å¹…1080pxã€Quality 0.6-0.7
  
  // 2. æœ€é«˜ç”»è³ªï¼ˆãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿å‚ç…§å¯èƒ½ / æ•°MBä»¥ä¸Šï¼‰
  originalStorageId: v.string(), // WebPå½¢å¼ã€ãƒªã‚µã‚¤ã‚ºãªã—ã€Quality 0.9-1.0
  
  // 3. ç·¨é›†ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã®ã¿ï¼šã‚¹ã‚¿ãƒ³ãƒ—ã®ä½ç½®ãªã©ï¼‰
  editMetadata: v.optional(
    v.object({
      // ç·¨é›†å‰ã®ã‚ªãƒªã‚¸ãƒŠãƒ«ï¼ˆç·¨é›†ã‚’å…ƒã«æˆ»ã™ãŸã‚ï¼‰
      originalBeforeEditStorageId: v.optional(v.string()),
      // ã‚¹ã‚¿ãƒ³ãƒ—ã®ä½ç½®ãƒ»ç¨®é¡
      stamps: v.optional(
        v.array(
          v.object({
            type: v.string(), // ã‚¹ã‚¿ãƒ³ãƒ—ã®ç¨®é¡
            x: v.number(), // Xåº§æ¨™
            y: v.number(), // Yåº§æ¨™
            scale: v.number(), // ã‚¹ã‚±ãƒ¼ãƒ«
            rotation: v.number(), // å›è»¢è§’åº¦
          })
        )
      ),
      // æ–‡å­—ã®ä½ç½®ãƒ»å†…å®¹
      texts: v.optional(
        v.array(
          v.object({
            content: v.string(), // æ–‡å­—å†…å®¹
            x: v.number(), // Xåº§æ¨™
            y: v.number(), // Yåº§æ¨™
            fontSize: v.number(), // ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º
            color: v.string(), // è‰²ï¼ˆHEXï¼‰
            fontFamily: v.string(), // ãƒ•ã‚©ãƒ³ãƒˆãƒ•ã‚¡ãƒŸãƒªãƒ¼
          })
        )
      ),
    })
  ),
  
  // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
  width: v.number(), // ã‚ªãƒªã‚¸ãƒŠãƒ«ã®å¹…
  height: v.number(), // ã‚ªãƒªã‚¸ãƒŠãƒ«ã®é«˜ã•
  fileSizeOriginal: v.number(), // ã‚ªãƒªã‚¸ãƒŠãƒ«ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºï¼ˆãƒã‚¤ãƒˆï¼‰
  fileSizePreview: v.number(), // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºï¼ˆãƒã‚¤ãƒˆï¼‰
  format: v.string(), // "webp"
  
  // ç·¨é›†çŠ¶æ…‹
  hasEdits: v.boolean(), // ç·¨é›†ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹
  isPremiumAtUpload: v.boolean(), // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹ï¼ˆãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã‹ã©ã†ã‹ï¼‰
  
  // å‰Šé™¤çŠ¶æ…‹
  deletion: deletionSchema,
  
  createdAt: v.number(),
})
  .index("by_user", ["userId"])
  .index("by_pet", ["petId"])
  .index("by_activity", ["activityId"])
  .index("by_user_active", ["userId", "deletion"]), // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªç”»åƒã®ã¿å–å¾—ç”¨
```

### 4.2 usersãƒ†ãƒ¼ãƒ–ãƒ«ã®æ‹¡å¼µ

ç”»åƒåˆ¶é™ã‚’ç®¡ç†ã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```typescript
users: defineTable({
  // ... æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  
  // ç”»åƒåˆ¶é™ç®¡ç†
  imageCount: v.number(), // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®ç´¯è¨ˆæšæ•°ï¼ˆç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åˆ¶é™ãƒã‚§ãƒƒã‚¯ç”¨ï¼‰
  imageStorageUsedBytes: v.number(), // ä½¿ç”¨ä¸­ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡ï¼ˆãƒã‚¤ãƒˆï¼‰
  
  // ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†
  subscription: v.object({
    tier: v.union(v.literal("free"), v.literal("premium")),
    status: v.union(
      v.literal("active"),
      v.literal("canceled"),
      v.literal("past_due"),
      v.literal("trialing")
    ),
    endsAt: v.optional(v.number()),
    gracePeriodEndsAt: v.optional(v.number()),
    revenueCatUserId: v.optional(v.string()),
  }),
}),
```

### 4.3 activitiesãƒ†ãƒ¼ãƒ–ãƒ«ã®æ›´æ–°

`payload.images`ã‚’`imageIds`ï¼ˆ`images`ãƒ†ãƒ¼ãƒ–ãƒ«ã®IDé…åˆ—ï¼‰ã«å¤‰æ›´ã—ã¾ã™ã€‚

```typescript
activities: defineTable({
  // ... æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  
  payload: v.object({
    // å…±é€š
    imageIds: v.optional(v.array(v.id("images"))), // ç”»åƒIDã®é…åˆ—ï¼ˆimagesãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®å‚ç…§ï¼‰
    text: v.optional(v.string()),
    
    // ... ãã®ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  }),
}),
```

---

## 5. ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ»å‡¦ç†ãƒ•ãƒ­ãƒ¼

### 5.1 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆExpoï¼‰ã§ã®å‡¦ç†

```typescript
// apps/expo/utils/imageProcessor.ts
import * as ImageManipulator from 'expo-image-manipulator';

/**
 * ç”»åƒã‚’2ç¨®é¡ã®WebPã«å¤‰æ›
 * 1. è¡¨ç¤ºç”¨ï¼ˆPreviewï¼‰: å¹…1080pxã€Quality 0.6-0.7
 * 2. æœ€é«˜ç”»è³ªï¼ˆOriginalï¼‰: ãƒªã‚µã‚¤ã‚ºãªã—ã€Quality 0.9-1.0
 */
export async function processImageForUpload(uri: string) {
  // 1. è¡¨ç¤ºç”¨ WebP ã®ç”Ÿæˆï¼ˆè»½é‡ï¼‰
  const preview = await ImageManipulator.manipulateAsync(
    uri,
    [{ resize: { width: 1080 } }],
    { compress: 0.6, format: ImageManipulator.SaveFormat.WEBP }
  );

  // 2. æœ€é«˜ç”»è³ª WebP ã®ç”Ÿæˆï¼ˆé«˜ç²¾ç´°ï¼‰
  const original = await ImageManipulator.manipulateAsync(
    uri,
    [], // ãƒªã‚µã‚¤ã‚ºãªã—
    { compress: 0.9, format: ImageManipulator.SaveFormat.WEBP }
  );

  return {
    preview: {
      uri: preview.uri,
      width: preview.width,
      height: preview.height,
      fileSize: await getFileSize(preview.uri),
    },
    original: {
      uri: original.uri,
      width: original.width,
      height: original.height,
      fileSize: await getFileSize(original.uri),
    },
  };
}
```

### 5.2 ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆConvex Actionï¼‰ã§ã®å‡¦ç†

```typescript
// packages/backend/convex/actions/uploadImage.ts
import { action } from "./_generated/server";
import { v } from "convex/values";
import { api } from "./_generated/api";

export const uploadImage = action({
  args: {
    petId: v.optional(v.id("pets")),
    activityId: v.optional(v.id("activities")),
    previewFile: v.string(), // Base64ã¾ãŸã¯Blob
    originalFile: v.string(), // Base64ã¾ãŸã¯Blob
    width: v.number(),
    height: v.number(),
    fileSizeOriginal: v.number(),
    fileSizePreview: v.number(),
  },
  handler: async (ctx, args) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) throw new Error("èªè¨¼ãŒå¿…è¦ã§ã™");

    const user = await ctx.runQuery(api.users.getCurrentUser);

    // ç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã€ç”»åƒæšæ•°åˆ¶é™ã‚’ãƒã‚§ãƒƒã‚¯
    if (user.subscription.tier === "free") {
      const FREE_IMAGE_LIMIT = 50; // ç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ç´¯è¨ˆ50æšã¾ã§
      if (user.imageCount >= FREE_IMAGE_LIMIT) {
        throw new Error("IMAGE_LIMIT_REACHED");
      }
    }

    // Convex File Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    const previewStorageId = await ctx.storage.store(
      Buffer.from(args.previewFile, "base64")
    );
    const originalStorageId = await ctx.storage.store(
      Buffer.from(args.originalFile, "base64")
    );

    // imagesãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜
    const imageId = await ctx.runMutation(api.images.create, {
      userId: user._id,
      petId: args.petId,
      activityId: args.activityId,
      previewStorageId,
      originalStorageId,
      width: args.width,
      height: args.height,
      fileSizeOriginal: args.fileSizeOriginal,
      fileSizePreview: args.fileSizePreview,
      format: "webp",
      hasEdits: false,
      isPremiumAtUpload: user.subscription.tier === "premium",
    });

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç”»åƒã‚«ã‚¦ãƒ³ãƒˆã‚’æ›´æ–°
    await ctx.runMutation(api.users.incrementImageCount, {
      userId: user._id,
      imageStorageUsedBytes: args.fileSizeOriginal + args.fileSizePreview,
    });

    return imageId;
  },
});
```

---

## 6. ç”»åƒè¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯

### 6.1 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã®è¡¨ç¤º

```typescript
// packages/ui/src/components/PetImage.tsx
import { useQuery, useStorageUrl } from "convex/react";
import { api } from "@repo/backend/convex/_generated/api";

export function PetImage({ imageId }: { imageId: Id<"images"> }) {
  const user = useQuery(api.users.getCurrentUser);
  const image = useQuery(api.images.getById, { imageId });

  if (!image || !user) return null;

  // ãƒ—ãƒ¬ãƒŸã‚¢ãƒ åˆ¤å®š
  const isPremium = user.subscription.tier === "premium" && 
    (user.subscription.status === "active" || 
     user.subscription.status === "trialing" ||
     (user.subscription.status === "past_due" && 
      user.subscription.gracePeriodEndsAt && 
      Date.now() < user.subscription.gracePeriodEndsAt));

  // ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãªã‚‰ã‚ªãƒªã‚¸ãƒŠãƒ«ã€ãã†ã§ãªã‘ã‚Œã°ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®URLã‚’å–å¾—
  const storageId = isPremium 
    ? image.originalStorageId 
    : image.previewStorageId;
  
  const imageUrl = useStorageUrl(storageId);

  return (
    <View>
      <Image source={{ uri: imageUrl }} style={styles.petPhoto} />
      {!isPremium && (
        <Text style={styles.hint}>
          ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã«å…¥ã‚‹ã¨ã€{Math.round(image.fileSizeOriginal / 1024 / 1024 * 10) / 10}MB ã®æœ€é«˜ç”»è³ªã§è¡¨ç¤ºãƒ»ä¿å­˜ã§ãã¾ã™
        </Text>
      )}
      {!isPremium && image.isPremiumAtUpload && (
        <Text style={styles.hint}>
          ğŸ’ ã“ã®å†™çœŸã¯æœ€é«˜ç”»è³ªã§ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã§è¡¨ç¤ºã§ãã¾ã™
        </Text>
      )}
    </View>
  );
}
```

---

## 7. ç”»åƒç·¨é›†æ©Ÿèƒ½ã®è¨­è¨ˆ

### 7.1 ç·¨é›†ãƒ•ãƒ­ãƒ¼

1. **ç·¨é›†ç”»é¢ã‚’é–‹ã**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç”»åƒã‚’é¸æŠã—ã€ç·¨é›†ç”»é¢ã‚’é–‹ã
2. **ã‚¹ã‚¿ãƒ³ãƒ—ãƒ»æ–‡å­—ã‚’è¿½åŠ **: Expoã®`expo-pixi`ã‚„`react-native-canvas`ã‚’ä½¿ç”¨
3. **ç·¨é›†å®Œäº†**: `view-shot`ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ç·¨é›†å¾Œã®ç”»åƒã‚’WebPã¨ã—ã¦æ›¸ãå‡ºã—
4. **ä¿å­˜**: 
   - **ç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼**: ç·¨é›†å¾Œã®ç”»åƒã®ã¿ä¿å­˜ï¼ˆç·¨é›†å‰ã¯å‰Šé™¤ï¼‰
   - **ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼**: ç·¨é›†å‰ãƒ»ç·¨é›†å¾Œã®ä¸¡æ–¹ã‚’ä¿å­˜ã€ç·¨é›†ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚‚ä¿å­˜

### 7.2 ç·¨é›†ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜

ç·¨é›†ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹ã“ã¨ã§ã€å¾Œã‹ã‚‰ç·¨é›†ã‚’ã‚„ã‚Šç›´ã—ãŸã‚Šã€ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å‹•ã‹ã—ãŸã‚Šã§ãã¾ã™ã€‚

```typescript
// ç·¨é›†ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ä¾‹
{
  originalBeforeEditStorageId: "storage_xxx", // ç·¨é›†å‰ã®ã‚ªãƒªã‚¸ãƒŠãƒ«
  stamps: [
    {
      type: "crown",
      x: 100,
      y: 200,
      scale: 1.0,
      rotation: 0,
    },
  ],
  texts: [
    {
      content: "ãƒãƒãã‚“",
      x: 150,
      y: 250,
      fontSize: 24,
      color: "#FFFFFF",
      fontFamily: "Arial",
    },
  ],
}
```

---

## 8. ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½

### 8.1 ç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼

- è¡¨ç¤ºç”¨WebPã®ã¿ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½
- ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒãƒ¼ã‚¯ï¼ˆã‚¢ãƒ—ãƒªãƒ­ã‚´ï¼‰ã‚’è¿½åŠ 
- ä¸€æ‹¬ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¯ä¸å¯

### 8.2 ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼

- æœ€é«˜ç”»è³ªWebPï¼ˆã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒãƒ¼ã‚¯ãªã—ï¼‰ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½
- ç·¨é›†å‰ã®ã€Œç´ ã€ã®çŠ¶æ…‹ã®ã‚ªãƒªã‚¸ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿ã‚‚ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½
- ä¸€æ‹¬ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ï¼ˆ1ãƒ¶æœˆåˆ†ã‚’ã¾ã¨ã‚ã¦ä¿å­˜ãªã©ï¼‰

---

## 9. AIãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã®è¨­è¨ˆ

### 9.1 ç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼

- AIãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã¯åˆ©ç”¨ä¸å¯ï¼ˆã¾ãŸã¯1æ—¥1å›ã®ã¿ï¼‰
- ä»£ã‚ã‚Šã«ã€ã‚³ãƒ©ãƒ ãƒ»è¨˜äº‹ã®é–²è¦§ã‚’æ¨å¥¨

### 9.2 ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼

- AIãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã‚’ç„¡åˆ¶é™ã«åˆ©ç”¨å¯èƒ½
- ãƒšãƒƒãƒˆã®éå»1é€±é–“ã®ãƒ­ã‚°ï¼ˆé£Ÿäº‹é‡ã€ä¾¿ã®æ§˜å­ãªã©ï¼‰ã‚’AIã«èª­ã¿è¾¼ã¾ã›ãŸä¸Šã§å›ç­”
- ã€Œã†ã¡ã®å­å°‚ç”¨ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ã€åŒ–

### 9.3 ã‚³ã‚¹ãƒˆç®¡ç†

- ç°¡å˜ãªè³ªå•ã¯å®‰ä¾¡ãªãƒ¢ãƒ‡ãƒ«ï¼ˆClaude Haikuãªã©ï¼‰ã§å‡¦ç†
- è¤‡é›‘ãªè³ªå•ã¯é«˜ä¾¡ãªãƒ¢ãƒ‡ãƒ«ï¼ˆGPT-4oã€Claude Opusãªã©ï¼‰ã§å‡¦ç†
- ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨­è¨ˆã§ã‚³ã‚¹ãƒˆã‚’æœ€é©åŒ–

---

## 10. åˆ¶é™ã®å‡ºã—æ–¹ï¼ˆUXè¨­è¨ˆï¼‰

### 10.1 ã€Œç¦æ­¢ã€ã§ã¯ãªãã€Œå¾Œå›ã—ã€

ç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚‚ç”»åƒã¯ã‚¢ãƒƒãƒ—ã§ãã‚‹ãŒã€50æšã‚’è¶…ãˆã‚‹ã¨ï¼š
- ã€Œå¤ã„å†™çœŸã‹ã‚‰ã¼ã‹ã—ï¼ˆBlurï¼‰ãŒã‹ã‹ã‚Šã€ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã«ãªã‚‹ã¨å¾©å…ƒã§ãã‚‹ã€ã¨ã„ã†è¦‹ã›æ–¹
- ã€Œãƒ‡ãƒ¼ã‚¿ã¯æ¶ˆã—ã¦ã„ãªã„ï¼ˆæ¸©ã‹ã¿ï¼‰ã€ã¨ã€Œä»Šã™ãã¯è¦‹ã‚‰ã‚Œãªã„ï¼ˆåˆ¶é™ï¼‰ã€ã‚’ä¸¡ç«‹

### 10.2 ã€ŒAIã‹ã‚‰ã®æ‹›å¾…ã€

ãƒšãƒƒãƒˆã®ä½“èª¿è¨˜éŒ²ãŒ3æ—¥ç¶šã„ãŸã‚‰ã€AIã‹ã‚‰ï¼š
- ã€Œ3æ—¥é–“é ‘å¼µã‚Šã¾ã—ãŸã­ï¼ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãªã‚‰ã€ã“ã®è¨˜éŒ²ã‹ã‚‰ãƒ¬ã‚ªãã‚“ã®å¥åº·è¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œã‚Œã¾ã™ã‚ˆã€ã¨ã€æ–‡è„ˆã«æ²¿ã£ãŸææ¡ˆã‚’å‡ºã™

### 10.3 è¦–è¦šçš„ãªæ¡ˆå†…

- ãƒ—ãƒ¬ãƒŸã‚¢ãƒ æ©Ÿèƒ½ã®æ¨ªã«å°ã•ãªéµã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡¨ç¤º
- ç”»åƒã‚’æ‹¡å¤§ã—ãŸéš›ã€ã€Œãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãªã‚‰ Ultra HD ã§è¡¨ç¤ºãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€ã¨ã„ã†æ¡ˆå†…ã‚’å‡ºã™
- ç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç”»é¢ã§ã¯ã€å†™çœŸã®éš…ã«ã€ŒSDï¼ˆæ¨™æº–ç”»è³ªï¼‰ã€ã¨ã„ã†å°ã•ãªãƒ©ãƒ™ãƒ«ã‚’è¡¨ç¤º

---

## 11. ã‚³ã‚¹ãƒˆè©¦ç®—

### 11.1 ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚³ã‚¹ãƒˆ

**ã‚·ãƒŠãƒªã‚ª**: ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆMAUï¼‰1,000äººã®å ´åˆ
- å…¨å“¡ãŒãƒªã‚µã‚¤ã‚ºæ¸ˆã¿ç”»åƒï¼ˆè¡¨ç¤ºç”¨500KB + æœ€é«˜ç”»è³ª2.5MBï¼‰ã‚’æœˆ30æšã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

**æœˆé–“ã®æ–°è¦ãƒ‡ãƒ¼ã‚¿å¢—åˆ†**: 1,000äºº Ã— 90MB = 90 GB / æœˆ

**1å¹´å¾Œã®ç·ãƒ‡ãƒ¼ã‚¿é‡**: 90GB Ã— 12ãƒ¶æœˆ = 1,080 GB

**ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æœˆé¡è²»ç”¨ï¼ˆ1å¹´å¾Œï¼‰**:
- File Storage: 1,080 GB Ã— $0.20 = $216 / æœˆï¼ˆç´„32,400å††ï¼‰

### 11.2 åç›ŠåŒ–ã®ç›®å®‰

1,000äººã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã†ã¡ã€3ã€œ5%ï¼ˆ30ã€œ50äººï¼‰ãŒæœˆé¡500å††ã®ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ã«å…¥ã‚Œã°ï¼š
- æœˆé¡åç›Š: 30ã€œ50äºº Ã— 500å†† = 15,000å†† ã€œ 25,000å††
- ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚³ã‚¹ãƒˆ: ç´„32,400å††ï¼ˆ1å¹´å¾Œï¼‰

**çµè«–**: ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä¼šå“¡ç‡ã‚’5%ä»¥ä¸Šã«ç¶­æŒã§ãã‚Œã°ã€ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚³ã‚¹ãƒˆã‚’å›åå¯èƒ½

---

## 12. å®Ÿè£…ã®å„ªå…ˆé †ä½

### Phase 1ï¼ˆå¿…é ˆï¼‰

1. **ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ï¼ˆWebPå¤‰æ›ï¼‰**
   - Expoã§ã®ç”»åƒå‡¦ç†ï¼ˆè¡¨ç¤ºç”¨ãƒ»æœ€é«˜ç”»è³ªã®2ç¨®é¡ï¼‰
   - Convexã¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
   - `images`ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ

2. **ç”»åƒè¡¨ç¤ºæ©Ÿèƒ½**
   - ãƒ—ãƒ¬ãƒŸã‚¢ãƒ åˆ¤å®šã«å¿œã˜ãŸç”»åƒURLã®åˆ‡ã‚Šæ›¿ãˆ
   - ãƒ—ãƒ¬ãƒŸã‚¢ãƒ æ¡ˆå†…ã®è¡¨ç¤º

3. **ç”»åƒæšæ•°åˆ¶é™**
   - ç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç´¯è¨ˆ50æšåˆ¶é™
   - åˆ¶é™åˆ°é”æ™‚ã®æ¡ˆå†…

### Phase 2ï¼ˆé«˜å„ªå…ˆåº¦ï¼‰

4. **ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½**
   - ãƒ—ãƒ¬ãƒŸã‚¢ãƒ é™å®šã§æœ€é«˜ç”»è³ªãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
   - ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒãƒ¼ã‚¯ã®è¿½åŠ ï¼ˆç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰

5. **ç”»åƒç·¨é›†æ©Ÿèƒ½ï¼ˆåŸºæœ¬ï¼‰**
   - ã‚¹ã‚¿ãƒ³ãƒ—ãƒ»æ–‡å­—å…¥ã‚Œæ©Ÿèƒ½
   - ç·¨é›†å¾Œã®ç”»åƒä¿å­˜

### Phase 3ï¼ˆä¸­å„ªå…ˆåº¦ï¼‰

6. **ç”»åƒç·¨é›†æ©Ÿèƒ½ï¼ˆé«˜åº¦ï¼‰**
   - éç ´å£Šç·¨é›†ï¼ˆç·¨é›†ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ï¼‰
   - ç·¨é›†ã®ã‚„ã‚Šç›´ã—æ©Ÿèƒ½

7. **ä¸€æ‹¬ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½**
   - ãƒ—ãƒ¬ãƒŸã‚¢ãƒ é™å®šã§1ãƒ¶æœˆåˆ†ã‚’ã¾ã¨ã‚ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

---

## 13. AIãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã®è¨­è¨ˆ

### 13.1 ç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼

- AIãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã¯åˆ©ç”¨ä¸å¯ï¼ˆã¾ãŸã¯1æ—¥1å›ã®ã¿ï¼‰
- ä»£ã‚ã‚Šã«ã€ã‚³ãƒ©ãƒ ãƒ»è¨˜äº‹ã®é–²è¦§ã‚’æ¨å¥¨

### 13.2 ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼

- AIãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã‚’ç„¡åˆ¶é™ã«åˆ©ç”¨å¯èƒ½
- ãƒšãƒƒãƒˆã®éå»1é€±é–“ã®ãƒ­ã‚°ï¼ˆé£Ÿäº‹é‡ã€ä¾¿ã®æ§˜å­ãªã©ï¼‰ã‚’AIã«èª­ã¿è¾¼ã¾ã›ãŸä¸Šã§å›ç­”
- ã€Œã†ã¡ã®å­å°‚ç”¨ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ã€åŒ–

### 13.3 ã‚³ã‚¹ãƒˆç®¡ç†

- ç°¡å˜ãªè³ªå•ã¯å®‰ä¾¡ãªãƒ¢ãƒ‡ãƒ«ï¼ˆClaude Haikuãªã©ï¼‰ã§å‡¦ç†
- è¤‡é›‘ãªè³ªå•ã¯é«˜ä¾¡ãªãƒ¢ãƒ‡ãƒ«ï¼ˆGPT-4oã€Claude Opusãªã©ï¼‰ã§å‡¦ç†
- ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨­è¨ˆã§ã‚³ã‚¹ãƒˆã‚’æœ€é©åŒ–

### 13.4 å®Ÿè£…æ–¹é‡

**ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆConvex Actionï¼‰**:
```typescript
import { assertPremium } from "./lib/permissions";

export const chat = action({
  args: {
    petId: v.id("pets"),
    threadId: v.id("chat_threads"),
    message: v.string(),
  },
  handler: async (ctx, args) => {
    // ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä¼šå“¡ã§ã‚ã‚‹ã“ã¨ã‚’è¦æ±‚
    await assertPremium(ctx);
    
    // AIç›¸è«‡ã®å‡¦ç†
    // ...
  },
});
```

**ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆReactï¼‰**:
```typescript
import { PremiumGuard } from "@repo/ui";

export default function AIChatScreen() {
  return (
    <PremiumGuard>
      <AIChatContent />
    </PremiumGuard>
  );
}
```

---

## 14. å‚è€ƒãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- `CONVEX_SCHEMA.md`: ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ï¼ˆ`images`ãƒ†ãƒ¼ãƒ–ãƒ«ã€`users.subscription`ï¼‰
- `USER_STORIES.md`: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ï¼ˆç”»åƒé–¢é€£: US-051ã€œUS-054ã€AIç›¸è«‡: US-020ã€œUS-025ï¼‰
- `PREMIUM_FEATURES.md`: ãƒ—ãƒ¬ãƒŸã‚¢ãƒ é™å®šæ©Ÿèƒ½ãƒªã‚¹ãƒˆ
- `packages/backend/convex/lib/permissions.ts`: æ¨©é™ç®¡ç†ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
- `packages/backend/convex/lib/imageLimits.ts`: ç”»åƒåˆ¶é™ç®¡ç†ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
