# Cursor エージェントガイドライン

このドキュメントは、Cursorエージェントがこのプロジェクトで作業する際のガイドラインです。

## プロジェクト概要

ペット管理アプリ（iOS/Android）のモノレポプロジェクトです。

### ディレクトリ構成

```
my-pet-platform/
├── apps/
│   ├── expo/                # モバイルアプリ (React Native Expo)
│   │   ├── app/            # Expo Router (画面定義)
│   │   └── components/    # アプリ専用UI
│   └── admin/              # ローカル専用管理画面 (Next.js)
│       ├── app/            # App Router
│       └── components/      # 管理画面専用UI
├── packages/
│   ├── backend/            # バックエンド (Convex) - 独立パッケージ
│   │   ├── convex/         # スキーマ、関数、AIアクション
│   │   └── package.json
│   ├── ui/                 # 共通UIコンポーネント (Tamagui)
│   ├── utils/              # 共通ロジック (ビジネスロジック)
│   └── tsconfig/           # TypeScript共通設定
├── package.json            # ルートの依存関係・ワークスペース定義
├── turbo.json              # Turborepoのタスクパイプライン設定
└── pnpm-workspace.yaml     # pnpmのモノレポ定義
```

### 技術スタック

- **フロントエンド**: React Native Expo (モバイル), Next.js (管理画面)
- **バックエンド**: Convex (`packages/backend/` - 独立パッケージ)
- **認証**: Clerk
- **モノレポ**: Turborepo + pnpm
- **UI**: Tamagui (`packages/ui/`で共通化)

## エージェントの使い方

### Plan Modeの活用

大きな機能追加や複数ファイルにわたる変更の場合は、**Plan Mode** (`Shift+Tab`)を使用してください。

1. **探索**: コードベースを調査し、関連ファイルを見つける
2. **計画**: 詳細な実装プランを作成（ファイルパス、コード参照を含む）
3. **承認待ち**: 実装前にユーザーの承認を待つ
4. **実装**: 承認後に実装を開始

小さな変更（タイポ修正、ログ追加、変数名変更など）は、Plan Modeをスキップして直接実装してください。

### コンテキスト管理

- **ファイル参照**: `@filename`を使用してファイルを参照
- **エージェントに探索を任せる**: プロンプト内ですべてのファイルに手動でタグ付けする必要はありません。エージェントが必要に応じてコンテキストを取得します
- **MCP (Model Context Protocol) の活用**: 
  - `packages/backend/convex/schema.ts` と `packages/backend/convex/_generated/api.d.ts` を常に参照可能にする
  - モノレポ構造を理解し、`apps/expo`で作業する際は`packages/backend`のスキーマを自動で参照
  - 最新のConvex/Expo SDKドキュメントをMCP経由で検索可能にする
- **新しい会話を始めるタイミング**:
  - 別のタスクや機能に移るとき
  - エージェントが混乱している、または同じ間違いを繰り返すとき
  - ひとつの論理的な作業単位が完了したとき

### 検証可能な目標を提供

エージェントが自分の作業を検証できるように、以下を提供してください：

- **テスト**: テストケースを書かせる、または既存のテストを実行させる
- **型チェック**: `pnpm typecheck`を実行して型エラーを確認
- **リント**: `pnpm lint`を実行してコード品質を確認
- **スクリーンショット**: UI変更の場合は、スクリーンショットで視覚的に確認

## 開発フロー

### 1. コード変更

エージェントにコード変更を依頼する際は、以下を明確に指定してください：

- **対象ファイル**: どのファイルを変更するか
- **変更内容**: 何を実装するか
- **制約**: 既存のパターンに従う、特定のライブラリを使用するなど

### 2. 自動検証（開発後）

コード変更後は、以下のコマンドを自動で実行してください：

- `/test`: テストを実行し、失敗があれば修正
- `/review`: コードレビューを実行
- `/lint`: ESLintを実行し、エラーがあれば修正
- `/typecheck`: TypeScriptの型チェックを実行

### 3. デバッグ

問題が発生した場合：

- **Debug Mode**: 再現可能なバグの場合は、Debug Modeを使用
- **ログ追加**: 問題の原因を特定するためにログを追加
- **テスト追加**: バグを再現するテストを追加してから修正

## モノレポでの作業

### パッケージの特定

作業対象のパッケージを明確にしてください：

- `apps/expo/`: React Native Expoアプリ
- `apps/admin/`: Next.js管理画面（ローカルのみ）
- `packages/backend/`: Convexバックエンド（独立パッケージ）
- `packages/ui/`: 共有UIコンポーネント（Tamagui）
- `packages/utils/`: 共有ロジック（ビジネスロジック）
- `packages/tsconfig/`: TypeScript共通設定

### 共有パッケージの活用

**重要原則**:
1. **バックエンドは独立パッケージ**: `packages/backend/`に配置し、`apps/expo`と`apps/admin`の両方から型安全に呼び出す
2. **UIコンポーネントは共通化**: `packages/ui/`にTamaguiコンポーネントを配置し、モバイルとWebの両方で使用
3. **ビジネスロジックは集約**: `packages/utils/`にビジネスロジックを集約し、計算結果のズレを防ぐ
4. **重複コードを避ける**: 既存の共有パッケージを確認してから、新しいコードを書く

**使用例**:
- モバイルアプリから: `import { api } from "@repo/backend/convex/_generated/api"`
- 管理画面から: `import { api } from "@repo/backend/convex/_generated/api"`
- UIコンポーネント: `import { Button } from "@repo/ui"`
- ユーティリティ: `import { calculateAge } from "@repo/utils"`

## 技術スタック固有の注意事項

### React Native / Expo

- Expo Routerのファイルベースルーティングに従う
- Tamaguiコンポーネントを使用（`packages/ui`から）
- ネイティブモジュールは使用前に確認（Expo Goで動作するか）

### Convex

- Query/Mutation/Actionの使い分けを理解する
- スキーマ定義（`CONVEX_SCHEMA.md`）を参照
- 型安全性を確保（`v`スキーマを使用）

### TypeScript

- 型定義を明示的に記述
- `any`は避ける
- 関数型プログラミングを優先

## エラーハンドリング

エラーが発生した場合：

1. **エラーメッセージを確認**: エラーの全文を読み、原因を特定
2. **関連ファイルを確認**: エラーが発生しているファイルとその依存関係を確認
3. **段階的に修正**: 一度にすべてを変更せず、段階的に修正
4. **検証**: 修正後、必ずテストまたは型チェックを実行

## パフォーマンス考慮事項

- **コンテキストウィンドウ**: 長い会話は避け、必要に応じて`/clear`を使用
- **ファイル読み込み**: 必要なファイルのみを読み込む
- **並列実行**: 複数のエージェントを並列実行する場合は、worktreeを使用

## 自動検証フロー

コード変更後は、以下のコマンドを使用して自動検証を実行できます：

- `/verify`: 包括的な検証（型チェック、リント、テスト）
- `/test`: テストのみ実行
- `/lint`: リントのみ実行
- `/typecheck`: 型チェックのみ実行
- `/review`: コードレビューを実行
- `/debug`: 問題をデバッグ

詳細は`.cursor/commands/`を参照してください。

## 参考ドキュメント

- **`SETUP_CHECKLIST.md`**: ⭐ **セットアップ前に必読** - 設定が必要な項目のチェックリスト
- **`USER_STORIES.md`**: ⭐ **開発の憲法** - ユーザーストーリー（AIへの指示に活用）
- `.cursor/README.md`: Cursor設定ファイルの説明
- `.cursor/MCP_SETUP.md`: MCP設定の詳細ガイド
- `TECH_STACK_PLANNING.md`: 技術選定の詳細
- `DESIGN_DOCUMENT.md`: アプリ設計の詳細
- `CONVEX_SCHEMA.md`: Convexスキーマ定義

### ユーザーストーリーの活用

`USER_STORIES.md`は「開発の憲法」として機能します。機能の実装を依頼する際は、以下のように指示してください：

```
ユーザーストーリードキュメントの US-009（トイレ記録）を実装して。
特に『受け入れ基準』にある視覚的なアイコン選択と、異常時のAI相談への導線を忘れずに。
『体験価値』にある『専門知識がなくても記録できる』UIを重視して作成して。
```

詳細は`USER_STORIES.md`の「AI（Cursor）への指示への活用」セクションを参照してください。
