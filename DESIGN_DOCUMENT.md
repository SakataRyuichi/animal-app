# アプリ設計ドキュメント（一次設計）

## 1. プロジェクト概要

### 1.1 アプリの目的
個人のペット管理から始まり、家族・チーム管理を経て、最終的にはペット特化のSNS兼商品データベースへと発展させるプラットフォーム。

### 1.2 ターゲットユーザー
- **Phase 1**: 個人のペット飼い主
- **Phase 2**: 家族・チームでペットを管理するユーザー
- **Phase 3**: ペットコミュニティ全体（飼い主、事業者、レビュアー）

### 1.3 フェーズ別ロードマップ

#### Phase 1: 個人管理・基礎構築
- ペットの基本情報管理
- 活動ログの記録（食事、トイレ、散歩、日記、ケア）
- 個人向けダッシュボード
- **コラム・記事機能** ✅ **信頼性向上・フック機能**
  - 専門家による信頼できる一次ソースに特化したコラム
  - ペット種別に合わせたレコメンデーション
  - AI執筆サポート（運営用）
- **AI相談機能（RAGベース）** ✅ **キラー機能**
  - ペットのカルテ情報を活用した相談
  - 信頼できる知識ベースからの回答生成
  - 緊急度判定と病院案内

#### Phase 2: 家族・チーム管理
- 複数人でのペット管理
- 共同管理者の追加・権限管理
- 家族間での情報共有
- AI相談機能の拡張（共同管理者からの相談）

#### Phase 3: ペット特化のSNS兼商品データベース
- **SNS機能** ✅ **2026年版モダンSNS**
  - 「フォロー中（Following）」と「おすすめ（For You）」のタブ切り替え
  - フォロー機能
  - いいね機能
  - AI（RAG）を活用した超パーソナライズ（オプション）
- 商品データベース
- 商品レビュー・評価
- ペット種別ごとの商品人気ランキング

---

## 2. データモデル設計

### 2.1 エンティティ一覧

#### 2.1.1 Users（ユーザー）
**目的**: アプリを利用するユーザー（個人/事業者）の情報を管理

**主要フィールド**:
- `tokenIdentifier`: 認証ID（Clerk）
- `name`: ユーザー名
- `email`: メールアドレス
- `type`: ユーザータイプ（個人/事業者）
- `isPremium`: プレミアム会員フラグ
- `location`: 地域情報（検索用）
- `businessInfo`: 事業者情報（事業者の場合）

**インデックス**:
- `by_token`: 認証IDでの検索

**ユースケース**:
- ユーザー登録・ログイン
- プロフィール管理
- プレミアム機能の有効化
- 事業者アカウントの管理

---

#### 2.1.2 Pets（ペット）
**目的**: ペットの基本情報とプロフィールを管理

**主要フィールド**:
- `ownerId`: 所有者（主管理者）
- `name`: ペット名
- `species`: 種別（犬、猫、爬虫類など）
- `breed`: 品種（ハスキー、レオパなど）
- `gender`: 性別
- `birthDate`: 誕生日
- `photoUrl`: プロフィール画像
- `weight`: 最新体重
- `isNeutered`: 去勢/避妊済みフラグ
- `origin`: 出自（ショップ、ブリーダー、里親など）
- `insurance`: 保険情報
- `bio`: 自己紹介
- `personality`: 性格タグ
- `visibility`: 公開設定（private/shared/public）

**インデックス**:
- `by_owner`: 所有者での検索
- `by_species_breed`: 種別・品種での検索
- `search_bio`: 全文検索（自己紹介）

**ユースケース**:
- ペット登録
- プロフィール編集
- ペット一覧表示
- 種別・品種での検索
- 公開設定の変更

---

#### 2.1.3 Pet Members（共同管理者）
**目的**: Phase 2で実装。1匹のペットを複数人で管理するためのリンクテーブル

**主要フィールド**:
- `petId`: ペットID
- `userId`: ユーザーID
- `role`: 権限（admin/editor/viewer）

**インデックス**:
- `by_pet`: ペットでの検索
- `by_user`: ユーザーでの検索

**ユースケース**:
- 家族メンバーの追加
- 権限の設定・変更
- 共同管理者一覧の表示
- 自分が管理できるペット一覧の取得

---

#### 2.1.4 Activities（活動ログ）
**目的**: ペットの日常活動を一元管理（食事、トイレ、散歩、日記、ケアなど）

**主要フィールド**:
- `petId`: ペットID
- `createdBy`: 記録者
- `loggedAt`: 記録日時（過去の日付登録も可能）
- `type`: ログタイプ（food/toilet/walk/health/diary/care）
- `payload`: 実際のデータ（柔軟な構造）
  - `images`: 画像配列
  - `text`: メモ・日記本文
  - `foodId`: 商品ID（食事ログ）
  - `amount`: 量（食事ログ）
  - `toiletType`: トイレタイプ（pee/poo）
  - `condition`: 状態（hard/soft/diarrhea）
  - `durationMin`: 時間（散歩ログ）
  - `distanceKm`: 距離（散歩ログ）
  - `careType`: ケアタイプ（nail/shampoo/vaccine）
- `isPublic`: 公開フラグ（Phase 3）
- `likeCount`: いいね数（Phase 3）

**インデックス**:
- `by_pet_date`: ペット・日時での検索（タイムライン表示用）
- `by_public_feed`: 公開フィード用（Phase 3）

**ユースケース**:
- 食事記録
- トイレ記録
- 散歩記録
- 日記投稿
- ケア記録
- タイムライン表示
- グローバルフィード表示（Phase 3）

---

#### 2.1.5 Products（商品データベース）
**目的**: Phase 3で実装。ペット用品のマスタデータ

**主要フィールド**:
- `name`: 商品名
- `category`: カテゴリ（food/toy/cageなど）
- `brand`: ブランド名
- `isVerified`: 運営確認済みフラグ
- `submittedBy`: 登録者
- `affiliateLink`: アフィリエイトURL
- `imageUrl`: 商品画像
- `averageRating`: 平均評価
- `reviewCount`: レビュー数

**インデックス**:
- `search_name`: 商品名での全文検索

**ユースケース**:
- 商品登録（ユーザー投稿）
- 商品検索
- 商品詳細表示
- 運営による商品承認
- アフィリエイトリンクの付与

---

#### 2.1.6 Reviews（商品レビュー）
**目的**: Phase 3で実装。商品に対するレビュー・評価

**主要フィールド**:
- `userId`: レビュアー
- `petId`: 使用したペット
- `productId`: 商品ID
- `rating`: 評価（1-5）
- `comment`: コメント
- `petSpecies`: ペット種別（集計用）
- `petBreed`: ペット品種（集計用）

**インデックス**:
- `by_product`: 商品での検索
- `by_species_product`: 種別・商品での検索（「猫に人気のフード」など）

**ユースケース**:
- レビュー投稿
- レビュー一覧表示
- 種別ごとの商品人気ランキング
- レビュー統計の集計

---

#### 2.1.7 Chat Threads（AIチャットスレッド）
**目的**: Phase 1後半 / Phase 2で実装。AI相談の会話スレッドを管理

**主要フィールド**:
- `userId`: ユーザーID
- `petId`: 相談対象のペットID
- `title`: スレッドタイトル（自動生成）
- `createdAt`: 作成日時

**インデックス**:
- `by_user_pet`: ユーザー・ペットでの検索（スレッド一覧）

**ユースケース**:
- チャットスレッド作成
- スレッド一覧表示
- スレッド削除

---

#### 2.1.8 Chat Messages（AIチャットメッセージ）
**目的**: Phase 1後半 / Phase 2で実装。AI相談のメッセージ履歴を管理

**主要フィールド**:
- `threadId`: スレッドID
- `role`: メッセージの役割（user/assistant）
- `content`: メッセージ内容
- `citedSources`: 引用した知識ベースのID配列

**インデックス**:
- `by_thread`: スレッドでの検索（メッセージ一覧）

**ユースケース**:
- メッセージ送信
- メッセージ履歴表示
- 引用元の表示

---

#### 2.1.9 Knowledge Base（知識ベース）
**目的**: Phase 1後半 / Phase 2で実装。RAG用の信頼できる知識データ

**主要フィールド**:
- `title`: 記事タイトル
- `content`: 記事本文
- `sourceUrl`: 情報元のURL（信頼性の担保）
- `category`: カテゴリ（Emergency/Food/Illnessなど）
- `embedding`: ベクトル埋め込み（1536次元）

**インデックス**:
- `by_embedding`: ベクトル検索インデックス（類似度検索用）

**ユースケース**:
- 知識データの投入（運営）
- ベクトル検索による関連知識の取得
- 引用元の表示

---

#### 2.1.10 Articles（コラム・記事）
**目的**: Phase 1後半 / Phase 2で実装。管理者・専門家による信頼できるコラム・記事

**主要フィールド**:
- `authorId`: 投稿者（管理者 or 認定獣医師）
- `title`: 記事タイトル
- `content`: 本文（Markdown形式推奨）
- `thumbnailUrl`: アイキャッチ画像
- `targetSpecies`: 対象種別（配列）
- `tags`: タグ（配列）
- `sources`: 一次ソースのリンク（信頼性の担保）
- `status`: 公開状態（draft/published）
- `isExpertContent`: 専門家による執筆フラグ

**インデックス**:
- `by_status_date`: 公開状態・日時での検索（公開記事を新しい順に）
- `by_species`: 種別でのフィルタリング
- `search_content`: 全文検索

**ユースケース**:
- コラム一覧表示
- コラム詳細表示
- 種別ごとのレコメンデーション
- 管理者用投稿機能

---

#### 2.1.11 Follows（フォロー関係）
**目的**: Phase 3で実装。ユーザー間のフォロー関係を管理

**主要フィールド**:
- `followerId`: フォローする人（フォロワー）
- `followingId`: フォローされる人（フォロイー）
- `createdAt`: フォロー開始日時

**インデックス**:
- `by_follower`: フォローしている人の一覧取得
- `by_following`: フォロワー一覧取得
- `by_follower_following`: フォロー関係の確認（重複防止）

**ユースケース**:
- フォロー・フォロー解除
- フォロー中フィードの取得
- フォロワー一覧表示

---

#### 2.1.12 Likes（いいね）
**目的**: Phase 3で実装。投稿へのいいねを管理

**主要フィールド**:
- `userId`: いいねしたユーザー
- `activityId`: いいねされた投稿（activities）
- `createdAt`: いいね日時

**インデックス**:
- `by_activity`: 投稿ごとのいいね一覧（いいね数カウント）
- `by_user_activity`: ユーザーがいいねしたかどうかの確認（重複防止）
- `by_user`: ユーザーがいいねした投稿一覧

**ユースケース**:
- いいね・いいね解除
- いいね数の表示
- 人気投稿の取得

---

## 3. データフロー設計

### 3.1 認証フロー
```
1. Clerkでログイン
2. Convexでユーザー存在確認
3. 存在しなければ users テーブルに作成
4. セッション確立
```

### 3.2 ペット登録フロー
```
1. ユーザーがペット情報を入力
2. pets テーブルに新規作成
3. ownerId に現在のユーザーIDを設定
4. ペット一覧に追加表示
```

### 3.3 活動ログ記録フロー
```
1. ユーザーが活動ログを入力
2. activities テーブルに新規作成
3. petId と createdBy を設定
4. type に応じて payload にデータを格納
5. タイムラインに反映
```

### 3.4 商品登録フロー（Phase 3）
```
1. ユーザーが活動ログで商品を検索
2. 商品が見つからない場合、新規作成
3. products テーブルに isVerified: false で保存
4. 運営が確認後、isVerified: true に更新
5. アフィリエイトリンクを付与
```

### 3.5 AI相談フロー（Phase 1後半 / Phase 2）
```
1. ユーザーがチャット画面で質問を入力
2. chat_threads テーブルにスレッドを作成（初回の場合）
3. chat_messages テーブルにユーザーメッセージを保存
4. chat アクションを呼び出し:
   a. ペットのカルテ情報を取得（pets, activities）
   b. 質問をベクトル化（OpenAI Embeddings API）
   c. 知識ベースをベクトル検索（Convex Vector Search）
   d. 関連知識を取得
   e. システムプロンプト + カルテ + 知識 + 質問をLLMに送信
   f. 回答を生成（引用元も含む）
5. chat_messages テーブルにAI回答を保存
6. UIに回答を表示（引用元、推奨アクションも表示）
7. 緊急度が高い場合、警告表示と病院マップを表示
```

### 3.6 コラム投稿フロー（Phase 1後半 / Phase 2）
```
1. 管理者または認定専門家がコラムを作成
2. タイトル、本文、対象種別、タグを入力
3. 一次ソースのリンクを追加
4. 下書きとして保存（status: "draft"）
5. プレビューで確認
6. 公開（status: "published"）
7. ホーム画面にレコメンド表示
```

### 3.7 コラムレコメンデーションフロー
```
1. ユーザーがホーム画面を開く
2. ユーザーが飼っているペットの種別を取得
3. articles テーブルから該当種別の公開記事を検索
4. 新しい順にソート
5. 「あなたにおすすめ」セクションに表示
```

### 3.8 SNSフィード表示フロー（Phase 3）

**フォロー中（Following）タブ**:
```
1. ユーザーが「フォロー中」タブを選択
2. follows テーブルから、現在のユーザーがフォローしている userId リストを取得
3. activities テーブルから、フォローしているユーザーの isPublic: true の投稿を取得
4. createdAt で新しい順にソート
5. タイムラインに表示
6. フォローしている人が新しい投稿をすると、リアルタイムで自動更新
```

**おすすめ（For You）タブ**:
```
1. ユーザーが「おすすめ」タブを選択
2. 以下の要素をミックス:
   a. 人気投稿: likes テーブルからいいね数が多い投稿を取得
   b. 関連性: ユーザーのペットと同じ種別の投稿を取得
   c. 波及効果: フォローしている人がいいねした投稿を取得
   d. **専門家が「いいね」した投稿を優先的に表示**（信頼性の指標）
3. スコアリングして優先順位を決定（専門家のいいねは高スコア）
4. タイムラインに表示
```

**AIパーソナライズ版（オプション）**:
```
1. ユーザーのペット情報（種別、品種、年齢など）をベクトル化
2. 投稿内容をベクトル化（embedding フィールドを使用）
3. Convex Vector Searchで類似度を計算
4. 類似度が高い投稿を優先的に表示
```

### 3.9 フォロー・いいねフロー（Phase 3）

**フォローフロー**:
```
1. ユーザーが他のユーザーのプロフィール画面で「フォロー」ボタンをタップ
2. follows テーブルに新規作成（followerId, followingId）
3. フォローされたユーザーに通知（将来拡張）
4. リアルタイムでフォロー状態が更新される
```

**いいねフロー**:
```
1. ユーザーが投稿の「いいね」ボタンをタップ
2. likes テーブルに新規作成（userId, activityId）
3. いいね数がリアルタイムで更新される
4. 再度タップでいいね解除（likes テーブルから削除）
5. **専門家（獣医師など）が「いいね」した場合**:
   - 投稿に「獣医師が推奨」などの特別なバッジが表示される
   - 専門家の「いいね」は通常の「いいね」とは区別される
   - おすすめフィードで優先的に表示される
```

---

## 4. 機能設計

### 4.1 Phase 1: 個人管理機能

#### 4.1.1 ユーザー管理
- ユーザー登録・ログイン（Clerk）
- プロフィール編集
- プレミアム会員登録

#### 4.1.2 ペット管理
- ペット登録
- ペット一覧表示
- ペットプロフィール編集
- ペット削除

#### 4.1.3 活動ログ
- 食事記録
- トイレ記録
- 散歩記録
- 日記投稿
- ケア記録
- タイムライン表示
- ログ編集・削除

#### 4.1.4 ダッシュボード
- 今日のサマリー
- 最近の活動ログ
- 統計情報（体重推移など）

#### 4.1.5 AI相談機能 ✅ **キラー機能**
- AIチャット（RAGベース）
- ペットのカルテ情報を活用した相談
- 信頼できる知識ベースからの回答生成
- 緊急度判定と病院案内
- 引用元の明示

---

### 4.4 AI相談機能（Phase 1後半 / Phase 2）✅ **キラー機能**

#### 4.4.1 システム構成

**目的**: 「信頼できるソースに基づいたAI相談」を実現し、単なる記録アプリから「ペットの命を守るパートナー」へと進化させる

**信頼性の担保方法**:
1. **ペットのカルテ（Context）**: `pets`テーブルと`activities`テーブルから、年齢・体重・既往歴や直近の食事・トイレ記録を読み込む
2. **信頼できる知識ベース（Knowledge Base）**: 獣医師監修のガイドラインや信頼できるQ&Aデータをベクトル化してConvexに保存
3. **専門家の検索（Triage）**: AIが「緊急性が高い」と判断した場合、近くの動物病院を案内

#### 4.4.2 RAG（Retrieval-Augmented Generation）アーキテクチャ

**処理フロー**:
```
1. ユーザーが質問を入力
2. ペットのカルテ情報を取得（pets, activities）
3. 質問をベクトル化して知識ベースを検索
4. 関連する知識を取得
5. カルテ情報 + 知識ベース + 質問をLLMに送信
6. 回答を生成（引用元も含む）
7. 回答をchat_messagesに保存
```

#### 4.4.3 機能詳細

**A. 「今の状態」に基づいた相談**
- 直近3日間のログを取得
- ペットのプロフィール（年齢、体重など）を確認
- 知識ベースから関連記事を検索
- 個別化された回答を生成

**B. 緊急度の判定と相談窓口への誘導**
- 知識ベースの「中毒物質リスト」と照合
- ペットの体重を考慮した危険度判定
- 緊急時は画面を警告色に変更
- 現在地周辺の救急対応可能な動物病院マップを表示（Google Maps API連携）

**C. 引用元の明示**
- 回答に使用した知識ベースの記事を引用
- `citedSources`フィールドに保存
- UIで引用元を表示

#### 4.4.4 技術実装

**使用技術**:
- **OpenAI Embeddings API**: テキストのベクトル化（`text-embedding-3-small`）
- **OpenAI ChatCompletion API**: 回答生成（GPT-4o推奨）
- **Convex Vector Search**: ベクトル検索
- **Convex Actions**: 外部API呼び出し

**実装ステップ**:
1. **知識データの投入（Ingestion）**
   - 信頼できるデータ（PDF、Webサイト）をテキスト化
   - OpenAI Embedding APIでベクトル化
   - `knowledge_base`テーブルに保存

2. **回答生成アクション（Generation）**
   - `chat`アクションを作成
   - 引数: `petId`, `message`
   - 処理フロー:
     1. `pets`と直近の`activities`を取得
     2. `message`をベクトル化して`knowledge_base`を検索
     3. システムプロンプトに含めてOpenAI ChatCompletion APIを呼ぶ
     4. 結果を`chat_messages`に保存して返す

3. **UIへの反映**
   - チャット画面を作成
   - 通常の吹き出し表示
   - 「推奨アクション」をリッチなカードとして表示
   - 引用元の表示

#### 4.4.5 法的・安全上の注意点

**重要**: AIによる医療相談機能を作る際、**「診断（Diagnosis）」をしてはいけない**という法律（獣医師法など）の壁があります。

**対策**:
- **免責事項**: アプリの初回起動時に「このAI機能は情報提供のみを目的としており、獣医師の診断に代わるものではありません」という同意を得る
- **システムプロンプトでの制御**: AIに対して「あなたは獣医師ではありません。診断を下さず、あくまで一般的なアドバイスと受診の目安を提示してください」と強く指示
- **緊急時の案内**: 緊急度が高い場合は、必ず動物病院への受診を推奨

#### 4.4.6 使用例

**例1: 食欲不振の相談**
```
ユーザー: 「最近食欲がないみたい」

AIの処理:
1. 直近3日間のログを取得 → 「食事量：通常の50%」「嘔吐：あり」
2. ペットプロフィールを確認 → 「14歳、高齢犬」
3. 知識ベースから「高齢犬 食欲不振 嘔吐」を検索
4. 回答生成

AIの回答:
「ポチくん（14歳）の記録を見ると、昨日から食事量が半分に減っており、
今朝一度嘔吐の記録がありますね。高齢なので脱水症状が心配です。
一般的なガイドラインでは、高齢犬の食欲不振が24時間続く場合は受診が推奨されます。
歯茎が乾いていないか確認し、かかりつけ医への相談をお勧めします。」

引用元:
- 「高齢犬の健康管理ガイド」（獣医師監修）
- 「嘔吐時の対応方法」
```

**例2: 緊急時の相談**
```
ユーザー: 「チョコレートを食べてしまったかも」

AIの処理:
1. 知識ベースの「中毒物質リスト」と照合 → 危険度：高
2. ペットの体重を取得 → 3kg（少量でも致死的）
3. 緊急判定フラグを立てる

AIの回答（UI表示を変更）:
[警告画面を表示]
「⚠️ 緊急事態です！今すぐ病院へ！」

チョコレートは犬にとって非常に危険な物質です。
ポチくん（3kg）の場合、少量でも致死的な可能性があります。
すぐに動物病院を受診してください。

[現在地周辺の救急対応可能な動物病院マップを表示]
```

---

### 4.2 Phase 2: 家族・チーム管理機能

#### 4.2.1 共同管理
- 共同管理者の追加
- 権限設定（admin/editor/viewer）
- 共同管理者一覧表示
- 共同管理者の削除

#### 4.2.2 共有機能
- 共有ペット一覧の表示
- 共有ペットへのアクセス制御

---

### 4.3 Phase 3: SNS・商品データベース機能

#### 4.3.1 SNS機能

**概要**: 2026年版のモダンなSNS機能。XやThreadsのような「フォロー中（Following）」と「おすすめ（For You）」のタブ切り替えを実装。

##### A. タイムラインの2つのロジック

**① フォロー中（Following）**
- **ロジック**: 自分がフォローしている`userId`のリストを取得し、その人たちが投稿した`isPublic: true`の記事を、日付が新しい順に表示
- **実装**: Convexのインデックス機能を使って、フォローしているID群に合致する投稿を高速にスキャン
- **特徴**: Convexのリアルタイム更新により、フォローしている人が新しい投稿をすると、自動的にタイムラインに反映される

**② おすすめ（For You）**
- **ロジック**: 以下の要素をミックスして表示
  - **人気投稿**: 全体の「いいね数」が多いもの
  - **関連性**: 自分の飼っているペットと同じ種別の投稿
  - **波及効果**: フォローしている人が「いいね」した投稿（ネットワークが広がる）
- **実装**: Convexの`searchIndex`や、定期的に集計する「人気スコア」を利用
- **特徴**: AI（RAG）を活用した超パーソナライズも可能（後述）

##### B. UI/UX実装（Expo / Tamagui）

**タブ切り替えUI**:
- 画面上部にSegmented Controlを配置
- 2つのタブ: 「おすすめ」と「フォロー中」
- タブ切り替え時に、Convexの`query`関数を動的に切り替え

**実装例**:
```typescript
// ステート管理
const [feedType, setFeedType] = useState<"recommended" | "following">("recommended");

// データ取得（動的切り替え）
const feed = useQuery(
  feedType === "following"
    ? api.activities.getFollowingFeed
    : api.activities.getRecommendedFeed,
  { userId: currentUserId }
);
```

**UXの特徴**:
- タブ切り替えが即座に反映される（Convexのリアルタイム更新）
- スクロール位置を保持（タブ切り替え後も元の位置に戻れる）
- 無限スクロール対応

##### C. AI（RAG）を活用した超パーソナライズ ✅ **2026年版の先進機能**

**概要**: 単なる「いいね数順」ではなく、**「あなたのペットに役立つ投稿」**を最優先で表示

**例**:
- あなたが「ハスキー」を飼っている場合
- 他のハスキー飼い主が投稿した「夏場の温度管理日記」や「おすすめの冷却マット（商品リンク付き）」を、フォローしていなくても「おすすめ」のトップに表示

**仕組み**:
1. あなたのペット情報（種別、品種、年齢など）をベクトル化
2. 投稿内容（テキスト、タグ、種別など）をベクトル化
3. Convex Vector Searchで類似度を計算
4. 類似度が高い投稿を優先的に表示

**実装**:
- Convex Vector Searchを使用
- 投稿に`embedding`フィールドを追加（オプション）
- ユーザーのペット情報と投稿の類似度を計算

##### D. パフォーマンス最適化

**初期段階**:
- 「フォローしている人の投稿」と「全体の人気投稿」を単純に分けるだけで十分
- Convexのインデックスを活用して高速に取得

**スケール時**:
- Convexの`Action`を使って、バックグラウンドで「おすすめリスト」を事前に計算（キャッシュ）
- 人気スコアを定期的に更新
- ベクトル検索結果をキャッシュ

##### E. 機能詳細

- **グローバルフィード（公開日記）**: すべての公開投稿を時系列で表示
- **いいね機能**: 投稿へのいいね・いいね解除
- **フォロー機能**: ユーザーのフォロー・フォロー解除
- **コメント機能**: 将来拡張予定

#### 4.3.2 商品データベース
- 商品検索
- 商品詳細表示
- 商品登録（ユーザー投稿）
- 商品承認（運営）

#### 4.3.3 レビュー機能
- レビュー投稿
- レビュー一覧表示
- 種別ごとの商品人気ランキング
- レビュー統計

---

### 4.5 コラム・記事機能（Phase 1後半 / Phase 2）✅ **信頼性向上・フック機能**

#### 4.5.1 概要

**目的**: 専門家による信頼できる一次ソースに特化したコラム・記事機能。アプリの信頼性を高め、ユーザーが毎日アプリを開く強力な動機（フック）を提供。

**特徴**:
- 管理者・認定専門家のみが投稿可能
- 一次ソースの明示による信頼性の担保
- ペット種別に合わせたレコメンデーション
- 情報の不確かなSNSとの差別化

#### 4.5.2 段階的な拡張プラン

**フェーズ1: 管理者（運営）による配信**
- 運営が信頼できるソースを元に記事を作成・公開
- Convex Dashboardまたはアプリ内の管理者用投稿ページから投稿
- ユーザーの飼っているペットの種類に合わせたコラムをホーム画面にレコメンド

**フェーズ2: 獣医師・専門家の登録と認証**
- 事業者ユーザーの中から、免許証などの確認が取れた人を「認定獣医師」フラグで管理
- 有料機能として、獣医師が「自分のクリニックの宣伝」としてコラムを書く権利をサブスクリプションで販売
- 一部有料コラムの仕組みを導入

#### 4.5.3 AIを活用したコンテンツ作成補助

**執筆サポートツール**:
- 信頼できる医学論文のURLを渡すと、その内容を要約し、初心者向けの分かりやすいコラムの下書きをMarkdownで生成
- 構成は「結論、理由、具体的な対策」に自動フォーマット
- 一次ソースの自動チェック（厚生労働省や獣医師会のガイドラインとの矛盾チェック）

**AIへの指示例**:
```
「信頼できる医学論文のURLを渡すので、その内容を要約し、
『初めて猫を飼う人向け』の分かりやすいコラムの下書きをMarkdownで生成して。
構成は『結論、理由、具体的な対策』にして。」
```

#### 4.5.4 住環境シミュレーター（発展アイデア）

**機能概要**:
- ペットの種別と、部屋の広さ・設備を入力すると、AIが改善点をアドバイスする診断機能

**使用例**:
- 「シベリアンハスキーを6畳の部屋で飼う場合」
- → 「運動量不足と温度管理のリスク」を指摘
- → 推奨されるエアコン設定や近隣のドッグランを提案

#### 4.5.5 機能詳細

**A. コラム一覧表示**
- 公開済みのコラムを一覧表示
- 種別でフィルタリング
- タグでフィルタリング
- 新しい順・人気順でソート

**B. コラム詳細表示**
- タイトル、本文、アイキャッチ画像
- 一次ソースのリンク表示
- 著者情報（専門家の場合）
- 関連コラムのレコメンデーション

**C. レコメンデーション**
- ユーザーが飼っているペットの種別に合わせたコラムをホーム画面に表示
- 「あなたにおすすめ」セクション

**D. 管理者用投稿機能**
- コラムの作成・編集・削除
- 下書き保存
- 公開・非公開の切り替え
- 一次ソースの追加

---

## 5. 画面設計（Phase 1）

### 5.1 認証画面
- ログイン画面
- サインアップ画面

### 5.2 ホーム画面
- ペット一覧
- 今日のサマリー
- クイックアクション（記録ボタン）
- **コラムレコメンドセクション** ✅ **フック機能**
  - 「あなたにおすすめ」コラム表示
  - 飼っているペットの種別に合わせたコラム
  - 新しいコラムの通知

### 5.3 ペット詳細画面
- プロフィール情報
- タイムライン
- 統計情報

### 5.4 記録画面
- 食事記録
- トイレ記録
- 散歩記録
- 日記投稿
- ケア記録

### 5.5 AI相談画面
- チャットスレッド一覧
- チャット画面
  - メッセージ履歴表示
  - 入力欄
  - 引用元表示
  - 推奨アクションカード
  - 緊急時の警告表示
  - 病院マップ表示（緊急時）

### 5.6 コラム画面
- コラム一覧画面
  - 種別フィルター
  - タグフィルター
  - ソート機能（新しい順・人気順）
- コラム詳細画面
  - タイトル、本文（Markdown表示）
  - アイキャッチ画像
  - 一次ソースリンク
  - 著者情報
  - 関連コラム
  - **コラムの末尾にAIへの質問ボタン**（例：熱中症のコラムの最後に「うちの子の今の体調を相談する」ボタン）✅ **キラー機能とフック機能の連動**
  - AI相談ボタンをタップすると、コラムの内容をコンテキストとして含めた状態でAI相談画面が開く
  - 記事の重要ポイントがハイライト表示される
  - 「後で読む」機能
- ホーム画面のレコメンドセクション
  - 「あなたにおすすめ」コラム表示

### 5.7 管理者用画面（運営）
- コラム投稿画面
  - タイトル、本文入力（Markdownエディタ）
  - 対象種別選択
  - タグ入力
  - 一次ソース追加
  - プレビュー機能
  - 下書き保存・公開
- AI執筆サポート画面
  - 論文URL入力
  - 対象読者指定
  - 下書き生成

### 5.9 SNSフィード画面（Phase 3）✅ **2026年版モダンSNS**
- フィード画面
  - 画面上部にSegmented Control（「おすすめ」「フォロー中」タブ）
  - 「おすすめ」タブ: 人気投稿、関連性の高い投稿、フォローしている人がいいねした投稿をミックス
  - 「フォロー中」タブ: フォローしているユーザーの公開投稿を時系列で表示
  - 無限スクロール対応
  - リアルタイム更新（Convex）
- 投稿カード
  - 投稿者情報（プロフィール画像、名前）
  - 投稿内容（テキスト、写真）
  - いいねボタン・いいね数
  - **専門家が「いいね」した投稿には「獣医師が推奨」バッジが表示される**
  - **信頼できる飼い主の証バッジ**（一定期間以上記録を続けているユーザー、専門家から「いいね」を受けたユーザー）
  - 投稿日時
  - ペット情報（種別、品種）

### 5.10 設定画面
- ユーザー設定
- ペット設定
- アプリ設定
- AI相談の免責事項同意

---

## 6. API設計（Convex Functions）

### 6.1 Users関連
- `storeUser`: ユーザー作成・更新
- `getCurrentUser`: 現在のユーザー取得
- `updateUser`: ユーザー情報更新

### 6.2 Pets関連
- `createPet`: ペット作成
- `getPetsByOwner`: 所有者のペット一覧取得
- `getPetById`: ペット詳細取得
- `updatePet`: ペット情報更新
- `deletePet`: ペット削除
- `searchPets`: ペット検索（種別・品種）

### 6.3 Activities関連
- `createActivity`: 活動ログ作成
- `getActivitiesByPet`: ペットの活動ログ取得
- `getTimeline`: タイムライン取得
- `updateActivity`: 活動ログ更新
- `deleteActivity`: 活動ログ削除

### 6.4 Pet Members関連（Phase 2）
- `addPetMember`: 共同管理者追加
- `getPetMembers`: 共同管理者一覧取得
- `updatePetMemberRole`: 権限更新
- `removePetMember`: 共同管理者削除
- `getPetsByMember`: 自分が管理できるペット一覧取得

### 6.5 Products関連（Phase 3）
- `createProduct`: 商品作成
- `searchProducts`: 商品検索
- `getProductById`: 商品詳細取得
- `verifyProduct`: 商品承認（運営）

### 6.6 Reviews関連（Phase 3）
- `createReview`: レビュー作成
- `getReviewsByProduct`: 商品のレビュー一覧取得
- `getPopularProductsBySpecies`: 種別ごとの人気商品取得

### 6.7 AI相談関連（Phase 1後半 / Phase 2）
- `createChatThread`: チャットスレッド作成
- `getChatThreads`: チャットスレッド一覧取得
- `getChatMessages`: メッセージ一覧取得
- `chat`: AI相談アクション（Action）
  - ペットのカルテ情報を取得
  - 質問をベクトル化して知識ベースを検索
  - OpenAI APIで回答生成
  - メッセージを保存
- `searchKnowledgeBase`: 知識ベース検索（内部用）
- `embedText`: テキストのベクトル化（内部用Action）

### 6.8 知識ベース管理（運営用）
- `createKnowledge`: 知識ベース作成
- `updateKnowledge`: 知識ベース更新
- `deleteKnowledge`: 知識ベース削除
- `ingestDocument`: ドキュメントの取り込み（PDF等からテキスト抽出→ベクトル化→保存）

### 6.9 コラム・記事関連（Phase 1後半 / Phase 2）
- `getArticles`: コラム一覧取得（公開済み）
- `getArticleById`: コラム詳細取得
- `getRecommendedArticles`: レコメンドコラム取得（種別ベース）
- `searchArticles`: コラム検索（全文検索）
- `createArticle`: コラム作成（管理者・専門家のみ）
- `updateArticle`: コラム更新（管理者・専門家のみ）
- `deleteArticle`: コラム削除（管理者・専門家のみ）
- `publishArticle`: コラム公開（管理者・専門家のみ）

### 6.10 AI執筆サポート（運営用）
- `generateArticleDraft`: AIでコラムの下書きを生成（Action）
  - 医学論文のURLを入力
  - 対象読者を指定（例：「初めて猫を飼う人向け」）
  - Markdown形式の下書きを生成
- `validateArticle`: 記事の信頼性チェック（Action）
  - 厚生労働省や獣医師会のガイドラインとの矛盾チェック

### 6.11 SNS機能関連（Phase 3）
- `getFollowingFeed`: フォロー中フィード取得
  - フォローしているユーザーの公開投稿を時系列で取得
  - リアルタイム更新対応
- `getRecommendedFeed`: おすすめフィード取得
  - 人気投稿、関連性、波及効果をミックスして取得
  - オプション: AIパーソナライズ（ベクトル検索）
- `followUser`: ユーザーをフォロー
- `unfollowUser`: ユーザーのフォロー解除
- `getFollowingList`: フォローしているユーザー一覧取得
- `getFollowersList`: フォロワー一覧取得
- `likeActivity`: 投稿にいいね
- `unlikeActivity`: いいね解除
- `getLikesByActivity`: 投稿のいいね一覧取得
- `checkLikeStatus`: ユーザーがいいねしたかどうか確認

---

## 7. セキュリティ設計

### 7.1 認証・認可
- Clerkによる認証
- Convexでの認証トークン検証
- ユーザーIDベースのアクセス制御

### 7.2 データアクセス制御
- `ownerId` による所有権チェック
- `pet_members` による共同管理権限チェック
- `visibility` による公開設定の尊重

### 7.3 入力検証
- スキーマレベルでの型チェック
- バリデーション関数の実装
- 不正データの防止

---

## 8. パフォーマンス最適化

### 8.1 インデックス戦略
- 頻繁に検索されるフィールドにインデックス
- 複合インデックスによる高速検索
- 全文検索インデックスの活用

### 8.2 キャッシュ戦略
- Convexの自動キャッシュ
- クライアント側のキャッシュ
- 統計データの非正規化

### 8.3 データ取得最適化
- 必要なフィールドのみ取得
- ページネーションの実装
- リアルタイム更新の最適化

---

## 9. 将来の拡張性

### 9.1 スケーラビリティ
- Convexの自動スケーリング
- データベースのパーティショニング検討
- CDNによる画像配信

### 9.2 機能拡張
- 通知機能の拡張
- チャット機能（将来）
- イベント機能（将来）
- マーケットプレイス機能（将来）

---

## 10. 技術的制約と考慮事項

### 10.1 Convexの制約
- ファイルサイズ制限
- クエリの複雑さ制限
- リアルタイム更新の制限

### 10.2 モバイルアプリの制約
- オフライン対応の検討
- 画像の最適化
- バッテリー消費の最適化

---

## 11. 用語集

- **Species（種別）**: ペットの大分類（犬、猫、爬虫類など）
- **Breed（品種）**: 種別内の細分類（ハスキー、レオパなど）
- **Activity（活動ログ）**: ペットの日常活動の記録
- **Payload（ペイロード）**: 活動ログの実際のデータ部分
- **Visibility（公開設定）**: データの公開範囲（private/shared/public）
- **Pet Member（共同管理者）**: ペットを共同で管理するユーザー
